<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üêç Python Adventure ‚Äî ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô Python ‡∏™‡∏ô‡∏∏‡∏Å‡πÜ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700;900&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
<script src="https://kit.fontawesome.com/866325b683.js" crossorigin="anonymous"></script>
<style>
  /* ‚îÄ‚îÄ DARK THEME (default) ‚îÄ‚îÄ */
  :root {
    --bg:#0d0f1a; --surface:#141626; --surface2:#1c1f35; --surface3:#252849;
    --accent:#7c5cfc; --accent2:#fc5c9c; --accent3:#5cdbfc; --accent4:#fcdc5c;
    --green:#5cfc9c; --red:#fc5c5c; --text:#e8eaff; --text2:#9497b8;
    --border:rgba(124,92,252,0.25); --glow:0 0 30px rgba(124,92,252,0.3);
    --editor-bg:#0d0f1a;
  }
  /* ‚îÄ‚îÄ LIGHT THEME ‚îÄ‚îÄ */
  [data-theme="light"] {
    --bg:#f4f5fb; --surface:#ffffff; --surface2:#eef0fa; --surface3:#e2e5f5;
    --accent:#6a3ff5; --accent2:#e03d8a; --accent3:#0891b2; --accent4:#b45309;
    --green:#16a34a; --red:#dc2626; --text:#1a1d3a; --text2:#5b5f80;
    --border:rgba(100,80,220,0.18); --glow:0 0 20px rgba(100,80,220,0.15);
    --editor-bg:#f8f9ff;
  }
  [data-theme="light"] body::before{opacity:0.25}
  [data-theme="light"] header{border-bottom:1px solid rgba(0,0,0,0.07)}
  [data-theme="light"] .nav-sep{background:rgba(0,0,0,0.1)}
  [data-theme="light"] .pane-header{background:var(--surface2)}
  [data-theme="light"] .output-pane{background:var(--surface)}
  [data-theme="light"] .sidebar{border-right:1px solid rgba(0,0,0,0.08)}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Prompt',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
  body::before{content:'';position:fixed;inset:0;background-image:
    radial-gradient(1px 1px at 20% 30%,rgba(255,255,255,0.4) 0%,transparent 100%),
    radial-gradient(1px 1px at 80% 10%,rgba(255,255,255,0.3) 0%,transparent 100%),
    radial-gradient(1.5px 1.5px at 55% 70%,rgba(255,255,255,0.35) 0%,transparent 100%),
    radial-gradient(2px 2px at 35% 15%,rgba(124,92,252,0.6) 0%,transparent 100%),
    radial-gradient(2px 2px at 70% 85%,rgba(92,219,252,0.5) 0%,transparent 100%);
    pointer-events:none;z-index:0}
  header{
    position:relative;z-index:10;
    height:52px;padding:0 24px;
    display:flex;align-items:center;gap:12px;
    background:var(--surface);
    border-bottom:1px solid rgba(255,255,255,0.06);
  }
  .logo{font-size:1.3rem;animation:snake 3s ease-in-out infinite;line-height:1}
  @keyframes snake{0%,100%{transform:rotate(-8deg)}50%{transform:rotate(8deg)}}
  .brand{display:flex;align-items:center;gap:8px}
  .brand-name{font-size:0.95rem;font-weight:700;color:var(--text);letter-spacing:-0.2px}
  .brand-sep{width:1px;height:16px;background:rgba(255,255,255,0.1)}
  /* Python status pill */
  .py-status{display:flex;align-items:center;gap:5px;font-size:0.72rem;color:var(--text2)}
  .status-dot{width:6px;height:6px;border-radius:50%;background:var(--accent4);animation:pulse 1.5s infinite;flex-shrink:0}
  .status-dot.ready{background:var(--green);animation:none}
  .status-dot.error{background:var(--red);animation:none}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
  /* Score */
  .score-pill{margin-left:auto;display:flex;align-items:center;gap:6px;
    font-size:0.78rem;font-weight:600;color:var(--text2)}
  .score-pill strong{color:var(--text);font-size:0.9rem}
  /* Divider */
  .nav-sep{width:1px;height:18px;background:rgba(255,255,255,0.08)}
  /* Nav icon buttons */
  .nav-icon-btn{
    display:flex;align-items:center;gap:6px;
    padding:5px 10px;border-radius:7px;border:none;
    background:transparent;color:var(--text2);
    font-family:'Prompt',sans-serif;font-size:0.75rem;font-weight:600;
    cursor:pointer;transition:background 0.15s,color 0.15s;
    white-space:nowrap;
  }
  .nav-icon-btn:hover{background:var(--surface2);color:var(--text)}
  .nav-icon-btn.green:hover{color:var(--green)}
  .nav-icon-btn.yellow:hover{color:var(--accent4)}
  .nav-icon-btn.cyan:hover{color:var(--accent3)}
  .nav-icon-btn.purple:hover{color:var(--accent)}
  .nav-icon-btn:disabled{opacity:0.4;cursor:not-allowed}
  /* Toast system */
  #toast-container{
    position:fixed;bottom:24px;right:24px;
    z-index:9000;display:flex;flex-direction:column;
    gap:8px;align-items:flex-end;pointer-events:none;
  }
  .toast{
    display:flex;align-items:center;gap:10px;
    padding:10px 16px;border-radius:10px;
    font-size:0.8rem;font-weight:600;
    background:var(--surface2);border:1px solid rgba(255,255,255,0.08);
    box-shadow:0 8px 32px rgba(0,0,0,0.4);
    pointer-events:auto;
    transform:translateX(120%);opacity:0;
    transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1),opacity 0.3s ease;
    max-width:340px;
  }
  .toast.show{transform:translateX(0);opacity:1}
  .toast.hide{transform:translateX(120%);opacity:0;transition:transform 0.25s ease,opacity 0.25s ease}
  .toast-ok{color:var(--green);border-left:3px solid var(--green)}
  .toast-err{color:var(--red);border-left:3px solid var(--red)}
  .toast-info{color:var(--accent3);border-left:3px solid var(--accent3)}
  .toast-icon{font-size:1rem;flex-shrink:0}
  .toast-msg{flex:1;line-height:1.4}
  .toast-close{background:none;border:none;color:var(--text2);cursor:pointer;
    font-size:0.9rem;padding:0 0 0 4px;opacity:0.5;transition:opacity 0.15s}
  .toast-close:hover{opacity:1}
  /* JSON loader bar ‚Äî removed, merged into header */
  .json-loader-bar{display:none}
  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar{background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;padding:8px 0 16px}
  .sidebar::-webkit-scrollbar{width:3px}
  .sidebar::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px}

  /* Collapsible chapter header */
  .chapter-group{width:100%}
  .chapter-toggle{
    width:100%;padding:8px 14px;
    background:transparent;border:none;cursor:pointer;
    display:flex;align-items:center;gap:8px;
    font-family:'Prompt',sans-serif;font-size:0.68rem;font-weight:700;
    text-transform:uppercase;letter-spacing:1.5px;color:var(--text2);
    transition:color 0.15s;
    position:sticky;top:0;z-index:2;
    background:var(--surface);
  }
  .chapter-toggle:hover{color:var(--text)}
  .chapter-toggle-line{flex:1;height:1px;background:var(--border)}
  .chapter-caret{
    font-size:0.6rem;opacity:0.5;transition:transform 0.2s ease;flex-shrink:0;
  }
  .chapter-group.collapsed .chapter-caret{transform:rotate(-90deg)}
  .chapter-items{overflow:hidden;transition:max-height 0.25s ease,opacity 0.2s ease;max-height:2000px;opacity:1}
  .chapter-group.collapsed .chapter-items{max-height:0;opacity:0}

  /* Sidebar bottom ‚Äî Playground button */
  .sidebar-footer{
    padding:10px 12px 4px;
    border-top:1px solid var(--border);
    margin-top:8px;
  }
  .playground-btn{
    width:100%;padding:9px 14px;
    background:rgba(92,219,252,0.08);border:1px solid rgba(92,219,252,0.2);
    border-radius:8px;cursor:pointer;
    display:flex;align-items:center;gap:8px;
    font-family:'Prompt',sans-serif;font-size:0.82rem;font-weight:600;
    color:var(--accent3);transition:all 0.15s;
  }
  .playground-btn:hover{background:rgba(92,219,252,0.18);border-color:rgba(92,219,252,0.4)}
  .playground-btn.active{background:rgba(92,219,252,0.18);border-color:var(--accent3)}

  .exercise-btn{width:100%;padding:9px 14px 9px 16px;background:transparent;border:none;cursor:pointer;
    text-align:left;color:var(--text2);font-family:'Prompt',sans-serif;font-size:0.82rem;
    display:flex;align-items:center;gap:10px;transition:all 0.15s;border-left:3px solid transparent}
  .exercise-btn:hover{background:var(--surface2);color:var(--text);border-left-color:var(--accent)}
  .exercise-btn.active{background:linear-gradient(90deg,rgba(124,92,252,0.15) 0%,transparent 100%);
    color:var(--text);border-left-color:var(--accent)}
  .exercise-btn.completed .ex-num{background:var(--green)!important;color:#0d0f1a!important}
  .ex-num{width:24px;height:24px;border-radius:6px;background:var(--surface3);display:flex;
    align-items:center;justify-content:center;font-size:0.7rem;font-weight:700;flex-shrink:0;transition:all 0.15s}
  .exercise-btn.active .ex-num{background:var(--accent);color:white}
  .ex-check{margin-left:auto;font-size:0.8rem;opacity:0;transition:opacity 0.15s}
  .exercise-btn.completed .ex-check{opacity:1}
  .app{display:grid;grid-template-columns:280px 1fr;height:calc(100vh - 55px);position:relative;z-index:1}

  /* ‚îÄ‚îÄ MAIN TABS ‚îÄ‚îÄ */
  .main{display:flex;flex-direction:column;overflow:hidden}
  .main-tabs{display:flex;align-items:center;gap:2px;padding:6px 8px;
    background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0}
  .main-tab{
    padding:5px 14px;border-radius:6px;border:none;cursor:pointer;
    font-family:'Prompt',sans-serif;font-size:0.8rem;font-weight:600;
    color:var(--text2);background:transparent;transition:all 0.15s;
  }
  .main-tab:hover{background:var(--surface2);color:var(--text)}
  .main-tab.active{background:var(--surface2);color:var(--text)}
  .main-tab.active.tab-exercises{color:var(--accent);box-shadow:inset 0 -2px 0 var(--accent)}
  .main-tab.active.tab-playground{color:var(--accent3);box-shadow:inset 0 -2px 0 var(--accent3)}
  /* View panels */
  .view-panel{display:none;flex-direction:column;overflow:hidden;flex:1;min-height:0}
  .view-panel.active{display:flex}

  /* ‚îÄ‚îÄ PLAYGROUND ‚îÄ‚îÄ */
  .playground-wrap{
    display:grid;grid-template-rows:1fr auto;height:100%;overflow:hidden;
  }
  .pg-editor-area{
    display:grid;grid-template-columns:1fr 1fr;overflow:hidden;
  }
  /* REPL terminal */
  .repl-pane{
    display:flex;flex-direction:column;overflow:hidden;
    background:var(--bg);border-left:1px solid var(--border);
  }
  .repl-output{
    flex:1;padding:12px 14px;
    font-family:'Fira Code',monospace;font-size:0.8rem;line-height:1.65;
    overflow-y:auto;color:var(--text);
  }
  .repl-output::-webkit-scrollbar{width:3px}
  .repl-output::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:2px}
  .repl-line{white-space:pre-wrap;word-break:break-all;margin-bottom:1px}
  .repl-prompt{color:var(--accent3)}
  .repl-out{color:var(--text)}
  .repl-err{color:var(--red)}
  .repl-sys{color:var(--text2);font-style:italic}
  /* REPL input row */
  .repl-input-row{
    display:flex;align-items:center;gap:0;
    border-top:1px solid var(--border);
    background:var(--surface2);flex-shrink:0;
  }
  .repl-prompt-label{
    padding:8px 10px;font-family:'Fira Code',monospace;
    font-size:0.8rem;color:var(--accent3);flex-shrink:0;
    border-right:1px solid var(--border);
  }
  .repl-input{
    flex:1;padding:8px 12px;background:transparent;border:none;outline:none;
    font-family:'Fira Code',monospace;font-size:0.8rem;color:var(--text);
  }
  .repl-run-btn{
    padding:7px 14px;background:transparent;border:none;border-left:1px solid var(--border);
    color:var(--accent3);font-family:'Prompt',sans-serif;font-size:0.75rem;font-weight:700;
    cursor:pointer;transition:background 0.15s;flex-shrink:0;white-space:nowrap;
  }
  .repl-run-btn:hover{background:rgba(92,219,252,0.1)}
  /* Playground action bar */
  .pg-action-bar{
    padding:8px 20px;display:flex;align-items:center;gap:10px;
    background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;
  }
  .problem-panel{padding:16px 24px;background:var(--surface);border-bottom:1px solid var(--border);
    overflow-y:auto;flex-shrink:0;min-height:60px;max-height:60vh;
  }
  .problem-panel::-webkit-scrollbar{width:4px}
  .problem-panel::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px}
  /* Resize handle between problem panel and editor */
  .panel-resizer{
    height:6px;background:var(--border);cursor:ns-resize;flex-shrink:0;
    display:flex;align-items:center;justify-content:center;
    transition:background 0.15s;
  }
  .panel-resizer:hover,.panel-resizer.dragging{background:var(--accent)}
  .panel-resizer::after{content:'';width:32px;height:2px;border-radius:1px;background:var(--text2);opacity:0.4}
  .problem-header{display:flex;align-items:flex-start;gap:12px;margin-bottom:10px}
  .problem-badge{padding:3px 10px;border-radius:20px;font-size:0.68rem;font-weight:700;
    text-transform:uppercase;letter-spacing:1px;flex-shrink:0;margin-top:2px}
  .badge-print{background:rgba(92,219,252,0.2);color:var(--accent3);border:1px solid rgba(92,219,252,0.3)}
  .badge-var{background:rgba(252,220,92,0.2);color:var(--accent4);border:1px solid rgba(252,220,92,0.3)}
  .badge-input{background:rgba(92,252,156,0.2);color:var(--green);border:1px solid rgba(92,252,156,0.3)}
  .badge-condition{background:rgba(252,92,156,0.2);color:var(--accent2);border:1px solid rgba(252,92,156,0.3)}
  .badge-loop{background:rgba(252,180,92,0.2);color:#fcb45c;border:1px solid rgba(252,180,92,0.3)}
  /* badge styles */
  /* Progress modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;
    display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
  .modal-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;
    padding:28px 32px;min-width:320px;max-width:420px;box-shadow:var(--glow)}
  .modal-title{font-size:1.1rem;font-weight:700;margin-bottom:6px}
  .modal-sub{font-size:0.82rem;color:var(--text2);margin-bottom:20px;line-height:1.5}
  .modal-field{margin-bottom:14px}
  .modal-field label{display:block;font-size:0.78rem;color:var(--text2);margin-bottom:5px}
  .modal-field input{width:100%;background:var(--surface2);border:1px solid var(--border);
    border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Prompt',sans-serif;
    font-size:0.88rem;outline:none}
  .modal-field input:focus{border-color:var(--accent)}
  .modal-actions{display:flex;gap:9px;justify-content:flex-end;margin-top:20px}
  .modal-btn{padding:8px 18px;border-radius:8px;border:none;cursor:pointer;
    font-family:'Prompt',sans-serif;font-size:0.84rem;font-weight:700;transition:all 0.2s}
  .modal-btn-primary{background:linear-gradient(135deg,var(--green),#3cdc7c);color:#0d0f1a}
  .modal-btn-primary:hover{transform:translateY(-1px)}
  .modal-btn-cancel{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
  .modal-btn-cancel:hover{background:var(--surface3)}
  .problem-title{font-size:1rem;font-weight:700;color:var(--text);line-height:1.4}
  .problem-desc{font-size:0.84rem;color:var(--text2);line-height:1.6}
  .problem-desc code{background:var(--surface3);padding:1px 5px;border-radius:4px;
    font-family:'Fira Code',monospace;font-size:0.8rem;color:var(--accent3)}
  .hint-box{margin-top:10px;padding:9px 12px;background:rgba(124,92,252,0.08);
    border:1px solid rgba(124,92,252,0.2);border-radius:9px;font-size:0.8rem;
    color:var(--accent);display:flex;gap:7px;align-items:flex-start}
  .hint-toggle{background:none;border:1px solid rgba(124,92,252,0.3);color:var(--accent);
    font-family:'Prompt',sans-serif;font-size:0.72rem;padding:3px 9px;border-radius:5px;
    cursor:pointer;margin-top:7px;transition:all 0.2s}
  .hint-toggle:hover{background:rgba(124,92,252,0.15)}
  .editor-area{display:grid;grid-template-columns:1fr 1fr;overflow:hidden;flex:1;min-height:0}
  .editor-pane{display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:hidden}
  .pane-header{padding:8px 14px;background:var(--surface2);border-bottom:1px solid var(--border);
    font-size:0.75rem;font-weight:600;color:var(--text2);display:flex;align-items:center;gap:7px;flex-shrink:0}
  .pane-dot{width:7px;height:7px;border-radius:50%}
  #editor-container{flex:1;overflow:hidden}
  .output-pane{display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
  .output-content{flex:1;padding:14px;font-family:'Fira Code',monospace;font-size:0.8rem;
    line-height:1.7;overflow-y:auto;color:var(--text)}
  .output-content::-webkit-scrollbar{width:3px}
  .output-content::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:2px}
  .out-line{margin-bottom:1px;white-space:pre-wrap;word-break:break-all}
  .out-err{color:var(--red)}
  .out-sys{color:var(--text2);font-style:italic}
  .out-inp{color:var(--accent3)}
  .input-line-container{display:none;align-items:center;gap:7px;padding:7px 14px;
    background:rgba(124,92,252,0.1);border-top:1px solid rgba(124,92,252,0.2);
    font-family:'Fira Code',monospace;font-size:0.8rem}
  .input-line-container.active{display:flex}
  .input-line-container span{color:var(--accent3);flex-shrink:0}
  .input-line-container input{flex:1;background:transparent;border:none;outline:none;
    color:var(--text);font-family:'Fira Code',monospace;font-size:0.8rem}
  .result-panel{padding:0;background:var(--surface);border-top:1px solid var(--border);
    overflow-y:auto;max-height:0;transition:max-height 0.4s ease}
  .result-panel.show{max-height:200px}
  .result-inner{padding:12px 24px}
  .result-correct{display:flex;align-items:center;gap:14px;padding:12px 18px;
    background:rgba(92,252,156,0.08);border:1px solid rgba(92,252,156,0.25);border-radius:10px}
  .result-wrong{display:flex;align-items:center;gap:14px;padding:12px 18px;
    background:rgba(252,92,92,0.08);border:1px solid rgba(252,92,92,0.25);border-radius:10px}
  .result-icon{font-size:1.6rem}
  .result-msg{font-weight:700;font-size:0.95rem}
  .result-sub{font-size:0.78rem;color:var(--text2);margin-top:2px;font-family:'Fira Code',monospace}
  .action-bar{padding:10px 24px;display:flex;align-items:center;gap:10px;
    background:var(--surface);border-top:1px solid var(--border);flex-shrink:0}
  .btn{padding:9px 20px;border-radius:9px;border:none;font-family:'Prompt',sans-serif;
    font-size:0.85rem;font-weight:700;cursor:pointer;transition:all 0.2s;
    display:flex;align-items:center;gap:7px}
  .btn-run{background:linear-gradient(135deg,var(--accent),#5c3cdc);color:white;
    box-shadow:0 4px 18px rgba(124,92,252,0.4)}
  .btn-run:hover{transform:translateY(-1px);box-shadow:0 6px 26px rgba(124,92,252,0.6)}
  .btn-run:disabled{opacity:0.5;cursor:not-allowed;transform:none}
  .btn-check{background:linear-gradient(135deg,var(--accent2),#dc3c7c);color:white;
    box-shadow:0 4px 18px rgba(252,92,156,0.4)}
  .btn-check:hover{transform:translateY(-1px)}
  .btn-check:disabled{opacity:0.5;cursor:not-allowed;transform:none}
  .btn-clear{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
  .btn-clear:hover{background:var(--surface3);color:var(--text)}
  .btn-next{background:linear-gradient(135deg,var(--green),#3cdc7c);color:#0d0f1a;margin-left:auto}
  .btn-next:hover{transform:translateY(-1px)}
  .progress-bar{height:3px;background:var(--surface2);overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent3));transition:width 0.5s ease}
  .star-burst{position:fixed;pointer-events:none;z-index:9999;font-size:2rem;animation:burst 1s ease forwards}
  @keyframes burst{0%{transform:scale(0) translateY(0);opacity:1}100%{transform:scale(1.5) translateY(-80px);opacity:0}}
  .loading-overlay{position:fixed;inset:0;background:rgba(13,15,26,0.97);display:flex;
    flex-direction:column;align-items:center;justify-content:center;z-index:1000;gap:18px}
  .loading-snake{font-size:4.5rem;animation:loadSnake 0.8s ease-in-out infinite}
  @keyframes loadSnake{0%,100%{transform:rotate(-15deg) scale(1)}50%{transform:rotate(15deg) scale(1.1)}}
  .loading-title{font-size:1.7rem;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent3));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .loading-bar{width:280px;height:5px;background:var(--surface2);border-radius:3px;overflow:hidden}
  .loading-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent3));border-radius:3px;transition:width 0.3s ease}
  .loading-text{font-size:0.82rem;color:var(--text2)}
  @media(max-width:900px){.app{grid-template-columns:1fr}.sidebar{display:none}.editor-area{grid-template-columns:1fr;grid-template-rows:1fr 1fr}}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-snake">üêç</div>
  <div class="loading-title">Python Adventure</div>
  <div class="loading-bar"><div class="loading-fill" id="loadingFill" style="width:0%"></div></div>
  <div class="loading-text" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Pyodide...</div>
</div>

<header>
  <!-- Brand -->
  <div class="brand">
    <span class="logo">üêç</span>
    <span class="brand-name">Python Adventure</span>
  </div>

  <div class="nav-sep"></div>

  <!-- Python status -->
  <div class="py-status">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î</span>
  </div>

  <!-- Score -->
  <div class="score-pill">
    <span>‚≠ê</span>
    <strong id="scoreDisplay">0</strong>
    <span style="color:var(--border)">/</span>
    <span id="totalDisplay">20</span>
  </div>

  <div class="nav-sep"></div>

  <!-- Exercises section -->
  <button class="nav-icon-btn cyan" onclick="loadDefaultJson()" id="reloadJsonBtn" title="‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏à‡∏≤‡∏Å GitHub">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.12"/></svg>
    ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå
  </button>
  <button class="nav-icon-btn purple" onclick="document.getElementById('jsonFileInput').click()" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .json">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå
  </button>
  <input type="file" id="jsonFileInput" accept=".json" onchange="loadFromFile(event)" style="display:none"/>

  <div class="nav-sep"></div>

  <!-- Progress section -->
  <button class="nav-icon-btn green" onclick="saveProgress()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å progress">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  </button>
  <button class="nav-icon-btn yellow" onclick="document.getElementById('progressFileInput').click()" title="‡πÇ‡∏´‡∏•‡∏î progress">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    ‡πÇ‡∏´‡∏•‡∏î Progress
  </button>
  <input type="file" id="progressFileInput" accept=".mxr" onchange="loadProgress(event)" style="display:none"/>

  <div class="nav-sep"></div>

  <!-- Theme toggle -->
  <button class="nav-icon-btn" id="themeBtn" onclick="toggleTheme()" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô theme">
    <svg id="themeIcon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
      <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    </svg>
    <span id="themeTxt">Light</span>
  </button>
</header>

<!-- Toast container -->
<div id="toast-container"></div>

<div class="progress-bar">
  <div class="progress-fill" id="progressFill" style="width:0%"></div>
</div>


<div class="app">
  <aside class="sidebar" id="sidebar"></aside>
  <div class="main">
    <div class="problem-panel">
      <div class="problem-header">
        <div class="problem-badge" id="problemBadge"></div>
        <div>
          <div class="problem-title" id="problemTitle"></div>
          <div class="problem-desc" id="problemDesc"></div>
        </div>
      </div>
      <button class="hint-toggle" id="hintToggle" onclick="toggleHint()">üí° ‡πÅ‡∏™‡∏î‡∏á hint</button>
      <div class="hint-box" id="hintBox" style="display:none">
        <span>üí°</span><span id="hintText"></span>
      </div>
    </div>

    <div class="panel-resizer" id="panelResizer"></div>

    <div class="editor-area">
      <div class="editor-pane">
        <div class="pane-header">
          <div class="pane-dot" style="background:#fc5c5c"></div>
          <div class="pane-dot" style="background:#fcdc5c"></div>
          <div class="pane-dot" style="background:#5cfc9c"></div>
          <span style="margin-left:4px">main.py</span>
        </div>
        <div id="editor-container"></div>
      </div>
      <div class="output-pane">
        <div class="pane-header">
          <div class="pane-dot" style="background:var(--accent3)"></div>
          <span>Output</span>
          <span id="runSpinner" style="margin-left:auto;display:none">‚è≥</span>
        </div>
        <div class="output-content" id="outputContent">
          <div class="out-line out-sys">// ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà üéØ</div>
        </div>
        <div class="input-line-container" id="inputContainer">
          <span>‚ñ∂</span>
          <input type="text" id="inputField" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤ input ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter..." autocomplete="off"/>
        </div>
      </div>
    </div>

    <div class="result-panel" id="resultPanel">
      <div class="result-inner" id="resultInner"></div>
    </div>

    <div class="action-bar">
      <button class="btn btn-run" id="runBtn" onclick="runCode()" disabled>‚ñ∂ ‡∏£‡∏±‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</button>
      <button class="btn btn-check" id="checkBtn" onclick="checkAnswer()" disabled>‚úì ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
      <button class="btn btn-clear" onclick="clearOutput()">üóë ‡∏•‡πâ‡∏≤‡∏á</button>
      <button class="btn btn-next" id="nextBtn" onclick="nextExercise()" style="display:none">‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
    </div>
  </div>
</div>

<!-- SAVE MODAL -->
<div class="modal-overlay" id="saveModal" style="display:none" onclick="if(event.target===this)closeSaveModal()">
  <div class="modal-box">
    <div class="modal-title">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Progress</div>
    <div class="modal-sub">‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô <b>.mxr</b><br>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</div>
    <div class="modal-field">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÉ‡∏™‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ)</label>
      <input type="text" id="saveNameInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏µ" maxlength="40" />
    </div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-cancel" onclick="closeSaveModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="modal-btn modal-btn-primary" onclick="confirmSave()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ EXERCISES (‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å JSON) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let exercises = [];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentIdx = 0;
const completed = new Set();
let score = 0;
let monacoEditor = null;
let pyodideReady = false;
let pyodide = null;
// For manual input (when no auto-queue)
let inputQueue = [];
let inputCallback = null;

// ‚îÄ‚îÄ PYODIDE LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadPyodideEngine() {
  try {
    setLoading(10, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Pyodide...");
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js';
    document.head.appendChild(s);
    await new Promise((ok, err) => { s.onload = ok; s.onerror = err; });

    setLoading(45, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Python runtime...");
    pyodide = await window.loadPyodide({
      indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/'
    });

    setLoading(80, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Monaco Editor...");
    await loadMonaco();

    setLoading(100, "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! üéâ");
    pyodideReady = true;
    document.getElementById('statusDot').className = 'status-dot ready';
    document.getElementById('statusText').textContent = 'Python ‡∏û‡∏£‡πâ‡∏≠‡∏°';
    document.getElementById('runBtn').disabled = false;
    document.getElementById('checkBtn').disabled = false;

    setTimeout(() => {
      const ov = document.getElementById('loadingOverlay');
      ov.style.transition = 'opacity 0.5s';
      ov.style.opacity = '0';
      setTimeout(() => ov.style.display = 'none', 500);
    }, 300);
  } catch(e) {
    document.getElementById('statusDot').className = 'status-dot error';
    document.getElementById('statusText').textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
    document.getElementById('loadingText').textContent = 'Error: ' + e.message;
  }
}

function setLoading(pct, txt) {
  document.getElementById('loadingFill').style.width = pct + '%';
  document.getElementById('loadingText').textContent = txt;
}

function loadMonaco() {
  return new Promise(resolve => {
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
    require(['vs/editor/editor.main'], () => {

      // ‚îÄ‚îÄ Dark theme ‚îÄ‚îÄ
      monaco.editor.defineTheme('pyAdventure', {
        base:'vs-dark', inherit:true,
        rules:[
          {token:'comment',foreground:'6272a4',fontStyle:'italic'},
          {token:'keyword',foreground:'ff79c6',fontStyle:'bold'},
          {token:'string',foreground:'f1fa8c'},
          {token:'number',foreground:'bd93f9'},
          {token:'type',foreground:'8be9fd'},
          {token:'function',foreground:'50fa7b'},
          {token:'variable',foreground:'f8f8f2'},
        ],
        colors:{
          'editor.background':'#0d0f1a',
          'editor.foreground':'#e8eaff',
          'editorLineNumber.foreground':'#3d4070',
          'editorLineNumber.activeForeground':'#7c5cfc',
          'editor.selectionBackground':'#44475a80',
          'editor.lineHighlightBackground':'#1c1f3540',
          'editorCursor.foreground':'#7c5cfc',
          'editorSuggestWidget.background':'#1c1f35',
          'editorSuggestWidget.border':'#7c5cfc40',
          'editorSuggestWidget.selectedBackground':'#7c5cfc30',
          'editorHoverWidget.background':'#1c1f35',
          'editorHoverWidget.border':'#7c5cfc40',
        }
      });

      // ‚îÄ‚îÄ Light theme ‚îÄ‚îÄ
      monaco.editor.defineTheme('pyAdventureLight', {
        base:'vs', inherit:true,
        rules:[
          {token:'comment',foreground:'6272a4',fontStyle:'italic'},
          {token:'keyword',foreground:'8b2fc9',fontStyle:'bold'},
          {token:'string',foreground:'b45309'},
          {token:'number',foreground:'6a3ff5'},
          {token:'type',foreground:'0891b2'},
          {token:'function',foreground:'16a34a'},
          {token:'variable',foreground:'1a1d3a'},
        ],
        colors:{
          'editor.background':'#f8f9ff',
          'editor.foreground':'#1a1d3a',
          'editorLineNumber.foreground':'#a0a4c8',
          'editorLineNumber.activeForeground':'#6a3ff5',
          'editor.selectionBackground':'#c4b5fd50',
          'editor.lineHighlightBackground':'#eef0fa',
          'editorCursor.foreground':'#6a3ff5',
          'editorSuggestWidget.background':'#ffffff',
          'editorSuggestWidget.border':'#6a3ff520',
          'editorSuggestWidget.selectedBackground':'#eef0fa',
          'editorHoverWidget.background':'#ffffff',
          'editorHoverWidget.border':'#6a3ff520',
        }
      });

      // ‚îÄ‚îÄ Python IntelliSense ‚îÄ‚îÄ
      const BUILTINS = [
        // functions
        {label:'print',kind:1,doc:'print(*objects, sep=\" \", end=\"\\n\", file=sys.stdout)\n\n‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏≠‡∏≠‡∏Å‡∏ó‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠',insert:'print(${1:})'},
        {label:'input',kind:1,doc:'input(prompt=\"\")\n\n‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å keyboard ‡πÄ‡∏õ‡πá‡∏ô string',insert:'input(${1:})'},
        {label:'int',kind:1,doc:'int(x)\n\n‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°',insert:'int(${1:})'},
        {label:'float',kind:1,doc:'float(x)\n\n‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°',insert:'float(${1:})'},
        {label:'str',kind:1,doc:'str(object)\n\n‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°',insert:'str(${1:})'},
        {label:'bool',kind:1,doc:'bool(x)\n\n‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô True/False',insert:'bool(${1:})'},
        {label:'len',kind:1,doc:'len(s)\n\n‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô elements',insert:'len(${1:})'},
        {label:'range',kind:1,doc:'range(stop) | range(start, stop[, step])\n\n‡∏™‡∏£‡πâ‡∏≤‡∏á sequence ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç',insert:'range(${1:})'},
        {label:'abs',kind:1,doc:'abs(x)\n\n‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á x',insert:'abs(${1:})'},
        {label:'round',kind:1,doc:'round(number, ndigits=None)\n\n‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°',insert:'round(${1:})'},
        {label:'max',kind:1,doc:'max(iterable) | max(a, b, ...)\n\n‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î',insert:'max(${1:})'},
        {label:'min',kind:1,doc:'min(iterable) | min(a, b, ...)\n\n‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î',insert:'min(${1:})'},
        {label:'sum',kind:1,doc:'sum(iterable)\n\n‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',insert:'sum(${1:})'},
        {label:'type',kind:1,doc:'type(object)\n\n‡∏î‡∏π type ‡∏Ç‡∏≠‡∏á object',insert:'type(${1:})'},
        {label:'list',kind:1,doc:'list(iterable)\n\n‡∏™‡∏£‡πâ‡∏≤‡∏á list',insert:'list(${1:})'},
        {label:'sorted',kind:1,doc:'sorted(iterable, reverse=False)\n\n‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö',insert:'sorted(${1:})'},
        {label:'enumerate',kind:1,doc:'enumerate(iterable, start=0)\n\n‡∏ß‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° index',insert:'enumerate(${1:})'},
        {label:'zip',kind:1,doc:'zip(*iterables)\n\n‡∏£‡∏ß‡∏° iterables ‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô',insert:'zip(${1:})'},
        {label:'map',kind:1,doc:'map(function, iterable)\n\n‡πÉ‡∏ä‡πâ function ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å element',insert:'map(${1:}, ${2:})'},
        {label:'filter',kind:1,doc:'filter(function, iterable)\n\n‡∏Å‡∏£‡∏≠‡∏á elements',insert:'filter(${1:}, ${2:})'},
        // keywords with snippets
        {label:'if',kind:14,doc:'if condition:\n    # code',insert:'if ${1:condition}:\n    ${2:pass}'},
        {label:'elif',kind:14,doc:'elif condition:\n    # code',insert:'elif ${1:condition}:\n    ${2:pass}'},
        {label:'else',kind:14,doc:'else:\n    # code',insert:'else:\n    ${1:pass}'},
        {label:'for',kind:14,doc:'for var in iterable:\n    # code',insert:'for ${1:i} in ${2:range(10)}:\n    ${3:pass}'},
        {label:'while',kind:14,doc:'while condition:\n    # code',insert:'while ${1:condition}:\n    ${2:pass}'},
        {label:'def',kind:14,doc:'def function_name(params):\n    # code',insert:'def ${1:func}(${2:}):\n    ${3:pass}'},
        {label:'return',kind:14,insert:'return ${1:}'},
        {label:'import',kind:14,insert:'import ${1:}'},
        {label:'from',kind:14,insert:'from ${1:} import ${2:}'},
        {label:'class',kind:14,insert:'class ${1:MyClass}:\n    def __init__(self):\n        ${2:pass}'},
        {label:'try',kind:14,insert:'try:\n    ${1:pass}\nexcept ${2:Exception} as e:\n    ${3:pass}'},
        {label:'with',kind:14,insert:'with ${1:} as ${2:f}:\n    ${3:pass}'},
        {label:'lambda',kind:14,insert:'lambda ${1:x}: ${2:x}'},
        {label:'True',kind:17,insert:'True'},
        {label:'False',kind:17,insert:'False'},
        {label:'None',kind:17,insert:'None'},
        // math module
        {label:'math.sqrt',kind:1,doc:'math.sqrt(x)\n\n‡∏£‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á ‚Äî ‡∏ï‡πâ‡∏≠‡∏á import math ‡∏Å‡πà‡∏≠‡∏ô',insert:'math.sqrt(${1:})'},
        {label:'math.pi',kind:5,doc:'œÄ ‚âà 3.14159...',insert:'math.pi'},
        {label:'math.floor',kind:1,doc:'math.floor(x)\n\n‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏•‡∏á',insert:'math.floor(${1:})'},
        {label:'math.ceil',kind:1,doc:'math.ceil(x)\n\n‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏Ç‡∏∂‡πâ‡∏ô',insert:'math.ceil(${1:})'},
        {label:'math.pow',kind:1,doc:'math.pow(x, y)\n\nx ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á y',insert:'math.pow(${1:}, ${2:})'},
        {label:'math.log',kind:1,doc:'math.log(x[, base])\n\nlogarithm',insert:'math.log(${1:})'},
      ];

      monaco.languages.registerCompletionItemProvider('python', {
        triggerCharacters: ['.', '('],
        provideCompletionItems(model, position) {
          const word = model.getWordUntilPosition(position);
          const range = {
            startLineNumber: position.lineNumber,
            endLineNumber:   position.lineNumber,
            startColumn:     word.startColumn,
            endColumn:       word.endColumn,
          };
          const suggestions = BUILTINS.map(b => ({
            label:            b.label,
            kind:             b.kind ?? monaco.languages.CompletionItemKind.Function,
            documentation:    b.doc || b.label,
            insertText:       b.insert || b.label,
            insertTextRules:  monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
            range,
          }));
          return { suggestions };
        }
      });

      monaco.languages.registerHoverProvider('python', {
        provideHover(model, position) {
          const word = model.getWordAtPosition(position);
          if (!word) return;
          const item = BUILTINS.find(b => b.label === word.word);
          if (!item || !item.doc) return;
          return {
            contents: [
              { value: `**${item.label}**` },
              { value: '```\n' + item.doc + '\n```' }
            ]
          };
        }
      });

      const isDark = currentTheme === 'dark';
      monacoEditor = monaco.editor.create(document.getElementById('editor-container'), {
        value: exercises.length > 0 ? exercises[0].starterCode : '# ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î Python ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n',
        language: 'python',
        theme: isDark ? 'pyAdventure' : 'pyAdventureLight',
        fontSize: 14,
        fontFamily: "'Fira Code', monospace",
        fontLigatures: true,
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        lineNumbers: 'on',
        automaticLayout: true,
        tabSize: 4,
        wordWrap: 'on',
        padding: { top: 14, bottom: 14 },
        quickSuggestions: { other: true, comments: false, strings: false },
        suggestOnTriggerCharacters: true,
        acceptSuggestionOnEnter: 'on',
        snippetSuggestions: 'top',
        parameterHints: { enabled: true },
        hover: { enabled: true },
      });
      resolve();
    });
  });
}

// ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const collapsedChapters = new Set(); // track which chapter indices are collapsed

function buildSidebar() {
  const sb = document.getElementById('sidebar');
  let currentGroup = null;
  let chapterIdx = 0;

  exercises.forEach((ex, i) => {
    if (ex.chapter) {
      // New chapter group
      chapterIdx++;
      const idx = chapterIdx;
      const group = document.createElement('div');
      group.className = 'chapter-group';
      group.id = `chap-group-${idx}`;
      if (collapsedChapters.has(idx)) group.classList.add('collapsed');

      const toggle = document.createElement('button');
      toggle.className = 'chapter-toggle';
      toggle.innerHTML = `
        <span style="flex:1;text-align:left">${ex.chapter}</span>
        <div class="chapter-toggle-line"></div>
        <span class="chapter-caret">‚ñæ</span>`;
      toggle.onclick = () => {
        const collapsed = group.classList.toggle('collapsed');
        if (collapsed) collapsedChapters.add(idx);
        else collapsedChapters.delete(idx);
      };
      group.appendChild(toggle);

      const items = document.createElement('div');
      items.className = 'chapter-items';
      group.appendChild(items);

      sb.appendChild(group);
      currentGroup = items;
    }

    const btn = document.createElement('button');
    btn.className = 'exercise-btn' + (i === currentIdx ? ' active' : '') + (completed.has(i) ? ' completed' : '');
    btn.id = 'ex-btn-' + i;
    btn.innerHTML = `<div class="ex-num">${ex.id}</div><span style="flex:1">${ex.title.replace(`‡∏Ç‡πâ‡∏≠ ${ex.id} ‚Äî `, '')}</span>`;
    btn.onclick = () => selectExercise(i);
    (currentGroup || sb).appendChild(btn);
  });
}

function updateSidebar() {
  exercises.forEach((_, i) => {
    const b = document.getElementById('ex-btn-' + i);
    if (b) b.className = 'exercise-btn' + (i===currentIdx?' active':'') + (completed.has(i)?' completed':'');
  });
}

// ‚îÄ‚îÄ EXERCISE SELECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectExercise(idx) {
  currentIdx = idx;
  const ex = exercises[idx];
  document.getElementById('problemBadge').textContent = ex.badge;
  document.getElementById('problemBadge').className = 'problem-badge ' + ex.badgeClass;
  document.getElementById('problemTitle').textContent = ex.title;
  document.getElementById('problemDesc').innerHTML = ex.desc;
  document.getElementById('hintText').textContent = ex.hint;
  document.getElementById('hintBox').style.display = 'none';
  document.getElementById('hintToggle').textContent = 'üí° ‡πÅ‡∏™‡∏î‡∏á hint';
  if (monacoEditor) monacoEditor.setValue(ex.starterCode);
  clearOutput();
  hideResult();
  document.getElementById('nextBtn').style.display = 'none';
  updateSidebar();
  updateProgress();
}

// ‚îÄ‚îÄ OUTPUT UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addLine(text, cls) {
  const el = document.getElementById('outputContent');
  const d = document.createElement('div');
  d.className = 'out-line' + (cls ? ' ' + cls : '');
  d.textContent = text;
  el.appendChild(d);
  el.scrollTop = el.scrollHeight;
}

function clearOutput() {
  document.getElementById('outputContent').innerHTML =
    '<div class="out-line out-sys">// ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà üéØ</div>';
}

// ‚îÄ‚îÄ MANUAL INPUT (when no queue) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupInputHandling() {
  const f = document.getElementById('inputField');
  f.addEventListener('keydown', e => {
    if (e.key === 'Enter' && inputCallback) {
      const val = f.value;
      f.value = '';
      document.getElementById('inputContainer').classList.remove('active');
      const cb = inputCallback;
      inputCallback = null;
      cb(val);
    }
  });
}

function waitForInput() {
  return new Promise(resolve => {
    inputCallback = resolve;
    document.getElementById('inputContainer').classList.add('active');
    document.getElementById('inputField').focus();
  });
}

// ‚îÄ‚îÄ CORE EXECUTION ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Approach: pre-fill a Python-side list with the input values.
// Python's input() is replaced with a function that pops from that list.
// stdout is captured via io.StringIO.
// The whole thing runs synchronously (no async complications).

async function executePython(userCode, autoInputs) {
  // Store user code and inputs in pyodide globals to avoid escaping issues
  pyodide.globals.set('_user_code', userCode);

  // Build input list as Python list literal
  const pyInputList = '[' + autoInputs.map(v => JSON.stringify(String(v))).join(',') + ']';

  // If no auto inputs and code uses input(), we need interactive mode
  // For now, for auto-graded exercises all inputs are pre-supplied
  const pyScript = `
import sys, io, builtins, traceback

# ‚îÄ‚îÄ capture stdout ‚îÄ‚îÄ
_out_buf = io.StringIO()
_old_stdout = sys.stdout
sys.stdout = _out_buf

# ‚îÄ‚îÄ patch input() ‚îÄ‚îÄ
_input_vals = ${pyInputList}
_input_idx = [0]

def _fake_input(prompt=''):
    if prompt:
        print(prompt, end='')
    if _input_idx[0] < len(_input_vals):
        val = _input_vals[_input_idx[0]]
        _input_idx[0] += 1
        return val
    return ''

builtins.input = _fake_input

# ‚îÄ‚îÄ run user code ‚îÄ‚îÄ
_err = None
try:
    exec(compile(_user_code, '<student>', 'exec'))
except SystemExit:
    pass
except Exception:
    _err = traceback.format_exc()

# ‚îÄ‚îÄ restore ‚îÄ‚îÄ
sys.stdout = _old_stdout
builtins.input = input.__class__  # doesn't matter, we'll reset on next run

# ‚îÄ‚îÄ return result ‚îÄ‚îÄ
_result = _out_buf.getvalue()
if _err:
    _result = '__ERR__' + _err
_result
`;

  const result = await pyodide.runPythonAsync(pyScript);
  return String(result || '');
}

// ‚îÄ‚îÄ RUN (display only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runCode() {
  if (!pyodideReady) return;
  const ex = exercises[currentIdx];
  const code = monacoEditor.getValue();
  clearOutput();
  hideResult();
  document.getElementById('nextBtn').style.display = 'none';
  setRunning(true);

  try {
    const raw = await executePython(code, ex.inputs || []);
    renderOutput(raw, ex.inputs || []);
  } catch(e) {
    addLine('‚ö†Ô∏è JS Error: ' + (e.message||e), 'out-err');
  } finally {
    setRunning(false);
  }
}

// ‚îÄ‚îÄ CHECK ANSWER (Multi Test Cases) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkAnswer() {
  if (!pyodideReady) return;
  const ex = exercises[currentIdx];
  const code = monacoEditor.getValue();
  clearOutput();
  hideResult();
  setRunning(true);

  // Build test cases array: support new testCases field or fall back to single case
  const testCases = ex.testCases && ex.testCases.length > 0
    ? ex.testCases
    : [{ inputs: ex.inputs || [], expected: ex.expected }];

  const normalize = s => s.split('\n').map(l => l.trimEnd()).join('\n').trim();

  let allPassed = true;
  let firstError = null;
  const results = [];

  for (let i = 0; i < testCases.length; i++) {
    const tc = testCases[i];
    let raw = '';
    try {
      raw = await executePython(code, tc.inputs || []);
    } catch(e) {
      raw = '__ERR__' + (e.message || e);
    }

    if (raw.startsWith('__ERR__')) {
      allPassed = false;
      if (!firstError) firstError = raw;
      results.push({ passed: false, inputs: tc.inputs, expected: tc.expected, got: null, error: true });
      break; // stop on runtime error
    }

    const got = normalize(raw);
    const want = normalize(tc.expected);
    const passed = got === want;
    if (!passed) allPassed = false;
    results.push({ passed, inputs: tc.inputs, expected: tc.expected, got });
  }

  setRunning(false);

  // Show output for last run (or first error)
  if (firstError) {
    renderOutput(firstError, []);
  } else {
    const lastTc = testCases[results.length - 1];
    renderOutput(
      // re-use last raw: rebuild from got
      results[results.length-1].got !== null
        ? results[results.length-1].got + '\n'
        : '',
      lastTc.inputs || []
    );
  }

  if (allPassed && !completed.has(currentIdx)) {
    completed.add(currentIdx);
    score++;
    document.getElementById('scoreDisplay').textContent = score;
    showStarBurst();
  }

  showResultMulti(allPassed, results, testCases.length);
  if (allPassed) document.getElementById('nextBtn').style.display =
    currentIdx < exercises.length - 1 ? 'flex' : 'none';
  updateSidebar(); updateProgress();
}

// ‚îÄ‚îÄ RENDER OUTPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOutput(raw, autoInputs) {
  if (raw.startsWith('__ERR__')) {
    const msg = raw.replace('__ERR__', '');
    // Show the most relevant error line
    const lines = msg.trim().split('\n');
    const errLine = lines.filter(l => /Error/.test(l)).pop() || lines[lines.length-1];
    addLine('‚ö†Ô∏è ' + errLine.trim(), 'out-err');
    return;
  }

  // Show auto-inputs as info lines first
  if (autoInputs.length > 0) {
    autoInputs.forEach(v => addLine('‚Üí input: ' + v, 'out-inp'));
  }

  const lines = raw.split('\n');
  // Remove trailing empty line that print() adds
  if (lines.length > 0 && lines[lines.length-1] === '') lines.pop();
  if (lines.length === 0) {
    addLine('(‡πÑ‡∏°‡πà‡∏°‡∏µ output)', 'out-sys');
  } else {
    lines.forEach(l => addLine(l, ''));
  }
}

// ‚îÄ‚îÄ RESULT DISPLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showResult(ok, expected, got) {
  const panel = document.getElementById('resultPanel');
  const inner = document.getElementById('resultInner');
  if (ok) {
    inner.innerHTML = `<div class="result-correct">
      <div class="result-icon">üéâ</div>
      <div>
        <div class="result-msg" style="color:var(--green)">‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! üåü</div>
        <div class="result-sub">Output: "${expected.replace(/\n/g,' | ')}"</div>
      </div></div>`;
  } else {
    inner.innerHTML = `<div class="result-wrong">
      <div class="result-icon">ü§î</div>
      <div>
        <div class="result-msg" style="color:var(--red)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞!</div>
        <div class="result-sub">‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á: "${expected.replace(/\n/g,' | ')}"  |  ‡πÑ‡∏î‡πâ: "${String(got||'').replace(/\n/g,' | ').substring(0,60)}"</div>
      </div></div>`;
  }
  panel.classList.add('show');
}

function hideResult() {
  document.getElementById('resultPanel').classList.remove('show');
}

function showResultMulti(allPassed, results, total) {
  const panel = document.getElementById('resultPanel');
  const inner = document.getElementById('resultInner');
  const passed = results.filter(r => r.passed).length;

  if (allPassed) {
    inner.innerHTML = `<div class="result-correct">
      <div class="result-icon">üéâ</div>
      <div>
        <div class="result-msg" style="color:var(--green)">‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å test case! (${passed}/${total}) üåü</div>
        <div class="result-sub">‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å test case ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!</div>
      </div></div>`;
  } else {
    // Show per-test-case breakdown
    const rows = results.map((r, i) => {
      if (r.error) {
        return `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:0.78rem">
          <span style="color:var(--red)">‚úó</span>
          <span style="color:var(--text2)">Test ${i+1}</span>
          <span style="color:var(--red)">Runtime Error</span>
        </div>`;
      }
      const inputStr = (r.inputs||[]).length ? ` [input: ${r.inputs.join(', ')}]` : '';
      return `<div style="display:flex;align-items:center;gap:8px;padding:3px 0;font-size:0.78rem;flex-wrap:wrap">
        <span style="color:${r.passed?'var(--green)':'var(--red)'}">${r.passed?'‚úì':'‚úó'}</span>
        <span style="color:var(--text2)">Test ${i+1}${inputStr}</span>
        ${!r.passed ? `<span style="color:var(--text2)">‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á: <code style="color:var(--accent3)">${(r.expected||'').replace(/\n/g,' | ').substring(0,40)}</code> ‡πÑ‡∏î‡πâ: <code style="color:var(--red)">${(r.got||'').replace(/\n/g,' | ').substring(0,40)}</code></span>` : ''}
      </div>`;
    }).join('');
    inner.innerHTML = `<div class="result-wrong" style="flex-direction:column;align-items:flex-start;gap:8px">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="result-icon">ü§î</div>
        <div>
          <div class="result-msg" style="color:var(--red)">‡∏ú‡πà‡∏≤‡∏ô ${passed}/${total} test case ‚Äî ‡∏•‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞!</div>
        </div>
      </div>
      <div style="padding-left:4px;width:100%">${rows}</div>
    </div>`;
  }
  panel.classList.add('show');
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setRunning(on) {
  document.getElementById('runBtn').disabled = on;
  document.getElementById('checkBtn').disabled = on;
  document.getElementById('runSpinner').style.display = on ? 'inline' : 'none';
}

function toggleHint() {
  const box = document.getElementById('hintBox');
  const btn = document.getElementById('hintToggle');
  const show = box.style.display === 'none';
  box.style.display = show ? 'flex' : 'none';
  btn.textContent = show ? 'üôà ‡∏ã‡πà‡∏≠‡∏ô hint' : 'üí° ‡πÅ‡∏™‡∏î‡∏á hint';
}

function nextExercise() {
  if (currentIdx < exercises.length - 1) selectExercise(currentIdx + 1);
}

function updateProgress() {
  document.getElementById('progressFill').style.width =
    (completed.size / exercises.length * 100) + '%';
}

function showStarBurst() {
  const stars = ['‚≠ê','üåü','‚ú®','üéâ','üéä','üí´'];
  for (let i = 0; i < 6; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'star-burst';
      el.textContent = stars[Math.floor(Math.random()*stars.length)];
      el.style.left = (15 + Math.random()*70)+'vw';
      el.style.top = (15 + Math.random()*70)+'vh';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }, i * 100);
  }
}

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentTheme = 'dark';

function toggleTheme() {
  currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
  applyTheme(currentTheme);
  localStorage.setItem('py-adv-theme', currentTheme);
}

function applyTheme(theme) {
  const root = document.documentElement;
  if (theme === 'light') {
    root.setAttribute('data-theme', 'light');
    document.getElementById('themeIcon').innerHTML = `
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`;
    document.getElementById('themeTxt').textContent = 'Dark';
    if (monacoEditor) monaco.editor.setTheme('pyAdventureLight');
  } else {
    root.removeAttribute('data-theme');
    document.getElementById('themeIcon').innerHTML = `
      <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/>
      <line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/>
      <line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>`;
    document.getElementById('themeTxt').textContent = 'Light';
    if (monacoEditor) monaco.editor.setTheme('pyAdventure');
  }
}

const DEFAULT_JSON_URL = 'https://raw.githubusercontent.com/Karibura-Cyber/python-playground/refs/heads/main/exercises.json';

function validateExercise(ex) {
  const required = ['id','title','badge','badgeClass','desc','hint','starterCode','expected'];
  for (const f of required) {
    if (ex[f] === undefined || ex[f] === null) return `‡∏Ç‡∏≤‡∏î field: "${f}"`;
  }
  if (typeof ex.id !== 'number') return `"id" ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç`;
  if (!Array.isArray(ex.inputs)) ex.inputs = [];
  if (!ex.type) ex.type = 'custom';
  if (ex.chapter === undefined) ex.chapter = null;
  return null;
}

function mergeExercises(newExs) {
  const existingIds = new Set(exercises.map(e => e.id));
  let added = 0, skipped = 0, errors = [];
  newExs.forEach((ex, i) => {
    const err = validateExercise(ex);
    if (err) { errors.push(`‡∏Ç‡πâ‡∏≠ ${i+1}: ${err}`); return; }
    if (existingIds.has(ex.id)) { skipped++; return; }
    exercises.push(ex);
    existingIds.add(ex.id);
    added++;
  });
  return { added, skipped, errors };
}

function rebuildAfterMerge() {
  document.getElementById('sidebar').innerHTML = '';
  buildSidebar();
  document.getElementById('totalDisplay').textContent = exercises.length;
  // If no exercise is selected yet (idx 0 might not exist), select first
  if (exercises.length > 0 && document.getElementById('problemTitle').textContent === '') {
    selectExercise(0);
  }
  updateProgress();
}

// ‚îÄ‚îÄ TOAST SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _toastId = 0;

function showToast(msg, type = 'info', duration = 4000) {
  // type: 'ok' | 'err' | 'info'
  const container = document.getElementById('toast-container');
  const id = ++_toastId;

  const icons = { ok: '‚úì', err: '‚úï', info: '‚Ñπ' };

  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.id = `toast-${id}`;
  el.innerHTML = `
    <span class="toast-icon">${icons[type] || icons.info}</span>
    <span class="toast-msg">${msg}</span>
    <button class="toast-close" onclick="dismissToast(${id})">‚úï</button>`;

  container.appendChild(el);

  // Trigger enter animation
  requestAnimationFrame(() => requestAnimationFrame(() => el.classList.add('show')));

  // Auto dismiss
  const timer = setTimeout(() => dismissToast(id), duration);
  el._timer = timer;

  return id;
}

function dismissToast(id) {
  const el = document.getElementById(`toast-${id}`);
  if (!el) return;
  clearTimeout(el._timer);
  el.classList.remove('show');
  el.classList.add('hide');
  setTimeout(() => el.remove(), 280);
}

// Legacy alias used by save/load functions
function showJsonStatus(msg, isOk) {
  showToast(msg, isOk ? 'ok' : 'err');
}

async function loadDefaultJson() {
  const btn = document.getElementById('reloadJsonBtn');
  if (btn) { btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...'; btn.disabled = true; }
  try {
    const res = await fetch(DEFAULT_JSON_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('JSON ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô array');

    // Validate each exercise
    const errors = [];
    const valid = [];
    data.forEach((ex, i) => {
      const err = validateExercise(ex);
      if (err) { errors.push(`‡∏Ç‡πâ‡∏≠ ${i+1}: ${err}`); return; }
      valid.push(ex);
    });

    // Replace exercises with data from JSON (keep any extra loaded from file)
    // Filter out exercises whose id exists in the new JSON, then push new ones
    const newIds = new Set(valid.map(e => e.id));
    exercises = exercises.filter(e => !newIds.has(e.id)); // remove old versions
    exercises.push(...valid);
    // Sort by id
    exercises.sort((a, b) => a.id - b.id);

    rebuildAfterMerge();

    if (errors.length > 0) {
      showToast(`‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ${valid.length} ‡∏Ç‡πâ‡∏≠ ‚Äî ‚ö†Ô∏è ${errors.length} error`, 'err');
    }
    return valid.length;
  } catch(e) {
    showToast('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + e.message, 'err');
    return 0;
  } finally {
    // if (btn) { btn.textContent = 'üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå'; btn.disabled = false; }
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå'; btn.disabled = false; }
  }
}

function loadFromFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  event.target.value = '';
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error('JSON ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô array');
      const { added, skipped, errors } = mergeExercises(data);
      rebuildAfterMerge();
      let msg = `"${file.name}": +${added} ‡∏Ç‡πâ‡∏≠`;
      if (skipped > 0) msg += ` (‡∏ã‡πâ‡∏≥ ${skipped})`;
      showToast(msg, errors.length === 0 ? 'ok' : 'err');
    } catch(e) {
      showToast('‚ùå ' + e.message, 'err');
    }
  };
  reader.onerror = () => showToast('‚ùå ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'err');
  reader.readAsText(file, 'UTF-8');
}

// ‚îÄ‚îÄ SAVE / LOAD PROGRESS (.mxr) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// .mxr format: base64-encoded JSON with a magic header

const MXR_MAGIC = 'PYADVMXR1';

function collectCurrentCode() {
  // Save current editor code for the active exercise
  return monacoEditor ? monacoEditor.getValue() : '';
}

function saveProgress() {
  document.getElementById('saveModal').style.display = 'flex';
  setTimeout(() => document.getElementById('saveNameInput').focus(), 50);
}

function closeSaveModal() {
  document.getElementById('saveModal').style.display = 'none';
}

function confirmSave() {
  const studentName = document.getElementById('saveNameInput').value.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
  closeSaveModal();

  // Build snapshot
  const snapshot = {
    magic: MXR_MAGIC,
    version: 1,
    savedAt: new Date().toISOString(),
    studentName,
    score,
    currentIdx,
    completed: [...completed],         // array of completed exercise indices
    // Save code per exercise id: { [id]: code }
    codes: {},
  };

  // Save current editor content for current exercise
  if (monacoEditor) {
    snapshot.codes[exercises[currentIdx].id] = monacoEditor.getValue();
  }

  // Encode to base64
  const json = JSON.stringify(snapshot);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  const blob = new Blob([b64], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);

  // Generate filename: progress_NAME_DATE.mxr
  const dateStr = new Date().toISOString().slice(0,10);
  const safeName = studentName.replace(/[^a-zA-Z0-9‡∏Å-‡πô]/g, '_').substring(0,20);
  const filename = `progress_${safeName}_${dateStr}.mxr`;

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);

  showJsonStatus(`üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${filename}`, true);
}

function loadProgress(event) {
  const file = event.target.files[0];
  if (!file) return;
  event.target.value = '';

  if (!file.name.endsWith('.mxr')) {
    showJsonStatus('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô .mxr', false);
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      // Decode base64
      const b64 = e.target.result.trim();
      const json = decodeURIComponent(escape(atob(b64)));
      const snapshot = JSON.parse(json);

      // Validate magic
      if (snapshot.magic !== MXR_MAGIC) throw new Error('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢');

      // Restore state
      score = snapshot.score || 0;
      completed.clear();
      (snapshot.completed || []).forEach(i => completed.add(i));

      document.getElementById('scoreDisplay').textContent = score;

      // Restore codes if available
      if (snapshot.codes && snapshot.currentIdx !== undefined) {
        const targetIdx = Math.min(snapshot.currentIdx, exercises.length - 1);
        selectExercise(targetIdx);

        // Restore code for current exercise
        const exId = exercises[targetIdx].id;
        if (snapshot.codes[exId] && monacoEditor) {
          monacoEditor.setValue(snapshot.codes[exId]);
        }
      }

      updateSidebar();
      updateProgress();

      const savedDate = snapshot.savedAt ? new Date(snapshot.savedAt).toLocaleDateString('th-TH') : '?';
      showJsonStatus(`üìÇ ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: ${snapshot.studentName} | ${score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô | ${savedDate}`, true);

    } catch(e) {
      showJsonStatus('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + e.message, false);
    }
  };
  reader.onerror = () => showJsonStatus('‚ùå ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', false);
  reader.readAsText(file, 'UTF-8');
}

// ‚îÄ‚îÄ PANEL RESIZER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const resizer = document.getElementById('panelResizer');
  const panel   = document.querySelector('.problem-panel');
  let dragging = false, startY = 0, startH = 0;

  resizer.addEventListener('mousedown', e => {
    dragging = true;
    startY = e.clientY;
    startH = panel.offsetHeight;
    resizer.classList.add('dragging');
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'ns-resize';
  });

  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const newH = Math.max(60, Math.min(startH + (e.clientY - startY), window.innerHeight * 0.6));
    panel.style.height = newH + 'px';
    panel.style.maxHeight = 'none';
    if (window.monacoEditor) window.monacoEditor.layout();
  });

  document.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    resizer.classList.remove('dragging');
    document.body.style.userSelect = '';
    document.body.style.cursor = '';
    if (window.monacoEditor) window.monacoEditor.layout();
  });
})();

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async () => {
  // ‡πÇ‡∏´‡∏•‡∏î theme ‡∏à‡∏≤‡∏Å localStorage
  const savedTheme = localStorage.getItem('py-adv-theme') || 'dark';
  currentTheme = savedTheme;
  if (savedTheme === 'light') applyTheme('light');

  setupInputHandling();

  // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏à‡∏≤‡∏Å JSON ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ render UI
  await loadDefaultJson();

  // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏™‡∏î‡∏á placeholder
  if (exercises.length === 0) {
    document.getElementById('sidebar').innerHTML =
      '<div style="padding:20px;color:var(--text2);font-size:0.8rem;text-align:center">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏à‡∏ó‡∏¢‡πå<br>‡∏Å‡∏î "‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå"</div>';
    document.getElementById('problemTitle').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏à‡∏ó‡∏¢‡πå';
    document.getElementById('problemDesc').textContent = '‡∏Å‡∏î "‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå" ‡∏ó‡∏µ‡πà navbar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å GitHub ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå JSON ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
  } else {
    buildSidebar();
    selectExercise(0);
  }

  document.getElementById('totalDisplay').textContent = exercises.length;

  // ‡πÇ‡∏´‡∏•‡∏î Pyodide ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô
  loadPyodideEngine();
})();
</script>
</body>
</html>
