<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Python Adventure â€” à¹€à¸£à¸µà¸¢à¸™ Python à¸ªà¸™à¸¸à¸à¹†</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700;900&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
<style>
  :root {
    --bg:#0d0f1a; --surface:#141626; --surface2:#1c1f35; --surface3:#252849;
    --accent:#7c5cfc; --accent2:#fc5c9c; --accent3:#5cdbfc; --accent4:#fcdc5c;
    --green:#5cfc9c; --red:#fc5c5c; --text:#e8eaff; --text2:#9497b8;
    --border:rgba(124,92,252,0.25); --glow:0 0 30px rgba(124,92,252,0.3);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Prompt',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
  body::before{content:'';position:fixed;inset:0;background-image:
    radial-gradient(1px 1px at 20% 30%,rgba(255,255,255,0.4) 0%,transparent 100%),
    radial-gradient(1px 1px at 80% 10%,rgba(255,255,255,0.3) 0%,transparent 100%),
    radial-gradient(1.5px 1.5px at 55% 70%,rgba(255,255,255,0.35) 0%,transparent 100%),
    radial-gradient(2px 2px at 35% 15%,rgba(124,92,252,0.6) 0%,transparent 100%),
    radial-gradient(2px 2px at 70% 85%,rgba(92,219,252,0.5) 0%,transparent 100%);
    pointer-events:none;z-index:0}
  header{
    position:relative;z-index:10;
    height:52px;padding:0 24px;
    display:flex;align-items:center;gap:12px;
    background:var(--surface);
    border-bottom:1px solid rgba(255,255,255,0.06);
  }
  .logo{font-size:1.3rem;animation:snake 3s ease-in-out infinite;line-height:1}
  @keyframes snake{0%,100%{transform:rotate(-8deg)}50%{transform:rotate(8deg)}}
  .brand{display:flex;align-items:center;gap:8px}
  .brand-name{font-size:0.95rem;font-weight:700;color:var(--text);letter-spacing:-0.2px}
  .brand-sep{width:1px;height:16px;background:rgba(255,255,255,0.1)}
  /* Python status pill */
  .py-status{display:flex;align-items:center;gap:5px;font-size:0.72rem;color:var(--text2)}
  .status-dot{width:6px;height:6px;border-radius:50%;background:var(--accent4);animation:pulse 1.5s infinite;flex-shrink:0}
  .status-dot.ready{background:var(--green);animation:none}
  .status-dot.error{background:var(--red);animation:none}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
  /* Score */
  .score-pill{margin-left:auto;display:flex;align-items:center;gap:6px;
    font-size:0.78rem;font-weight:600;color:var(--text2)}
  .score-pill strong{color:var(--text);font-size:0.9rem}
  /* Divider */
  .nav-sep{width:1px;height:18px;background:rgba(255,255,255,0.08)}
  /* Nav icon buttons */
  .nav-icon-btn{
    display:flex;align-items:center;gap:6px;
    padding:5px 10px;border-radius:7px;border:none;
    background:transparent;color:var(--text2);
    font-family:'Prompt',sans-serif;font-size:0.75rem;font-weight:600;
    cursor:pointer;transition:background 0.15s,color 0.15s;
    white-space:nowrap;
  }
  .nav-icon-btn:hover{background:var(--surface2);color:var(--text)}
  .nav-icon-btn.green:hover{color:var(--green)}
  .nav-icon-btn.yellow:hover{color:var(--accent4)}
  .nav-icon-btn.cyan:hover{color:var(--accent3)}
  .nav-icon-btn.purple:hover{color:var(--accent)}
  .nav-icon-btn:disabled{opacity:0.4;cursor:not-allowed}
  /* Toast system */
  #toast-container{
    position:fixed;bottom:24px;right:24px;
    z-index:9000;display:flex;flex-direction:column;
    gap:8px;align-items:flex-end;pointer-events:none;
  }
  .toast{
    display:flex;align-items:center;gap:10px;
    padding:10px 16px;border-radius:10px;
    font-size:0.8rem;font-weight:600;
    background:var(--surface2);border:1px solid rgba(255,255,255,0.08);
    box-shadow:0 8px 32px rgba(0,0,0,0.4);
    pointer-events:auto;
    transform:translateX(120%);opacity:0;
    transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1),opacity 0.3s ease;
    max-width:340px;
  }
  .toast.show{transform:translateX(0);opacity:1}
  .toast.hide{transform:translateX(120%);opacity:0;transition:transform 0.25s ease,opacity 0.25s ease}
  .toast-ok{color:var(--green);border-left:3px solid var(--green)}
  .toast-err{color:var(--red);border-left:3px solid var(--red)}
  .toast-info{color:var(--accent3);border-left:3px solid var(--accent3)}
  .toast-icon{font-size:1rem;flex-shrink:0}
  .toast-msg{flex:1;line-height:1.4}
  .toast-close{background:none;border:none;color:var(--text2);cursor:pointer;
    font-size:0.9rem;padding:0 0 0 4px;opacity:0.5;transition:opacity 0.15s}
  .toast-close:hover{opacity:1}
  /* JSON loader bar â€” removed, merged into header */
  .json-loader-bar{display:none}
  .app{display:grid;grid-template-columns:280px 1fr;height:calc(100vh - 55px);position:relative;z-index:1}
  .sidebar{background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;padding:16px 0}
  .sidebar::-webkit-scrollbar{width:3px}
  .sidebar::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px}
  .chapter-title{padding:6px 16px 10px;font-size:0.65rem;font-weight:700;text-transform:uppercase;
    letter-spacing:2px;color:var(--text2);display:flex;align-items:center;gap:7px}
  .chapter-title::after{content:'';flex:1;height:1px;background:var(--border)}
  .exercise-btn{width:100%;padding:10px 16px;background:transparent;border:none;cursor:pointer;
    text-align:left;color:var(--text2);font-family:'Prompt',sans-serif;font-size:0.82rem;
    display:flex;align-items:center;gap:10px;transition:all 0.2s;border-left:3px solid transparent}
  .exercise-btn:hover{background:var(--surface2);color:var(--text);border-left-color:var(--accent)}
  .exercise-btn.active{background:linear-gradient(90deg,rgba(124,92,252,0.15) 0%,transparent 100%);
    color:var(--text);border-left-color:var(--accent)}
  .exercise-btn.completed .ex-num{background:var(--green)!important;color:#0d0f1a!important}
  .ex-num{width:26px;height:26px;border-radius:7px;background:var(--surface3);display:flex;
    align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;flex-shrink:0;transition:all 0.2s}
  .exercise-btn.active .ex-num{background:var(--accent);color:white}
  .ex-check{margin-left:auto;font-size:0.85rem;opacity:0;transition:opacity 0.2s}
  .exercise-btn.completed .ex-check{opacity:1}
  .main{display:grid;grid-template-rows:auto 1fr auto;overflow:hidden}
  .problem-panel{padding:16px 24px;background:var(--surface);border-bottom:1px solid var(--border)}
  .problem-header{display:flex;align-items:flex-start;gap:12px;margin-bottom:10px}
  .problem-badge{padding:3px 10px;border-radius:20px;font-size:0.68rem;font-weight:700;
    text-transform:uppercase;letter-spacing:1px;flex-shrink:0;margin-top:2px}
  .badge-print{background:rgba(92,219,252,0.2);color:var(--accent3);border:1px solid rgba(92,219,252,0.3)}
  .badge-var{background:rgba(252,220,92,0.2);color:var(--accent4);border:1px solid rgba(252,220,92,0.3)}
  .badge-input{background:rgba(92,252,156,0.2);color:var(--green);border:1px solid rgba(92,252,156,0.3)}
  .badge-condition{background:rgba(252,92,156,0.2);color:var(--accent2);border:1px solid rgba(252,92,156,0.3)}
  .badge-loop{background:rgba(252,180,92,0.2);color:#fcb45c;border:1px solid rgba(252,180,92,0.3)}
  /* badge styles */
  /* Progress modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;
    display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
  .modal-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;
    padding:28px 32px;min-width:320px;max-width:420px;box-shadow:var(--glow)}
  .modal-title{font-size:1.1rem;font-weight:700;margin-bottom:6px}
  .modal-sub{font-size:0.82rem;color:var(--text2);margin-bottom:20px;line-height:1.5}
  .modal-field{margin-bottom:14px}
  .modal-field label{display:block;font-size:0.78rem;color:var(--text2);margin-bottom:5px}
  .modal-field input{width:100%;background:var(--surface2);border:1px solid var(--border);
    border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Prompt',sans-serif;
    font-size:0.88rem;outline:none}
  .modal-field input:focus{border-color:var(--accent)}
  .modal-actions{display:flex;gap:9px;justify-content:flex-end;margin-top:20px}
  .modal-btn{padding:8px 18px;border-radius:8px;border:none;cursor:pointer;
    font-family:'Prompt',sans-serif;font-size:0.84rem;font-weight:700;transition:all 0.2s}
  .modal-btn-primary{background:linear-gradient(135deg,var(--green),#3cdc7c);color:#0d0f1a}
  .modal-btn-primary:hover{transform:translateY(-1px)}
  .modal-btn-cancel{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
  .modal-btn-cancel:hover{background:var(--surface3)}
  .problem-title{font-size:1rem;font-weight:700;color:var(--text);line-height:1.4}
  .problem-desc{font-size:0.84rem;color:var(--text2);line-height:1.6}
  .problem-desc code{background:var(--surface3);padding:1px 5px;border-radius:4px;
    font-family:'Fira Code',monospace;font-size:0.8rem;color:var(--accent3)}
  .hint-box{margin-top:10px;padding:9px 12px;background:rgba(124,92,252,0.08);
    border:1px solid rgba(124,92,252,0.2);border-radius:9px;font-size:0.8rem;
    color:var(--accent);display:flex;gap:7px;align-items:flex-start}
  .hint-toggle{background:none;border:1px solid rgba(124,92,252,0.3);color:var(--accent);
    font-family:'Prompt',sans-serif;font-size:0.72rem;padding:3px 9px;border-radius:5px;
    cursor:pointer;margin-top:7px;transition:all 0.2s}
  .hint-toggle:hover{background:rgba(124,92,252,0.15)}
  .editor-area{display:grid;grid-template-columns:1fr 1fr;overflow:hidden}
  .editor-pane{display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:hidden}
  .pane-header{padding:8px 14px;background:var(--surface2);border-bottom:1px solid var(--border);
    font-size:0.75rem;font-weight:600;color:var(--text2);display:flex;align-items:center;gap:7px;flex-shrink:0}
  .pane-dot{width:7px;height:7px;border-radius:50%}
  #editor-container{flex:1;overflow:hidden}
  .output-pane{display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
  .output-content{flex:1;padding:14px;font-family:'Fira Code',monospace;font-size:0.8rem;
    line-height:1.7;overflow-y:auto;color:var(--text)}
  .output-content::-webkit-scrollbar{width:3px}
  .output-content::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:2px}
  .out-line{margin-bottom:1px;white-space:pre-wrap;word-break:break-all}
  .out-err{color:var(--red)}
  .out-sys{color:var(--text2);font-style:italic}
  .out-inp{color:var(--accent3)}
  .input-line-container{display:none;align-items:center;gap:7px;padding:7px 14px;
    background:rgba(124,92,252,0.1);border-top:1px solid rgba(124,92,252,0.2);
    font-family:'Fira Code',monospace;font-size:0.8rem}
  .input-line-container.active{display:flex}
  .input-line-container span{color:var(--accent3);flex-shrink:0}
  .input-line-container input{flex:1;background:transparent;border:none;outline:none;
    color:var(--text);font-family:'Fira Code',monospace;font-size:0.8rem}
  .result-panel{padding:0;background:var(--surface);border-top:1px solid var(--border);
    overflow:hidden;max-height:0;transition:max-height 0.4s ease}
  .result-panel.show{max-height:100px}
  .result-inner{padding:12px 24px}
  .result-correct{display:flex;align-items:center;gap:14px;padding:12px 18px;
    background:rgba(92,252,156,0.08);border:1px solid rgba(92,252,156,0.25);border-radius:10px}
  .result-wrong{display:flex;align-items:center;gap:14px;padding:12px 18px;
    background:rgba(252,92,92,0.08);border:1px solid rgba(252,92,92,0.25);border-radius:10px}
  .result-icon{font-size:1.6rem}
  .result-msg{font-weight:700;font-size:0.95rem}
  .result-sub{font-size:0.78rem;color:var(--text2);margin-top:2px;font-family:'Fira Code',monospace}
  .action-bar{padding:10px 24px;display:flex;align-items:center;gap:10px;
    background:var(--surface);border-top:1px solid var(--border);flex-shrink:0}
  .btn{padding:9px 20px;border-radius:9px;border:none;font-family:'Prompt',sans-serif;
    font-size:0.85rem;font-weight:700;cursor:pointer;transition:all 0.2s;
    display:flex;align-items:center;gap:7px}
  .btn-run{background:linear-gradient(135deg,var(--accent),#5c3cdc);color:white;
    box-shadow:0 4px 18px rgba(124,92,252,0.4)}
  .btn-run:hover{transform:translateY(-1px);box-shadow:0 6px 26px rgba(124,92,252,0.6)}
  .btn-run:disabled{opacity:0.5;cursor:not-allowed;transform:none}
  .btn-check{background:linear-gradient(135deg,var(--accent2),#dc3c7c);color:white;
    box-shadow:0 4px 18px rgba(252,92,156,0.4)}
  .btn-check:hover{transform:translateY(-1px)}
  .btn-check:disabled{opacity:0.5;cursor:not-allowed;transform:none}
  .btn-clear{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
  .btn-clear:hover{background:var(--surface3);color:var(--text)}
  .btn-next{background:linear-gradient(135deg,var(--green),#3cdc7c);color:#0d0f1a;margin-left:auto}
  .btn-next:hover{transform:translateY(-1px)}
  .progress-bar{height:3px;background:var(--surface2);overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent3));transition:width 0.5s ease}
  .star-burst{position:fixed;pointer-events:none;z-index:9999;font-size:2rem;animation:burst 1s ease forwards}
  @keyframes burst{0%{transform:scale(0) translateY(0);opacity:1}100%{transform:scale(1.5) translateY(-80px);opacity:0}}
  .loading-overlay{position:fixed;inset:0;background:rgba(13,15,26,0.97);display:flex;
    flex-direction:column;align-items:center;justify-content:center;z-index:1000;gap:18px}
  .loading-snake{font-size:4.5rem;animation:loadSnake 0.8s ease-in-out infinite}
  @keyframes loadSnake{0%,100%{transform:rotate(-15deg) scale(1)}50%{transform:rotate(15deg) scale(1.1)}}
  .loading-title{font-size:1.7rem;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent3));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .loading-bar{width:280px;height:5px;background:var(--surface2);border-radius:3px;overflow:hidden}
  .loading-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent3));border-radius:3px;transition:width 0.3s ease}
  .loading-text{font-size:0.82rem;color:var(--text2)}
  @media(max-width:900px){.app{grid-template-columns:1fr}.sidebar{display:none}.editor-area{grid-template-columns:1fr;grid-template-rows:1fr 1fr}}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-snake">ğŸ</div>
  <div class="loading-title">Python Adventure</div>
  <div class="loading-bar"><div class="loading-fill" id="loadingFill" style="width:0%"></div></div>
  <div class="loading-text" id="loadingText">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸” Pyodide...</div>
</div>

<header>
  <!-- Brand -->
  <div class="brand">
    <span class="logo">ğŸ</span>
    <span class="brand-name">Python Adventure</span>
  </div>

  <div class="nav-sep"></div>

  <!-- Python status -->
  <div class="py-status">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</span>
  </div>

  <!-- Score -->
  <div class="score-pill">
    <span>â­</span>
    <strong id="scoreDisplay">0</strong>
    <span style="color:rgba(255,255,255,0.2)">/</span>
    <span id="totalDisplay">20</span>
  </div>

  <div class="nav-sep"></div>

  <!-- Exercises section -->
  <button class="nav-icon-btn cyan" onclick="loadDefaultJson()" id="reloadJsonBtn" title="à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œà¸ˆà¸²à¸ GitHub">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.12"/></svg>
    à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œ
  </button>
  <button class="nav-icon-btn purple" onclick="document.getElementById('jsonFileInput').click()" title="à¹€à¸à¸´à¹ˆà¸¡à¹‚à¸ˆà¸—à¸¢à¹Œà¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œ .json">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
    à¹€à¸à¸´à¹ˆà¸¡à¹‚à¸ˆà¸—à¸¢à¹Œ
  </button>
  <input type="file" id="jsonFileInput" accept=".json" onchange="loadFromFile(event)" style="display:none"/>

  <div class="nav-sep"></div>

  <!-- Progress section -->
  <button class="nav-icon-btn green" onclick="saveProgress()" title="à¸šà¸±à¸™à¸—à¸¶à¸ progress">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
    à¸šà¸±à¸™à¸—à¸¶à¸
  </button>
  <button class="nav-icon-btn yellow" onclick="document.getElementById('progressFileInput').click()" title="à¹‚à¸«à¸¥à¸” progress">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    à¹‚à¸«à¸¥à¸” Progress
  </button>
  <input type="file" id="progressFileInput" accept=".mxr" onchange="loadProgress(event)" style="display:none"/>
</header>

<!-- Toast container -->
<div id="toast-container"></div>

<div class="progress-bar">
  <div class="progress-fill" id="progressFill" style="width:0%"></div>
</div>


<div class="app">
  <aside class="sidebar" id="sidebar"></aside>
  <div class="main">
    <div class="problem-panel">
      <div class="problem-header">
        <div class="problem-badge" id="problemBadge"></div>
        <div>
          <div class="problem-title" id="problemTitle"></div>
          <div class="problem-desc" id="problemDesc"></div>
        </div>
      </div>
      <button class="hint-toggle" id="hintToggle" onclick="toggleHint()">ğŸ’¡ à¹à¸ªà¸”à¸‡ hint</button>
      <div class="hint-box" id="hintBox" style="display:none">
        <span>ğŸ’¡</span><span id="hintText"></span>
      </div>
    </div>

    <div class="editor-area">
      <div class="editor-pane">
        <div class="pane-header">
          <div class="pane-dot" style="background:#fc5c5c"></div>
          <div class="pane-dot" style="background:#fcdc5c"></div>
          <div class="pane-dot" style="background:#5cfc9c"></div>
          <span style="margin-left:4px">main.py</span>
        </div>
        <div id="editor-container"></div>
      </div>
      <div class="output-pane">
        <div class="pane-header">
          <div class="pane-dot" style="background:var(--accent3)"></div>
          <span>Output</span>
          <span id="runSpinner" style="margin-left:auto;display:none">â³</span>
        </div>
        <div class="output-content" id="outputContent">
          <div class="out-line out-sys">// à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸‚à¸­à¸‡à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸ˆà¸°à¹à¸ªà¸”à¸‡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ ğŸ¯</div>
        </div>
        <div class="input-line-container" id="inputContainer">
          <span>â–¶</span>
          <input type="text" id="inputField" placeholder="à¸à¸´à¸¡à¸à¹Œà¸„à¹ˆà¸² input à¹à¸¥à¹‰à¸§à¸à¸” Enter..." autocomplete="off"/>
        </div>
      </div>
    </div>

    <div class="result-panel" id="resultPanel">
      <div class="result-inner" id="resultInner"></div>
    </div>

    <div class="action-bar">
      <button class="btn btn-run" id="runBtn" onclick="runCode()" disabled>â–¶ à¸£à¸±à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡</button>
      <button class="btn btn-check" id="checkBtn" onclick="checkAnswer()" disabled>âœ“ à¸•à¸£à¸§à¸ˆà¸„à¸³à¸•à¸­à¸š</button>
      <button class="btn btn-clear" onclick="clearOutput()">ğŸ—‘ à¸¥à¹‰à¸²à¸‡</button>
      <button class="btn btn-next" id="nextBtn" onclick="nextExercise()" style="display:none">à¸‚à¹‰à¸­à¸–à¸±à¸”à¹„à¸› â†’</button>
    </div>
  </div>
</div>

<!-- SAVE MODAL -->
<div class="modal-overlay" id="saveModal" style="display:none" onclick="if(event.target===this)closeSaveModal()">
  <div class="modal-box">
    <div class="modal-title">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸ Progress</div>
    <div class="modal-sub">à¹„à¸Ÿà¸¥à¹Œà¸ˆà¸°à¸–à¸¹à¸à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸›à¹‡à¸™ <b>.mxr</b><br>à¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸”à¸à¸¥à¸±à¸šà¸¡à¸²à¹€à¸£à¸µà¸¢à¸™à¸•à¹ˆà¸­à¹„à¸”à¹‰à¹ƒà¸™à¸ à¸²à¸¢à¸«à¸¥à¸±à¸‡</div>
    <div class="modal-field">
      <label>à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™ (à¹ƒà¸ªà¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸à¹‡à¹„à¸”à¹‰)</label>
      <input type="text" id="saveNameInput" placeholder="à¹€à¸Šà¹ˆà¸™ à¸™à¹‰à¸­à¸‡à¸«à¸¡à¸µ" maxlength="40" />
    </div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-cancel" onclick="closeSaveModal()">à¸¢à¸à¹€à¸¥à¸´à¸</button>
      <button class="modal-btn modal-btn-primary" onclick="confirmSave()">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸Ÿà¸¥à¹Œ</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ EXERCISES (à¹‚à¸«à¸¥à¸”à¸ˆà¸²à¸ JSON) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let exercises = [];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentIdx = 0;
const completed = new Set();
let score = 0;
let monacoEditor = null;
let pyodideReady = false;
let pyodide = null;
// For manual input (when no auto-queue)
let inputQueue = [];
let inputCallback = null;

// â”€â”€ PYODIDE LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPyodideEngine() {
  try {
    setLoading(10, "à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸” Pyodide...");
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js';
    document.head.appendChild(s);
    await new Promise((ok, err) => { s.onload = ok; s.onerror = err; });

    setLoading(45, "à¸à¸³à¸¥à¸±à¸‡à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ Python runtime...");
    pyodide = await window.loadPyodide({
      indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/'
    });

    setLoading(80, "à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸” Monaco Editor...");
    await loadMonaco();

    setLoading(100, "à¸à¸£à¹‰à¸­à¸¡à¹à¸¥à¹‰à¸§! ğŸ‰");
    pyodideReady = true;
    document.getElementById('statusDot').className = 'status-dot ready';
    document.getElementById('statusText').textContent = 'Python à¸à¸£à¹‰à¸­à¸¡';
    document.getElementById('runBtn').disabled = false;
    document.getElementById('checkBtn').disabled = false;

    setTimeout(() => {
      const ov = document.getElementById('loadingOverlay');
      ov.style.transition = 'opacity 0.5s';
      ov.style.opacity = '0';
      setTimeout(() => ov.style.display = 'none', 500);
    }, 300);
  } catch(e) {
    document.getElementById('statusDot').className = 'status-dot error';
    document.getElementById('statusText').textContent = 'à¹‚à¸«à¸¥à¸”à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§';
    document.getElementById('loadingText').textContent = 'Error: ' + e.message;
  }
}

function setLoading(pct, txt) {
  document.getElementById('loadingFill').style.width = pct + '%';
  document.getElementById('loadingText').textContent = txt;
}

function loadMonaco() {
  return new Promise(resolve => {
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
    require(['vs/editor/editor.main'], () => {
      monaco.editor.defineTheme('pyAdventure', {
        base:'vs-dark', inherit:true,
        rules:[
          {token:'comment',foreground:'6272a4',fontStyle:'italic'},
          {token:'keyword',foreground:'ff79c6',fontStyle:'bold'},
          {token:'string',foreground:'f1fa8c'},
          {token:'number',foreground:'bd93f9'},
          {token:'function',foreground:'50fa7b'},
        ],
        colors:{
          'editor.background':'#0d0f1a',
          'editor.foreground':'#e8eaff',
          'editorLineNumber.foreground':'#3d4070',
          'editorLineNumber.activeForeground':'#7c5cfc',
          'editor.selectionBackground':'#44475a',
          'editor.lineHighlightBackground':'#1c1f3540',
          'editorCursor.foreground':'#7c5cfc',
        }
      });
      monacoEditor = monaco.editor.create(document.getElementById('editor-container'), {
        value: exercises[0].starterCode,
        language:'python', theme:'pyAdventure',
        fontSize:14, fontFamily:"'Fira Code', monospace", fontLigatures:true,
        minimap:{enabled:false}, scrollBeyondLastLine:false,
        lineNumbers:'on', automaticLayout:true, tabSize:4,
        wordWrap:'on', padding:{top:14,bottom:14},
        quickSuggestions:true,
      });
      resolve();
    });
  });
}

// â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSidebar() {
  const sb = document.getElementById('sidebar');
  let lastChap = null;
  exercises.forEach((ex, i) => {
    if (ex.chapter && ex.chapter !== lastChap) {
      const ct = document.createElement('div');
      ct.className = 'chapter-title';
      ct.textContent = ex.chapter;
      sb.appendChild(ct);
      lastChap = ex.chapter;
    }
    const btn = document.createElement('button');
    btn.className = 'exercise-btn' + (i===0?' active':'');
    btn.id = 'ex-btn-' + i;
    btn.innerHTML = `<div class="ex-num">${ex.id}</div><span style="flex:1">${ex.title.replace(`à¸‚à¹‰à¸­ ${ex.id} â€” `,'')}</span><span class="ex-check">âœ…</span>`;
    btn.onclick = () => selectExercise(i);
    sb.appendChild(btn);
  });
}

function updateSidebar() {
  exercises.forEach((_, i) => {
    const b = document.getElementById('ex-btn-' + i);
    if (b) b.className = 'exercise-btn' + (i===currentIdx?' active':'') + (completed.has(i)?' completed':'');
  });
}

// â”€â”€ EXERCISE SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectExercise(idx) {
  currentIdx = idx;
  const ex = exercises[idx];
  document.getElementById('problemBadge').textContent = ex.badge;
  document.getElementById('problemBadge').className = 'problem-badge ' + ex.badgeClass;
  document.getElementById('problemTitle').textContent = ex.title;
  document.getElementById('problemDesc').innerHTML = ex.desc;
  document.getElementById('hintText').textContent = ex.hint;
  document.getElementById('hintBox').style.display = 'none';
  document.getElementById('hintToggle').textContent = 'ğŸ’¡ à¹à¸ªà¸”à¸‡ hint';
  if (monacoEditor) monacoEditor.setValue(ex.starterCode);
  clearOutput();
  hideResult();
  document.getElementById('nextBtn').style.display = 'none';
  updateSidebar();
  updateProgress();
}

// â”€â”€ OUTPUT UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addLine(text, cls) {
  const el = document.getElementById('outputContent');
  const d = document.createElement('div');
  d.className = 'out-line' + (cls ? ' ' + cls : '');
  d.textContent = text;
  el.appendChild(d);
  el.scrollTop = el.scrollHeight;
}

function clearOutput() {
  document.getElementById('outputContent').innerHTML =
    '<div class="out-line out-sys">// à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸‚à¸­à¸‡à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸ˆà¸°à¹à¸ªà¸”à¸‡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ ğŸ¯</div>';
}

// â”€â”€ MANUAL INPUT (when no queue) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupInputHandling() {
  const f = document.getElementById('inputField');
  f.addEventListener('keydown', e => {
    if (e.key === 'Enter' && inputCallback) {
      const val = f.value;
      f.value = '';
      document.getElementById('inputContainer').classList.remove('active');
      const cb = inputCallback;
      inputCallback = null;
      cb(val);
    }
  });
}

function waitForInput() {
  return new Promise(resolve => {
    inputCallback = resolve;
    document.getElementById('inputContainer').classList.add('active');
    document.getElementById('inputField').focus();
  });
}

// â”€â”€ CORE EXECUTION ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Approach: pre-fill a Python-side list with the input values.
// Python's input() is replaced with a function that pops from that list.
// stdout is captured via io.StringIO.
// The whole thing runs synchronously (no async complications).

async function executePython(userCode, autoInputs) {
  // Store user code and inputs in pyodide globals to avoid escaping issues
  pyodide.globals.set('_user_code', userCode);

  // Build input list as Python list literal
  const pyInputList = '[' + autoInputs.map(v => JSON.stringify(String(v))).join(',') + ']';

  // If no auto inputs and code uses input(), we need interactive mode
  // For now, for auto-graded exercises all inputs are pre-supplied
  const pyScript = `
import sys, io, builtins, traceback

# â”€â”€ capture stdout â”€â”€
_out_buf = io.StringIO()
_old_stdout = sys.stdout
sys.stdout = _out_buf

# â”€â”€ patch input() â”€â”€
_input_vals = ${pyInputList}
_input_idx = [0]

def _fake_input(prompt=''):
    if prompt:
        print(prompt, end='')
    if _input_idx[0] < len(_input_vals):
        val = _input_vals[_input_idx[0]]
        _input_idx[0] += 1
        return val
    return ''

builtins.input = _fake_input

# â”€â”€ run user code â”€â”€
_err = None
try:
    exec(compile(_user_code, '<student>', 'exec'))
except SystemExit:
    pass
except Exception:
    _err = traceback.format_exc()

# â”€â”€ restore â”€â”€
sys.stdout = _old_stdout
builtins.input = input.__class__  # doesn't matter, we'll reset on next run

# â”€â”€ return result â”€â”€
_result = _out_buf.getvalue()
if _err:
    _result = '__ERR__' + _err
_result
`;

  const result = await pyodide.runPythonAsync(pyScript);
  return String(result || '');
}

// â”€â”€ RUN (display only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runCode() {
  if (!pyodideReady) return;
  const ex = exercises[currentIdx];
  const code = monacoEditor.getValue();
  clearOutput();
  hideResult();
  document.getElementById('nextBtn').style.display = 'none';
  setRunning(true);

  try {
    const raw = await executePython(code, ex.inputs || []);
    renderOutput(raw, ex.inputs || []);
  } catch(e) {
    addLine('âš ï¸ JS Error: ' + (e.message||e), 'out-err');
  } finally {
    setRunning(false);
  }
}

// â”€â”€ CHECK ANSWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAnswer() {
  if (!pyodideReady) return;
  const ex = exercises[currentIdx];
  const code = monacoEditor.getValue();
  clearOutput();
  hideResult();
  setRunning(true);

  let raw = '';
  try {
    raw = await executePython(code, ex.inputs || []);
  } catch(e) {
    raw = '__ERR__' + (e.message || e);
  } finally {
    setRunning(false);
  }

  renderOutput(raw, ex.inputs || []);

  if (raw.startsWith('__ERR__')) {
    showResult(false, ex.expected, 'à¸¡à¸µ Error à¹ƒà¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡');
    updateSidebar(); updateProgress();
    return;
  }

  // Compare: strip trailing whitespace from each line, then trim whole output
  const normalize = s => s.split('\n').map(l => l.trimEnd()).join('\n').trim();
  const got = normalize(raw);
  const want = normalize(ex.expected);
  const ok = got === want;

  if (ok && !completed.has(currentIdx)) {
    completed.add(currentIdx);
    score++;
    document.getElementById('scoreDisplay').textContent = score;
    showStarBurst();
  }

  showResult(ok, ex.expected, got);
  if (ok) document.getElementById('nextBtn').style.display =
    currentIdx < exercises.length - 1 ? 'flex' : 'none';
  updateSidebar(); updateProgress();
}

// â”€â”€ RENDER OUTPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOutput(raw, autoInputs) {
  if (raw.startsWith('__ERR__')) {
    const msg = raw.replace('__ERR__', '');
    // Show the most relevant error line
    const lines = msg.trim().split('\n');
    const errLine = lines.filter(l => /Error/.test(l)).pop() || lines[lines.length-1];
    addLine('âš ï¸ ' + errLine.trim(), 'out-err');
    return;
  }

  // Show auto-inputs as info lines first
  if (autoInputs.length > 0) {
    autoInputs.forEach(v => addLine('â†’ input: ' + v, 'out-inp'));
  }

  const lines = raw.split('\n');
  // Remove trailing empty line that print() adds
  if (lines.length > 0 && lines[lines.length-1] === '') lines.pop();
  if (lines.length === 0) {
    addLine('(à¹„à¸¡à¹ˆà¸¡à¸µ output)', 'out-sys');
  } else {
    lines.forEach(l => addLine(l, ''));
  }
}

// â”€â”€ RESULT DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult(ok, expected, got) {
  const panel = document.getElementById('resultPanel');
  const inner = document.getElementById('resultInner');
  if (ok) {
    inner.innerHTML = `<div class="result-correct">
      <div class="result-icon">ğŸ‰</div>
      <div>
        <div class="result-msg" style="color:var(--green)">à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡! à¸¢à¸­à¸”à¹€à¸¢à¸µà¹ˆà¸¢à¸¡à¸¡à¸²à¸! ğŸŒŸ</div>
        <div class="result-sub">Output: "${expected.replace(/\n/g,' | ')}"</div>
      </div></div>`;
  } else {
    inner.innerHTML = `<div class="result-wrong">
      <div class="result-icon">ğŸ¤”</div>
      <div>
        <div class="result-msg" style="color:var(--red)">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¹à¸ à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸™à¸°!</div>
        <div class="result-sub">à¸„à¸²à¸”à¸«à¸§à¸±à¸‡: "${expected.replace(/\n/g,' | ')}"  |  à¹„à¸”à¹‰: "${String(got||'').replace(/\n/g,' | ').substring(0,60)}"</div>
      </div></div>`;
  }
  panel.classList.add('show');
}

function hideResult() {
  document.getElementById('resultPanel').classList.remove('show');
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setRunning(on) {
  document.getElementById('runBtn').disabled = on;
  document.getElementById('checkBtn').disabled = on;
  document.getElementById('runSpinner').style.display = on ? 'inline' : 'none';
}

function toggleHint() {
  const box = document.getElementById('hintBox');
  const btn = document.getElementById('hintToggle');
  const show = box.style.display === 'none';
  box.style.display = show ? 'flex' : 'none';
  btn.textContent = show ? 'ğŸ™ˆ à¸‹à¹ˆà¸­à¸™ hint' : 'ğŸ’¡ à¹à¸ªà¸”à¸‡ hint';
}

function nextExercise() {
  if (currentIdx < exercises.length - 1) selectExercise(currentIdx + 1);
}

function updateProgress() {
  document.getElementById('progressFill').style.width =
    (completed.size / exercises.length * 100) + '%';
}

function showStarBurst() {
  const stars = ['â­','ğŸŒŸ','âœ¨','ğŸ‰','ğŸŠ','ğŸ’«'];
  for (let i = 0; i < 6; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'star-burst';
      el.textContent = stars[Math.floor(Math.random()*stars.length)];
      el.style.left = (15 + Math.random()*70)+'vw';
      el.style.top = (15 + Math.random()*70)+'vh';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }, i * 100);
  }
}

// â”€â”€ JSON LOADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const DEFAULT_JSON_URL = 'https://raw.githubusercontent.com/Karibura-Cyber/python-playground/refs/heads/main/exercises.json';

function validateExercise(ex) {
  const required = ['id','title','badge','badgeClass','desc','hint','starterCode','expected'];
  for (const f of required) {
    if (ex[f] === undefined || ex[f] === null) return `à¸‚à¸²à¸” field: "${f}"`;
  }
  if (typeof ex.id !== 'number') return `"id" à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚`;
  if (!Array.isArray(ex.inputs)) ex.inputs = [];
  if (!ex.type) ex.type = 'custom';
  if (ex.chapter === undefined) ex.chapter = null;
  return null;
}

function mergeExercises(newExs) {
  const existingIds = new Set(exercises.map(e => e.id));
  let added = 0, skipped = 0, errors = [];
  newExs.forEach((ex, i) => {
    const err = validateExercise(ex);
    if (err) { errors.push(`à¸‚à¹‰à¸­ ${i+1}: ${err}`); return; }
    if (existingIds.has(ex.id)) { skipped++; return; }
    exercises.push(ex);
    existingIds.add(ex.id);
    added++;
  });
  return { added, skipped, errors };
}

function rebuildAfterMerge() {
  document.getElementById('sidebar').innerHTML = '';
  buildSidebar();
  document.getElementById('totalDisplay').textContent = exercises.length;
  // If no exercise is selected yet (idx 0 might not exist), select first
  if (exercises.length > 0 && document.getElementById('problemTitle').textContent === '') {
    selectExercise(0);
  }
  updateProgress();
}

// â”€â”€ TOAST SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _toastId = 0;

function showToast(msg, type = 'info', duration = 4000) {
  // type: 'ok' | 'err' | 'info'
  const container = document.getElementById('toast-container');
  const id = ++_toastId;

  const icons = { ok: 'âœ“', err: 'âœ•', info: 'â„¹' };

  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.id = `toast-${id}`;
  el.innerHTML = `
    <span class="toast-icon">${icons[type] || icons.info}</span>
    <span class="toast-msg">${msg}</span>
    <button class="toast-close" onclick="dismissToast(${id})">âœ•</button>`;

  container.appendChild(el);

  // Trigger enter animation
  requestAnimationFrame(() => requestAnimationFrame(() => el.classList.add('show')));

  // Auto dismiss
  const timer = setTimeout(() => dismissToast(id), duration);
  el._timer = timer;

  return id;
}

function dismissToast(id) {
  const el = document.getElementById(`toast-${id}`);
  if (!el) return;
  clearTimeout(el._timer);
  el.classList.remove('show');
  el.classList.add('hide');
  setTimeout(() => el.remove(), 280);
}

// Legacy alias used by save/load functions
function showJsonStatus(msg, isOk) {
  showToast(msg, isOk ? 'ok' : 'err');
}

async function loadDefaultJson() {
  const btn = document.getElementById('reloadJsonBtn');
  if (btn) { btn.textContent = 'â³ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...'; btn.disabled = true; }
  try {
    const res = await fetch(DEFAULT_JSON_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('JSON à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ array');

    // Validate each exercise
    const errors = [];
    const valid = [];
    data.forEach((ex, i) => {
      const err = validateExercise(ex);
      if (err) { errors.push(`à¸‚à¹‰à¸­ ${i+1}: ${err}`); return; }
      valid.push(ex);
    });

    // Replace exercises with data from JSON (keep any extra loaded from file)
    // Filter out exercises whose id exists in the new JSON, then push new ones
    const newIds = new Set(valid.map(e => e.id));
    exercises = exercises.filter(e => !newIds.has(e.id)); // remove old versions
    exercises.push(...valid);
    // Sort by id
    exercises.sort((a, b) => a.id - b.id);

    rebuildAfterMerge();

    if (errors.length > 0) {
      showToast(`à¹‚à¸«à¸¥à¸”à¹à¸¥à¹‰à¸§ ${valid.length} à¸‚à¹‰à¸­ â€” âš ï¸ ${errors.length} error`, 'err');
    }
    return valid.length;
  } catch(e) {
    showToast('âŒ à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œà¹„à¸¡à¹ˆà¹„à¸”à¹‰: ' + e.message, 'err');
    return 0;
  } finally {
    if (btn) { btn.textContent = 'ğŸ”„ à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œ'; btn.disabled = false; }
  }
}

function loadFromFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  event.target.value = '';
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error('JSON à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ array');
      const { added, skipped, errors } = mergeExercises(data);
      rebuildAfterMerge();
      let msg = `"${file.name}": +${added} à¸‚à¹‰à¸­`;
      if (skipped > 0) msg += ` (à¸‹à¹‰à¸³ ${skipped})`;
      showToast(msg, errors.length === 0 ? 'ok' : 'err');
    } catch(e) {
      showToast('âŒ ' + e.message, 'err');
    }
  };
  reader.onerror = () => showToast('âŒ à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œà¹„à¸¡à¹ˆà¹„à¸”à¹‰', 'err');
  reader.readAsText(file, 'UTF-8');
}

// â”€â”€ SAVE / LOAD PROGRESS (.mxr) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// .mxr format: base64-encoded JSON with a magic header

const MXR_MAGIC = 'PYADVMXR1';

function collectCurrentCode() {
  // Save current editor code for the active exercise
  return monacoEditor ? monacoEditor.getValue() : '';
}

function saveProgress() {
  document.getElementById('saveModal').style.display = 'flex';
  setTimeout(() => document.getElementById('saveNameInput').focus(), 50);
}

function closeSaveModal() {
  document.getElementById('saveModal').style.display = 'none';
}

function confirmSave() {
  const studentName = document.getElementById('saveNameInput').value.trim() || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­';
  closeSaveModal();

  // Build snapshot
  const snapshot = {
    magic: MXR_MAGIC,
    version: 1,
    savedAt: new Date().toISOString(),
    studentName,
    score,
    currentIdx,
    completed: [...completed],         // array of completed exercise indices
    // Save code per exercise id: { [id]: code }
    codes: {},
  };

  // Save current editor content for current exercise
  if (monacoEditor) {
    snapshot.codes[exercises[currentIdx].id] = monacoEditor.getValue();
  }

  // Encode to base64
  const json = JSON.stringify(snapshot);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  const blob = new Blob([b64], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);

  // Generate filename: progress_NAME_DATE.mxr
  const dateStr = new Date().toISOString().slice(0,10);
  const safeName = studentName.replace(/[^a-zA-Z0-9à¸-à¹™]/g, '_').substring(0,20);
  const filename = `progress_${safeName}_${dateStr}.mxr`;

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);

  showJsonStatus(`ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§: ${filename}`, true);
}

function loadProgress(event) {
  const file = event.target.files[0];
  if (!file) return;
  event.target.value = '';

  if (!file.name.endsWith('.mxr')) {
    showJsonStatus('âŒ à¹„à¸Ÿà¸¥à¹Œà¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ .mxr', false);
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      // Decode base64
      const b64 = e.target.result.trim();
      const json = decodeURIComponent(escape(atob(b64)));
      const snapshot = JSON.parse(json);

      // Validate magic
      if (snapshot.magic !== MXR_MAGIC) throw new Error('à¹„à¸Ÿà¸¥à¹Œà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸«à¸£à¸·à¸­à¹€à¸ªà¸µà¸¢à¸«à¸²à¸¢');

      // Restore state
      score = snapshot.score || 0;
      completed.clear();
      (snapshot.completed || []).forEach(i => completed.add(i));

      document.getElementById('scoreDisplay').textContent = score;

      // Restore codes if available
      if (snapshot.codes && snapshot.currentIdx !== undefined) {
        const targetIdx = Math.min(snapshot.currentIdx, exercises.length - 1);
        selectExercise(targetIdx);

        // Restore code for current exercise
        const exId = exercises[targetIdx].id;
        if (snapshot.codes[exId] && monacoEditor) {
          monacoEditor.setValue(snapshot.codes[exId]);
        }
      }

      updateSidebar();
      updateProgress();

      const savedDate = snapshot.savedAt ? new Date(snapshot.savedAt).toLocaleDateString('th-TH') : '?';
      showJsonStatus(`ğŸ“‚ à¹‚à¸«à¸¥à¸”à¹à¸¥à¹‰à¸§: ${snapshot.studentName} | ${score} à¸„à¸°à¹à¸™à¸™ | ${savedDate}`, true);

    } catch(e) {
      showJsonStatus('âŒ à¹‚à¸«à¸¥à¸”à¹„à¸¡à¹ˆà¹„à¸”à¹‰: ' + e.message, false);
    }
  };
  reader.onerror = () => showJsonStatus('âŒ à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œà¹„à¸¡à¹ˆà¹„à¸”à¹‰', false);
  reader.readAsText(file, 'UTF-8');
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  setupInputHandling();

  // à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œà¸ˆà¸²à¸ JSON à¸à¹ˆà¸­à¸™ à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸­à¸¢ render UI
  await loadDefaultJson();

  // à¸–à¹‰à¸²à¹‚à¸«à¸¥à¸”à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸¢ à¹à¸ªà¸”à¸‡ placeholder
  if (exercises.length === 0) {
    document.getElementById('sidebar').innerHTML =
      '<div style="padding:20px;color:var(--text2);font-size:0.8rem;text-align:center">âš ï¸ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¹‚à¸ˆà¸—à¸¢à¹Œ<br>à¸à¸” "à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œ" à¸«à¸£à¸·à¸­ "à¹€à¸à¸´à¹ˆà¸¡à¹‚à¸ˆà¸—à¸¢à¹Œ"</div>';
    document.getElementById('problemTitle').textContent = 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¹‚à¸ˆà¸—à¸¢à¹Œ';
    document.getElementById('problemDesc').textContent = 'à¸à¸” "à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œ" à¸—à¸µà¹ˆ navbar à¹€à¸à¸·à¹ˆà¸­à¹‚à¸«à¸¥à¸”à¸ˆà¸²à¸ GitHub à¸«à¸£à¸·à¸­ "à¹€à¸à¸´à¹ˆà¸¡à¹‚à¸ˆà¸—à¸¢à¹Œ" à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¹„à¸Ÿà¸¥à¹Œ JSON à¸‚à¸­à¸‡à¸„à¸¸à¸“';
  } else {
    buildSidebar();
    selectExercise(0);
  }

  document.getElementById('totalDisplay').textContent = exercises.length;

  // à¹‚à¸«à¸¥à¸” Pyodide à¸„à¸§à¸šà¸„à¸¹à¹ˆà¸à¸±à¸™
  loadPyodideEngine();
})();
</script>
</body>
</html>
