<!DOCTYPE html>
<html lang="th" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ Python Adventure â€” à¹€à¸£à¸µà¸¢à¸™ Python à¸ªà¸™à¸¸à¸à¹†</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* Dark palette â€” neon terminal */
  --bg:         #0a0b12;
  --bg2:        #0f1118;
  --surface:    #13151f;
  --surface2:   #1a1d2e;
  --surface3:   #22253a;
  --surface4:   #2c3050;

  --accent:     #6e56cf;
  --accent-hi:  #9d7eff;
  --neon:       #3df5c1;
  --neon-dim:   #1fa87c;
  --amber:      #f5b942;
  --rose:       #f54b7a;
  --sky:        #42c8f5;

  --text:       #e5e8ff;
  --text2:      #7a7fa8;
  --text3:      #4a4f70;
  --border:     rgba(110, 86, 207, 0.18);
  --border2:    rgba(255,255,255,0.05);

  --r-xs: 4px; --r-sm: 8px; --r-md: 12px; --r-lg: 16px; --r-xl: 24px;
  --shadow-glow: 0 0 40px rgba(110, 86, 207, 0.25);
  --shadow-card: 0 4px 24px rgba(0,0,0,0.4);
  --sidebar-w: 268px;
  --header-h: 54px;
  --font-mono: 'Noto Sans Thai', sans-serif;
}

[data-theme="light"] {
  --bg:         #f1f2f9;
  --bg2:        #f8f9ff;
  --surface:    #ffffff;
  --surface2:   #eef0fa;
  --surface3:   #e4e7f5;
  --surface4:   #d8dcf0;

  --accent:     #5e40cc;
  --accent-hi:  #7c5aef;
  --neon:       #0d9a6e;
  --neon-dim:   #0b7a57;
  --amber:      #d97706;
  --rose:       #dc2626;
  --sky:        #0284c7;

  --text:       #1c1e30;
  --text2:      #5a5f82;
  --text3:      #9498ba;
  --border:     rgba(94, 64, 204, 0.14);
  --border2:    rgba(0,0,0,0.06);
  --shadow-card: 0 4px 24px rgba(0,0,0,0.08);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px}
body{
  font-family:'Noto Sans Thai',sans-serif;
  color:var(--text);
  min-height:100vh;
  overflow:hidden;
  font-size:14px;
  line-height:1.6;
}

/* Animated background grid */
body::before{
  content:'';
  position:fixed;inset:0;
  background-image:
    linear-gradient(rgba(110,86,207,0.04) 1px,transparent 1px),
    linear-gradient(90deg,rgba(110,86,207,0.04) 1px,transparent 1px);
  background-size:32px 32px;
  pointer-events:none;z-index:0;
}
body::after{
  content:'';
  position:fixed;inset:0;
  background:radial-gradient(ellipse 80% 50% at 50% -20%,rgba(110,86,207,0.12),transparent);
  pointer-events:none;z-index:0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLLBARS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--surface4);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loadingOverlay{
  position:fixed;inset:0;
  background:var(--bg);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:20px;z-index:2000;
  transition:opacity 0.6s ease;
}
.load-snake{font-size:56px;animation:loadBounce 0.9s ease-in-out infinite}
@keyframes loadBounce{0%,100%{transform:translateY(0) rotate(-10deg)}50%{transform:translateY(-12px) rotate(10deg)}}
.load-brand{
  font-family:'Noto Sans Thai',sans-serif;
  font-size:2.2rem;font-weight:800;
  background:linear-gradient(135deg,var(--accent-hi),var(--neon));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  letter-spacing:-1px;
}
.load-bar{
  width:240px;height:4px;
  background:var(--surface3);
  border-radius:4px;overflow:hidden;
}
.load-fill{
  height:100%;
  background:linear-gradient(90deg,var(--accent),var(--neon));
  border-radius:4px;
  transition:width 0.35s cubic-bezier(0.4,0,0.2,1);
}
.load-txt{font-size:0.78rem;color:var(--text2)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#appHeader{
  position:relative;z-index:100;
  height:var(--header-h);
  background:var(--surface);
  border-bottom:1px solid var(--border2);
  display:flex;align-items:center;gap:8px;
  padding:0 16px;
  box-shadow:0 1px 0 var(--border);
  flex-shrink:0;
}
.brand{display:flex;align-items:center;gap:10px;margin-right:4px}
.brand-icon{
  width:32px;height:32px;
  background:linear-gradient(135deg,var(--accent),var(--accent-hi));
  border-radius:var(--r-sm);
  display:flex;align-items:center;justify-content:center;
  font-size:16px;
  box-shadow:0 4px 12px rgba(110,86,207,0.4);
  flex-shrink:0;
  animation:iconPulse 4s ease-in-out infinite;
}
@keyframes iconPulse{0%,100%{box-shadow:0 4px 12px rgba(110,86,207,0.4)}50%{box-shadow:0 4px 20px rgba(110,86,207,0.7)}}
.brand-name{
  font-family:'Noto Sans Thai',sans-serif;
  font-size:1rem;font-weight:800;
  letter-spacing:-0.3px;
  color:var(--text);
}
.vsep{width:1px;height:20px;background:var(--border2);margin:0 4px;flex-shrink:0}

/* Python status */
.py-badge{
  display:flex;align-items:center;gap:6px;
  padding:4px 10px;
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:20px;
  font-size:0.72rem;font-weight:600;
}
.py-dot{
  width:7px;height:7px;border-radius:50%;
  background:var(--amber);
  animation:dotPulse 1.2s ease-in-out infinite;
}
.py-dot.ready{background:var(--neon);animation:none}
.py-dot.error{background:var(--rose);animation:none}
@keyframes dotPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.3;transform:scale(0.7)}}

/* Score chip */
.score-chip{
  margin-left:auto;
  display:flex;align-items:center;gap:8px;
  padding:5px 14px;
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:20px;
  font-size:0.78rem;
}
.score-chip .score-num{
  font-family:'Noto Sans Thai',sans-serif;
  font-size:1rem;font-weight:800;
  color:var(--amber);
}
.score-chip .score-sep{color:var(--text3)}
.score-chip .score-total{color:var(--text2);font-size:0.8rem}

/* Header action buttons */
.hbtn{
  display:flex;align-items:center;gap:6px;
  padding:5px 11px;
  border-radius:var(--r-sm);
  border:1px solid transparent;
  background:transparent;
  color:var(--text2);
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.73rem;font-weight:600;
  cursor:pointer;
  transition:all 0.15s;
  white-space:nowrap;
}
.hbtn:hover{background:var(--surface2);color:var(--text);border-color:var(--border)}
.hbtn:disabled{opacity:0.4;cursor:not-allowed}
.hbtn svg{flex-shrink:0}
.hbtn-green:hover{color:var(--neon);border-color:rgba(61,245,193,0.2)!important}
.hbtn-purple:hover{color:var(--accent-hi);border-color:var(--border)!important}
.hbtn-amber:hover{color:var(--amber);border-color:rgba(245,185,66,0.2)!important}
.hbtn-sky:hover{color:var(--sky);border-color:rgba(66,200,245,0.2)!important}

/* Progress bar (thin top strip) */
#progressBar{
  height:2px;background:var(--surface3);
  position:relative;z-index:99;flex-shrink:0;
}
#progressFill{
  height:100%;
  background:linear-gradient(90deg,var(--accent),var(--neon));
  transition:width 0.5s ease;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{
  display:grid;
  grid-template-columns:var(--sidebar-w) 1fr;
  height:calc(100vh - var(--header-h) - 2px);
  position:relative;z-index:1;
  overflow:hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sidebar{
  background:var(--surface);
  border-right:1px solid var(--border2);
  display:flex;flex-direction:column;
  overflow:hidden;
}
.sidebar-inner{flex:1;overflow-y:auto;padding:8px 0 12px}
.chapter-header{
  display:flex;align-items:center;gap:8px;
  padding:10px 14px 6px;
  font-size:0.65rem;font-weight:700;
  text-transform:uppercase;letter-spacing:1.5px;
  color:var(--text3);
  cursor:pointer;
  user-select:none;
  position:sticky;top:0;
  background:var(--surface);
  z-index:2;
  transition:color 0.15s;
}
.chapter-header:hover{color:var(--text2)}
.chapter-line{flex:1;height:1px;background:var(--border2)}
.chapter-caret{
  font-size:0.55rem;
  transition:transform 0.2s;
  opacity:0.5;
}
.chapter-group.collapsed .chapter-caret{transform:rotate(-90deg)}
.chapter-items{overflow:hidden;max-height:9999px;transition:max-height 0.25s ease,opacity 0.2s}
.chapter-group.collapsed .chapter-items{max-height:0;opacity:0}

/* Exercise button */
.ex-btn{
  width:100%;padding:8px 14px 8px 12px;
  background:transparent;border:none;border-left:3px solid transparent;
  display:flex;align-items:center;gap:10px;
  text-align:left;cursor:pointer;
  transition:all 0.12s;
  color:var(--text2);
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.8rem;
}
.ex-btn:hover{background:var(--surface2);color:var(--text);border-left-color:var(--surface4)}
.ex-btn.active{
  background:linear-gradient(90deg,rgba(110,86,207,0.12),transparent);
  color:var(--text);
  border-left-color:var(--accent);
}
.ex-num{
  width:26px;height:26px;border-radius:var(--r-sm);
  background:var(--surface3);
  display:flex;align-items:center;justify-content:center;
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.68rem;font-weight:600;
  flex-shrink:0;
  transition:all 0.2s;
  color:var(--text2);
}
.ex-btn.active .ex-num{background:var(--accent);color:#fff}
.ex-btn.done .ex-num{background:var(--neon);color:#0a0b12}
.ex-title{flex:1;line-height:1.4}
.ex-check{font-size:0.75rem;opacity:0;transition:opacity 0.2s;color:var(--neon)}
.ex-btn.done .ex-check{opacity:1}

/* Sidebar footer */
.sidebar-footer{
  padding:10px 12px;
  border-top:1px solid var(--border2);
  flex-shrink:0;
}
.sidebar-stats{
  display:grid;grid-template-columns:1fr 1fr;gap:6px;
}
.stat-card{
  padding:8px 10px;
  background:var(--surface2);
  border-radius:var(--r-sm);
  border:1px solid var(--border);
  text-align:center;
}
.stat-card .stat-val{
  font-family:'Noto Sans Thai',sans-serif;
  font-size:1.2rem;font-weight:800;
  color:var(--accent-hi);
  display:block;
}
.stat-card .stat-lbl{font-size:0.66rem;color:var(--text3);margin-top:1px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#main{
  display:flex;flex-direction:column;
  overflow:hidden;
}

/* Problem panel */
#problemPanel{
  background:var(--surface);
  border-bottom:1px solid var(--border2);
  padding:14px 20px;
  flex-shrink:0;
  overflow-y:auto;
  min-height:64px;
  max-height:40vh;
}
.prob-top{display:flex;align-items:flex-start;gap:12px;margin-bottom:8px}
.prob-badge{
  display:inline-flex;align-items:center;gap:5px;
  padding:3px 10px;
  border-radius:20px;
  font-size:0.67rem;font-weight:700;
  text-transform:uppercase;letter-spacing:0.8px;
  flex-shrink:0;margin-top:2px;
}
.badge-print{background:rgba(66,200,245,0.12);color:var(--sky);border:1px solid rgba(66,200,245,0.25)}
.badge-var{background:rgba(245,185,66,0.12);color:var(--amber);border:1px solid rgba(245,185,66,0.25)}
.badge-input{background:rgba(61,245,193,0.12);color:var(--neon);border:1px solid rgba(61,245,193,0.25)}
.badge-condition{background:rgba(245,75,122,0.12);color:var(--rose);border:1px solid rgba(245,75,122,0.25)}
.badge-loop{background:rgba(157,126,255,0.12);color:var(--accent-hi);border:1px solid rgba(157,126,255,0.25)}
.badge-func{background:rgba(245,185,66,0.12);color:var(--amber);border:1px solid rgba(245,185,66,0.25)}
.prob-title{font-size:0.98rem;font-weight:700;color:var(--text);line-height:1.4}
.prob-desc{font-size:0.82rem;color:var(--text2);line-height:1.65}
.prob-desc code{
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.78rem;
  background:var(--surface3);
  padding:1px 5px;border-radius:4px;
  color:var(--neon);
}
.hint-row{margin-top:10px}
.hint-btn{
  background:none;
  border:1px dashed rgba(110,86,207,0.35);
  color:var(--accent-hi);
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.72rem;font-weight:600;
  padding:4px 12px;border-radius:20px;
  cursor:pointer;
  transition:all 0.15s;
}
.hint-btn:hover{background:rgba(110,86,207,0.1);border-style:solid}
.hint-box{
  margin-top:8px;padding:10px 14px;
  background:rgba(110,86,207,0.08);
  border:1px solid rgba(110,86,207,0.2);
  border-radius:var(--r-sm);
  font-size:0.8rem;color:var(--accent-hi);
  display:none;
  gap:8px;align-items:flex-start;
  line-height:1.6;
}
.hint-box.show{display:flex}

/* Resize handle */
#resizer{
  height:5px;
  background:var(--border2);
  cursor:ns-resize;
  flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  transition:background 0.15s;
}
#resizer:hover,#resizer.active{background:var(--accent)}
#resizer::after{
  content:'';
  width:28px;height:2px;
  border-radius:1px;
  background:var(--text3);
  opacity:0.5;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDITOR AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.editor-area{
  display:grid;
  grid-template-columns:1fr 1fr;
  flex:1;min-height:0;
  overflow:hidden;
}
.editor-pane{
  display:flex;flex-direction:column;
  border-right:1px solid var(--border2);
  overflow:hidden;
  background:var(--bg);
}
.pane-head{
  padding:7px 14px;
  background:var(--surface);
  border-bottom:1px solid var(--border2);
  font-size:0.72rem;font-weight:600;
  color:var(--text2);
  display:flex;align-items:center;gap:8px;
  flex-shrink:0;
}
.macos-dots{display:flex;gap:5px}
.macos-dot{width:10px;height:10px;border-radius:50%}
.pane-filename{color:var(--text);font-family:'Noto Sans Thai',sans-serif;font-size:0.75rem}
.pane-lang{
  margin-left:auto;
  font-size:0.65rem;
  padding:2px 6px;
  background:var(--surface3);
  border-radius:4px;
  color:var(--text3);
}
#editorContainer{flex:1;overflow:hidden}

/* Output pane */
.output-pane{
  display:flex;flex-direction:column;
  background:var(--bg2);
  overflow:hidden;
}
#outputContent{
  flex:1;
  padding:14px 16px;
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.78rem;
  line-height:1.75;
  overflow-y:auto;
  color:var(--text);
}
.ol{white-space:pre-wrap;word-break:break-all;margin-bottom:1px}
.ol-sys{color:var(--text3);font-style:italic}
.ol-err{color:var(--rose)}
.ol-inp{color:var(--sky)}
.ol-ok{color:var(--neon)}

/* stdin input row */
#inputRow{
  display:none;
  align-items:center;gap:0;
  border-top:1px solid rgba(66,200,245,0.2);
  background:rgba(66,200,245,0.05);
  flex-shrink:0;
}
#inputRow.show{display:flex}
.input-prompt{
  padding:8px 12px;
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.78rem;
  color:var(--sky);
  border-right:1px solid rgba(66,200,245,0.2);
  flex-shrink:0;
}
#stdinInput{
  flex:1;padding:8px 12px;
  background:transparent;border:none;outline:none;
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.78rem;color:var(--text);
}
#stdinInput::placeholder{color:var(--text3)}

/* Result panel */
#resultPanel{
  max-height:0;overflow:hidden;
  transition:max-height 0.35s cubic-bezier(0.4,0,0.2,1);
  background:var(--surface);
  border-top:1px solid var(--border2);
  flex-shrink:0;
}
#resultPanel.show{max-height:200px}
.result-inner{padding:12px 20px}
.result-pass{
  display:flex;align-items:flex-start;gap:14px;
  padding:12px 16px;
  background:rgba(61,245,193,0.07);
  border:1px solid rgba(61,245,193,0.2);
  border-radius:var(--r-sm);
}
.result-fail{
  display:flex;flex-direction:column;gap:8px;
  padding:12px 16px;
  background:rgba(245,75,122,0.07);
  border:1px solid rgba(245,75,122,0.2);
  border-radius:var(--r-sm);
}
.result-icon{font-size:1.5rem;flex-shrink:0;line-height:1}
.result-title{font-weight:700;font-size:0.9rem}
.result-sub{font-size:0.74rem;color:var(--text2);margin-top:2px;font-family:'Noto Sans Thai',sans-serif;line-height:1.5}
.tc-row{
  display:flex;align-items:center;gap:8px;
  font-size:0.76rem;padding:2px 0;
  flex-wrap:wrap;
}
.tc-pass{color:var(--neon)}
.tc-fail{color:var(--rose)}
.tc-label{color:var(--text2)}
.tc-code{
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.72rem;
  padding:0 4px;
  border-radius:3px;
}
.tc-exp{background:rgba(61,245,193,0.1);color:var(--neon)}
.tc-got{background:rgba(245,75,122,0.1);color:var(--rose)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTION BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#actionBar{
  padding:10px 16px;
  background:var(--surface);
  border-top:1px solid var(--border2);
  display:flex;align-items:center;gap:8px;
  flex-shrink:0;
}
.abtn{
  display:inline-flex;align-items:center;gap:7px;
  padding:8px 18px;
  border-radius:var(--r-sm);
  border:none;cursor:pointer;
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.83rem;font-weight:700;
  transition:all 0.2s;
}
.abtn:disabled{opacity:0.45;cursor:not-allowed;transform:none!important}
.abtn-run{
  background:linear-gradient(135deg,var(--accent),var(--accent-hi));
  color:#fff;
  box-shadow:0 4px 16px rgba(110,86,207,0.35);
}
.abtn-run:not(:disabled):hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(110,86,207,0.5)}
.abtn-check{
  background:linear-gradient(135deg,var(--neon-dim),var(--neon));
  color:#0a0b12;
  box-shadow:0 4px 16px rgba(61,245,193,0.25);
}
.abtn-check:not(:disabled):hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(61,245,193,0.4)}
.abtn-clear{
  background:var(--surface2);
  color:var(--text2);
  border:1px solid var(--border);
}
.abtn-clear:hover{background:var(--surface3);color:var(--text)}
.abtn-next{
  margin-left:auto;
  background:linear-gradient(135deg,var(--amber) 0%,#f5742b 100%);
  color:#0a0b12;
  box-shadow:0 4px 16px rgba(245,185,66,0.3);
  display:none;
}
.abtn-next:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(245,185,66,0.45)}
.run-spinner{display:none;margin-left:auto;animation:spin 0.8s linear infinite;font-size:0.9rem}
@keyframes spin{to{transform:rotate(360deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST NOTIFICATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toastContainer{
  position:fixed;bottom:20px;right:20px;
  z-index:9000;
  display:flex;flex-direction:column;gap:8px;align-items:flex-end;
  pointer-events:none;
}
.toast{
  display:flex;align-items:flex-start;gap:10px;
  padding:10px 14px;
  border-radius:var(--r-sm);
  font-size:0.78rem;font-weight:600;
  background:var(--surface2);
  border:1px solid var(--border2);
  box-shadow:var(--shadow-card);
  pointer-events:auto;
  max-width:320px;
  transform:translateX(120%);opacity:0;
  transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1),opacity 0.3s ease;
}
.toast.in{transform:translateX(0);opacity:1}
.toast.out{transform:translateX(120%);opacity:0;transition:transform 0.2s,opacity 0.2s}
.toast-ok{border-left:3px solid var(--neon);color:var(--neon)}
.toast-err{border-left:3px solid var(--rose);color:var(--rose)}
.toast-info{border-left:3px solid var(--sky);color:var(--sky)}
.toast-msg{flex:1;color:var(--text);line-height:1.4}
.toast-x{
  background:none;border:none;cursor:pointer;
  color:var(--text3);font-size:0.9rem;
  padding:0 0 0 4px;transition:color 0.15s;
}
.toast-x:hover{color:var(--text)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVE MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-bg{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.7);
  backdrop-filter:blur(6px);
  z-index:500;
  display:none;
  align-items:center;justify-content:center;
}
.modal-bg.show{display:flex}
.modal-box{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--r-xl);
  padding:28px;
  width:380px;
  box-shadow:var(--shadow-glow);
  animation:modalIn 0.25s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes modalIn{from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
.modal-title{font-size:1.05rem;font-weight:800;margin-bottom:6px}
.modal-sub{font-size:0.8rem;color:var(--text2);line-height:1.5;margin-bottom:20px}
.modal-label{font-size:0.75rem;color:var(--text2);margin-bottom:5px;display:block}
.modal-input{
  width:100%;padding:9px 12px;
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:var(--r-sm);
  color:var(--text);
  font-family:'Noto Sans Thai',sans-serif;
  font-size:0.85rem;outline:none;
  transition:border-color 0.15s;
}
.modal-input:focus{border-color:var(--accent)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}
.modal-btn{
  padding:8px 18px;border-radius:var(--r-sm);border:none;
  cursor:pointer;font-family:'Noto Sans Thai',sans-serif;
  font-size:0.83rem;font-weight:700;transition:all 0.15s;
}
.modal-primary{
  background:linear-gradient(135deg,var(--accent),var(--accent-hi));
  color:#fff;
}
.modal-primary:hover{transform:translateY(-1px)}
.modal-cancel{
  background:var(--surface3);color:var(--text2);
  border:1px solid var(--border);
}
.modal-cancel:hover{background:var(--surface4)}

/* Confetti burst */
.confetti{
  position:fixed;pointer-events:none;z-index:9999;
  font-size:1.8rem;
  animation:confettiBurst 1.1s ease forwards;
}
@keyframes confettiBurst{
  0%{transform:scale(0) translateY(0) rotate(0deg);opacity:1}
  100%{transform:scale(1.4) translateY(-90px) rotate(720deg);opacity:0}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:860px){
  #app{grid-template-columns:1fr}
  #sidebar{display:none}
  .editor-area{grid-template-columns:1fr;grid-template-rows:1fr 1fr}
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingOverlay">
  <div class="load-snake">ğŸ</div>
  <div class="load-brand">Python Adventure</div>
  <div class="load-bar"><div class="load-fill" id="loadFill" style="width:0%"></div></div>
  <div class="load-txt" id="loadTxt">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸” Pyodide...</div>
</div>

<!-- HEADER -->
<header id="appHeader">
  <div class="brand">
    <div class="brand-icon">ğŸ</div>
    <span class="brand-name">Python Adventure</span>
  </div>
  <div class="vsep"></div>

  <!-- Status -->
  <div class="py-badge">
    <div class="py-dot" id="pyDot"></div>
    <span id="pyStatus">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</span>
  </div>

  <!-- Score -->
  <div class="score-chip" id="scoreChip">
    <span>â­</span>
    <span class="score-num" id="scoreNum">0</span>
    <span class="score-sep">/</span>
    <span class="score-total" id="scoreTotal">0</span>
    <span style="color:var(--text3);font-size:0.72rem">à¸„à¸°à¹à¸™à¸™</span>
  </div>

  <div class="vsep"></div>

  <!-- Load exercises -->
  <button class="hbtn hbtn-sky" id="reloadBtn" onclick="loadDefaultJson()" title="à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œà¸ˆà¸²à¸ GitHub">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.12"/></svg>
    à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œ
  </button>
  <button class="hbtn hbtn-purple" onclick="document.getElementById('jsonFileIn').click()" title="à¹€à¸à¸´à¹ˆà¸¡à¹‚à¸ˆà¸—à¸¢à¹Œà¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œ">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
    à¹€à¸à¸´à¹ˆà¸¡à¹‚à¸ˆà¸—à¸¢à¹Œ
  </button>
  <input type="file" id="jsonFileIn" accept=".json" onchange="handleJsonFile(event)" style="display:none">

  <div class="vsep"></div>

  <!-- Progress -->
  <button class="hbtn hbtn-green" onclick="openSaveModal()" title="à¸šà¸±à¸™à¸—à¸¶à¸ Progress">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
    à¸šà¸±à¸™à¸—à¸¶à¸
  </button>
  <button class="hbtn hbtn-amber" onclick="document.getElementById('progressFileIn').click()" title="à¹‚à¸«à¸¥à¸” Progress">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    à¹‚à¸«à¸¥à¸” Progress
  </button>
  <input type="file" id="progressFileIn" accept=".mxr" onchange="loadProgress(event)" style="display:none">

  <div class="vsep"></div>

  <!-- Theme -->
  <button class="hbtn" id="themeBtn" onclick="toggleTheme()">
    <svg id="themeIco" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
      <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    </svg>
    <span id="themeTxt">Light</span>
  </button>
</header>

<!-- Progress strip -->
<div id="progressBar"><div id="progressFill" style="width:0%"></div></div>

<!-- Toasts -->
<div id="toastContainer"></div>

<!-- APP -->
<div id="app">

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sidebar-inner" id="sidebarInner"></div>
    <div class="sidebar-footer">
      <div class="sidebar-stats">
        <div class="stat-card">
          <span class="stat-val" id="statDone">0</span>
          <div class="stat-lbl">à¸œà¹ˆà¸²à¸™à¹à¸¥à¹‰à¸§</div>
        </div>
        <div class="stat-card">
          <span class="stat-val" id="statTotal">0</span>
          <div class="stat-lbl">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <div id="main">

    <!-- Problem panel -->
    <div id="problemPanel">
      <div class="prob-top">
        <div class="prob-badge" id="probBadge"></div>
        <div style="flex:1">
          <div class="prob-title" id="probTitle">à¹€à¸¥à¸·à¸­à¸à¹‚à¸ˆà¸—à¸¢à¹Œà¸ˆà¸²à¸à¸‹à¹‰à¸²à¸¢à¸¡à¸·à¸­</div>
          <div class="prob-desc" id="probDesc">à¸à¸” "à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œ" à¹€à¸à¸·à¹ˆà¸­à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œà¸ˆà¸²à¸ GitHub à¸«à¸£à¸·à¸­ "à¹€à¸à¸´à¹ˆà¸¡à¹‚à¸ˆà¸—à¸¢à¹Œ" à¹€à¸à¸·à¹ˆà¸­à¹€à¸à¸´à¹ˆà¸¡à¹„à¸Ÿà¸¥à¹Œ .json à¸‚à¸­à¸‡à¸„à¸¸à¸“</div>
        </div>
      </div>
      <div class="hint-row">
        <button class="hint-btn" id="hintBtn" onclick="toggleHint()">ğŸ’¡ à¸”à¸¹ hint</button>
        <div class="hint-box" id="hintBox">
          <span>ğŸ’¡</span>
          <span id="hintTxt"></span>
        </div>
      </div>
    </div>

    <!-- Resize handle -->
    <div id="resizer"></div>

    <!-- Editor + Output -->
    <div class="editor-area">
      <!-- Editor -->
      <div class="editor-pane">
        <div class="pane-head">
          <div class="macos-dots">
            <div class="macos-dot" style="background:#ff5f57"></div>
            <div class="macos-dot" style="background:#febc2e"></div>
            <div class="macos-dot" style="background:#28c840"></div>
          </div>
          <span class="pane-filename">main.py</span>
          <span class="pane-lang">Python 3</span>
        </div>
        <div id="editorContainer"></div>
      </div>
      <!-- Output -->
      <div class="output-pane">
        <div class="pane-head">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--neon)" stroke-width="2.5"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
          <span style="color:var(--neon)">Output</span>
          <span id="runSpinner" class="run-spinner">âŸ³</span>
        </div>
        <div id="outputContent">
          <div class="ol ol-sys">// à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸ˆà¸°à¹à¸ªà¸”à¸‡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ ğŸ¯</div>
        </div>
        <div id="inputRow">
          <div class="input-prompt">â–¶ input:</div>
          <input type="text" id="stdinInput" placeholder="à¸à¸´à¸¡à¸à¹Œà¹à¸¥à¹‰à¸§à¸à¸” Enter..." autocomplete="off">
        </div>
      </div>
    </div>

    <!-- Result -->
    <div id="resultPanel"><div id="resultInner" class="result-inner"></div></div>

    <!-- Action bar -->
    <div id="actionBar">
      <button class="abtn abtn-run" id="runBtn" onclick="runCode()" disabled>
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        à¸£à¸±à¸™
      </button>
      <button class="abtn abtn-check" id="checkBtn" onclick="checkAnswer()" disabled>
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        à¸•à¸£à¸§à¸ˆà¸„à¸³à¸•à¸­à¸š
      </button>
      <button class="abtn abtn-clear" onclick="clearOutput()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
        à¸¥à¹‰à¸²à¸‡
      </button>
      <button class="abtn abtn-next" id="nextBtn" onclick="nextExercise()">
        à¸‚à¹‰à¸­à¸–à¸±à¸”à¹„à¸›
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- SAVE MODAL -->
<div class="modal-bg" id="saveModal" onclick="if(event.target===this)closeSaveModal()">
  <div class="modal-box">
    <div class="modal-title">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸ Progress</div>
    <div class="modal-sub">à¹„à¸Ÿà¸¥à¹Œ .mxr à¸ˆà¸°à¸–à¸¹à¸à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”<br>à¸ªà¸²à¸¡à¸²à¸£à¸–à¸™à¸³à¸à¸¥à¸±à¸šà¸¡à¸²à¹‚à¸«à¸¥à¸”à¸•à¹ˆà¸­à¹„à¸”à¹‰à¹ƒà¸™à¸ à¸²à¸¢à¸«à¸¥à¸±à¸‡</div>
    <label class="modal-label">à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™ (à¹„à¸¡à¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™)</label>
    <input class="modal-input" type="text" id="saveNameIn" placeholder="à¹€à¸Šà¹ˆà¸™ à¸™à¹‰à¸­à¸‡à¸¡à¸°à¸¥à¸´" maxlength="40">
    <div class="modal-actions">
      <button class="modal-btn modal-cancel" onclick="closeSaveModal()">à¸¢à¸à¹€à¸¥à¸´à¸</button>
      <button class="modal-btn modal-primary" onclick="confirmSave()">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸</button>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let exercises = [];
let currentIdx = 0;
const completed = new Set();
let score = 0;
let editor = null;
let pyodideReady = false;
let pyodide = null;
let inputCallback = null;
let currentTheme = localStorage.getItem('pa-theme') || 'dark';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setLoad(pct, txt) {
  document.getElementById('loadFill').style.width = pct + '%';
  document.getElementById('loadTxt').textContent = txt;
}

async function loadPyodideEngine() {
  try {
    setLoad(10, 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸” Pyodide...');
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js';
    document.head.appendChild(s);
    await new Promise((ok, err) => { s.onload = ok; s.onerror = err; });

    setLoad(45, 'à¸à¸³à¸¥à¸±à¸‡à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ Python runtime...');
    pyodide = await window.loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/' });

    setLoad(80, 'à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸” Code Editor...');
    await loadMonaco();

    setLoad(100, 'à¸à¸£à¹‰à¸­à¸¡à¹à¸¥à¹‰à¸§! ğŸ‰');
    pyodideReady = true;
    document.getElementById('pyDot').className = 'py-dot ready';
    document.getElementById('pyStatus').textContent = 'Python à¸à¸£à¹‰à¸­à¸¡';
    document.getElementById('runBtn').disabled = false;
    document.getElementById('checkBtn').disabled = false;

    setTimeout(() => {
      const ov = document.getElementById('loadingOverlay');
      ov.style.transition = 'opacity 0.6s';
      ov.style.opacity = '0';
      setTimeout(() => ov.style.display = 'none', 600);
    }, 350);
  } catch(e) {
    document.getElementById('pyDot').className = 'py-dot error';
    document.getElementById('pyStatus').textContent = 'à¹‚à¸«à¸¥à¸”à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§';
    document.getElementById('loadTxt').textContent = 'Error: ' + e.message;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MONACO EDITOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadMonaco() {
  return new Promise(resolve => {
    require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs' } });
    require(['vs/editor/editor.main'], () => {

      const darkColors = {
        'editor.background': '#0a0b12',
        'editor.foreground': '#e5e8ff',
        'editorLineNumber.foreground': '#2a2d45',
        'editorLineNumber.activeForeground': '#6e56cf',
        'editor.selectionBackground': '#6e56cf33',
        'editor.lineHighlightBackground': '#13151f',
        'editorCursor.foreground': '#9d7eff',
        'editorSuggestWidget.background': '#13151f',
        'editorSuggestWidget.border': '#6e56cf44',
        'editorSuggestWidget.selectedBackground': '#6e56cf22',
        'editorHoverWidget.background': '#13151f',
        'editorHoverWidget.border': '#6e56cf44',
      };
      const lightColors = {
        'editor.background': '#f8f9ff',
        'editor.foreground': '#1c1e30',
        'editorLineNumber.foreground': '#b0b4d4',
        'editorLineNumber.activeForeground': '#5e40cc',
        'editor.selectionBackground': '#5e40cc22',
        'editor.lineHighlightBackground': '#eef0fa',
        'editorCursor.foreground': '#5e40cc',
        'editorSuggestWidget.background': '#ffffff',
        'editorSuggestWidget.border': '#5e40cc33',
        'editorSuggestWidget.selectedBackground': '#ede9fe',
        'editorHoverWidget.background': '#ffffff',
        'editorHoverWidget.border': '#5e40cc33',
      };

      monaco.editor.defineTheme('paDark', {
        base: 'vs-dark', inherit: true,
        rules: [
          { token: 'comment', foreground: '4a4f70', fontStyle: 'italic' },
          { token: 'keyword', foreground: 'bd93f9', fontStyle: 'bold' },
          { token: 'string', foreground: 'f1fa8c' },
          { token: 'number', foreground: '9d7eff' },
          { token: 'support.function', foreground: '3df5c1' },
          { token: 'identifier', foreground: 'e5e8ff' },
          { token: 'operator', foreground: 'ff79c6' },
          { token: 'metatag', foreground: '42c8f5' },
        ],
        colors: darkColors,
      });

      monaco.editor.defineTheme('paLight', {
        base: 'vs', inherit: true,
        rules: [
          { token: 'comment', foreground: '8c90b8', fontStyle: 'italic' },
          { token: 'keyword', foreground: '5e40cc', fontStyle: 'bold' },
          { token: 'string', foreground: '8b4513' },
          { token: 'number', foreground: '5e40cc' },
          { token: 'support.function', foreground: '0d7a57' },
          { token: 'identifier', foreground: '1c1e30' },
          { token: 'operator', foreground: '9333ea' },
          { token: 'metatag', foreground: '0284c7' },
        ],
        colors: lightColors,
      });

      // Python tokenizer
      monaco.languages.setMonarchTokensProvider('python', {
        keywords: ['and','as','assert','async','await','break','class','continue','def','del','elif','else','except','finally','for','from','global','if','import','in','is','lambda','nonlocal','not','or','pass','raise','return','try','while','with','yield'],
        builtins: ['print','input','int','float','str','bool','list','dict','set','tuple','len','range','abs','round','max','min','sum','type','sorted','enumerate','zip','map','filter','open','super','object','Exception','True','False','None'],
        tokenizer: {
          root: [
            [/^\s*@\w+/, 'metatag'],
            [/#.*$/, 'comment'],
            [/"""/, { token: 'string', next: '@tdq' }],
            [/'''/, { token: 'string', next: '@tsq' }],
            [/"/, { token: 'string', next: '@dq' }],
            [/'/, { token: 'string', next: '@sq' }],
            [/0[xX][0-9a-fA-F]+/, 'number.hex'],
            [/\d+\.\d*([eE][\-+]?\d+)?/, 'number.float'],
            [/\d+/, 'number'],
            [/[a-zA-Z_]\w*/, { cases: { '@keywords': 'keyword', '@builtins': 'support.function', '@default': 'identifier' } }],
            [/[+\-*/%&|^~<>!=]=?|\/\/=?|\*\*=?/, 'operator'],
            [/[(){}\[\],.:;]/, 'delimiter'],
          ],
          dq: [[/[^"\\]+/, 'string'], [/\\./, 'string.escape'], [/"/, { token: 'string', next: '@pop' }]],
          sq: [[/[^'\\]+/, 'string'], [/\\./, 'string.escape'], [/'/, { token: 'string', next: '@pop' }]],
          tdq: [[/[^"\\]+/, 'string'], [/\\./, 'string.escape'], [/"""/, { token: 'string', next: '@pop' }], [/"/, 'string']],
          tsq: [[/[^'\\]+/, 'string'], [/\\./, 'string.escape'], [/'''/, { token: 'string', next: '@pop' }], [/'/, 'string']],
        }
      });

      // Completions
      const COMPLETIONS = [
        { label:'print', insert:'print(${1:})', doc:'print(*objects)\nà¹à¸ªà¸”à¸‡à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸­à¸­à¸à¸—à¸²à¸‡à¸«à¸™à¹‰à¸²à¸ˆà¸­', kind:1 },
        { label:'input', insert:'input(${1:})', doc:'input(prompt="")\nà¸£à¸±à¸šà¸„à¹ˆà¸²à¸ˆà¸²à¸ keyboard', kind:1 },
        { label:'int', insert:'int(${1:})', doc:'int(x)\nà¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¸ˆà¸³à¸™à¸§à¸™à¹€à¸•à¹‡à¸¡', kind:1 },
        { label:'float', insert:'float(${1:})', doc:'float(x)\nà¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™à¸—à¸¨à¸™à¸´à¸¢à¸¡', kind:1 },
        { label:'str', insert:'str(${1:})', doc:'str(x)\nà¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™ string', kind:1 },
        { label:'len', insert:'len(${1:})', doc:'len(s)\nà¸™à¸±à¸šà¸ˆà¸³à¸™à¸§à¸™ elements', kind:1 },
        { label:'range', insert:'range(${1:})', doc:'range(stop) | range(start, stop, step)', kind:1 },
        { label:'abs', insert:'abs(${1:})', doc:'abs(x)\nà¸„à¹ˆà¸²à¸ªà¸±à¸¡à¸šà¸¹à¸£à¸“à¹Œ', kind:1 },
        { label:'round', insert:'round(${1:})', doc:'round(number, ndigits)\nà¸›à¸±à¸”à¹€à¸¨à¸©', kind:1 },
        { label:'max', insert:'max(${1:})', doc:'max(...)\nà¸«à¸²à¸„à¹ˆà¸²à¸ªà¸¹à¸‡à¸ªà¸¸à¸”', kind:1 },
        { label:'min', insert:'min(${1:})', doc:'min(...)\nà¸«à¸²à¸„à¹ˆà¸²à¸•à¹ˆà¸³à¸ªà¸¸à¸”', kind:1 },
        { label:'sum', insert:'sum(${1:})', doc:'sum(iterable)\nà¸£à¸§à¸¡à¸„à¹ˆà¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”', kind:1 },
        { label:'type', insert:'type(${1:})', doc:'type(obj)\nà¸”à¸¹ type', kind:1 },
        { label:'sorted', insert:'sorted(${1:})', doc:'sorted(iterable, reverse=False)', kind:1 },
        { label:'enumerate', insert:'enumerate(${1:})', doc:'enumerate(iterable)\nà¸§à¸™à¸à¸£à¹‰à¸­à¸¡ index', kind:1 },
        { label:'if', insert:'if ${1:condition}:\n    ${2:pass}', doc:'à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ if', kind:14 },
        { label:'elif', insert:'elif ${1:condition}:\n    ${2:pass}', doc:'à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ elif', kind:14 },
        { label:'else', insert:'else:\n    ${1:pass}', doc:'à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ else', kind:14 },
        { label:'for', insert:'for ${1:i} in ${2:range(10)}:\n    ${3:pass}', doc:'à¸§à¸™ for loop', kind:14 },
        { label:'while', insert:'while ${1:condition}:\n    ${2:pass}', doc:'à¸§à¸™ while loop', kind:14 },
        { label:'def', insert:'def ${1:func}(${2:}):\n    ${3:pass}', doc:'à¸ªà¸£à¹‰à¸²à¸‡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™', kind:14 },
        { label:'return', insert:'return ${1:}', doc:'à¸„à¸·à¸™à¸„à¹ˆà¸²', kind:14 },
        { label:'import', insert:'import ${1:}', doc:'import module', kind:14 },
        { label:'True', insert:'True', doc:'Boolean True', kind:17 },
        { label:'False', insert:'False', doc:'Boolean False', kind:17 },
        { label:'None', insert:'None', doc:'NoneType None', kind:17 },
      ];

      monaco.languages.registerCompletionItemProvider('python', {
        provideCompletionItems(model, position) {
          const word = model.getWordUntilPosition(position);
          const range = { startLineNumber: position.lineNumber, endLineNumber: position.lineNumber, startColumn: word.startColumn, endColumn: word.endColumn };
          return {
            suggestions: COMPLETIONS.map(c => ({
              label: c.label,
              kind: c.kind,
              documentation: { value: c.doc || '' },
              insertText: c.insert,
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              range,
            }))
          };
        }
      });

      const isDark = currentTheme === 'dark';
      editor = monaco.editor.create(document.getElementById('editorContainer'), {
        value: exercises.length > 0 ? exercises[0].starterCode : '# à¹€à¸‚à¸µà¸¢à¸™à¹‚à¸„à¹‰à¸” Python à¸—à¸µà¹ˆà¸™à¸µà¹ˆ\n',
        language: 'python',
        theme: isDark ? 'paDark' : 'paLight',
        fontSize: 13.5,
        fontFamily: "'Noto Sans Thai', sans-serif",
        fontLigatures: true,
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        lineNumbers: 'on',
        automaticLayout: true,
        tabSize: 4,
        insertSpaces: true,
        wordWrap: 'on',
        padding: { top: 14, bottom: 14 },
        quickSuggestions: { other: true, comments: false, strings: false },
        suggestOnTriggerCharacters: true,
        acceptSuggestionOnEnter: 'on',
        snippetSuggestions: 'top',
        autoClosingBrackets: 'always',
        autoClosingQuotes: 'always',
        matchBrackets: 'always',
        renderLineHighlight: 'line',
        cursorBlinking: 'phase',
        cursorSmoothCaretAnimation: 'on',
        smoothScrolling: true,
      });

      // Keyboard shortcut: Ctrl+Enter = Run
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => {
        if (!document.getElementById('runBtn').disabled) runCode();
      });

      window.editor = editor;
      resolve();
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const collapsedChaps = new Set();

function buildSidebar() {
  const inner = document.getElementById('sidebarInner');
  inner.innerHTML = '';
  let chapIdx = 0;
  let currentGroup = null;

  exercises.forEach((ex, i) => {
    if (ex.chapter) {
      chapIdx++;
      const idx = chapIdx;
      const grp = document.createElement('div');
      grp.className = 'chapter-group' + (collapsedChaps.has(idx) ? ' collapsed' : '');
      grp.id = 'cg-' + idx;

      const hdr = document.createElement('div');
      hdr.className = 'chapter-header';
      hdr.innerHTML = `<span style="flex:1;text-align:left">${ex.chapter}</span><div class="chapter-line"></div><span class="chapter-caret">â–¾</span>`;
      hdr.onclick = () => {
        const c = grp.classList.toggle('collapsed');
        if (c) collapsedChaps.add(idx); else collapsedChaps.delete(idx);
      };

      const items = document.createElement('div');
      items.className = 'chapter-items';
      grp.appendChild(hdr);
      grp.appendChild(items);
      inner.appendChild(grp);
      currentGroup = items;
    }

    const btn = document.createElement('button');
    btn.className = 'ex-btn' + (i === currentIdx ? ' active' : '') + (completed.has(i) ? ' done' : '');
    btn.id = 'eb-' + i;
    const shortTitle = ex.title.replace(new RegExp(`^à¸‚à¹‰à¸­\\s*${ex.id}\\s*[â€”â€“-]\\s*`), '');
    btn.innerHTML = `<div class="ex-num">${ex.id}</div><span class="ex-title">${shortTitle}</span><span class="ex-check">âœ“</span>`;
    btn.onclick = () => selectExercise(i);
    (currentGroup || inner).appendChild(btn);
  });

  updateStatCards();
}

function updateSidebar() {
  exercises.forEach((_, i) => {
    const b = document.getElementById('eb-' + i);
    if (b) b.className = 'ex-btn' + (i === currentIdx ? ' active' : '') + (completed.has(i) ? ' done' : '');
  });
  updateStatCards();
}

function updateStatCards() {
  document.getElementById('statDone').textContent = completed.size;
  document.getElementById('statTotal').textContent = exercises.length;
  document.getElementById('scoreTotal').textContent = exercises.length;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXERCISE SELECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selectExercise(idx) {
  currentIdx = idx;
  const ex = exercises[idx];
  document.getElementById('probBadge').textContent = ex.badge || '';
  document.getElementById('probBadge').className = 'prob-badge ' + (ex.badgeClass || '');
  document.getElementById('probTitle').textContent = ex.title;
  document.getElementById('probDesc').innerHTML = ex.desc;
  document.getElementById('hintTxt').textContent = ex.hint || '';
  // Reset hint
  document.getElementById('hintBox').classList.remove('show');
  document.getElementById('hintBtn').textContent = 'ğŸ’¡ à¸”à¸¹ hint';
  // Reset state
  if (editor) editor.setValue(ex.starterCode || '');
  clearOutput();
  hideResult();
  document.getElementById('nextBtn').style.display = 'none';
  updateSidebar();
  updateProgress();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OUTPUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addLine(txt, cls) {
  const oc = document.getElementById('outputContent');
  const d = document.createElement('div');
  d.className = 'ol' + (cls ? ' ' + cls : '');
  d.textContent = txt;
  oc.appendChild(d);
  oc.scrollTop = oc.scrollHeight;
}

function clearOutput() {
  document.getElementById('outputContent').innerHTML = '<div class="ol ol-sys">// à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸ˆà¸°à¹à¸ªà¸”à¸‡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ ğŸ¯</div>';
}

function renderOutput(raw, autoInputs) {
  if (raw.startsWith('__ERR__')) {
    const msg = raw.replace('__ERR__', '');
    const lines = msg.trim().split('\n');
    const errLine = lines.filter(l => /Error/.test(l)).pop() || lines[lines.length - 1];
    addLine('âš ï¸ ' + errLine.trim(), 'ol-err');
    // Show full traceback in smaller text
    lines.forEach(l => { if (l.trim()) addLine('  ' + l, 'ol-err'); });
    return;
  }
  if (autoInputs && autoInputs.length > 0) {
    autoInputs.forEach(v => addLine('â†’ ' + v, 'ol-inp'));
  }
  const lines = raw.split('\n');
  if (lines.length && lines[lines.length - 1] === '') lines.pop();
  if (!lines.length) addLine('(à¹„à¸¡à¹ˆà¸¡à¸µ output)', 'ol-sys');
  else lines.forEach(l => addLine(l, ''));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PYTHON EXECUTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function executePython(code, inputs) {
  pyodide.globals.set('_user_code', code);
  const pyInputList = '[' + (inputs || []).map(v => JSON.stringify(String(v))).join(',') + ']';
  const script = `
import sys, io, builtins, traceback
_buf = io.StringIO()
_old = sys.stdout
sys.stdout = _buf
_vals = ${pyInputList}
_idx = [0]
def _inp(prompt=''):
    if prompt: print(prompt, end='')
    if _idx[0] < len(_vals):
        v = _vals[_idx[0]]; _idx[0] += 1; return v
    return ''
builtins.input = _inp
_err = None
try:
    exec(compile(_user_code, '<student>', 'exec'))
except SystemExit: pass
except Exception: _err = traceback.format_exc()
sys.stdout = _old
_res = _buf.getvalue()
if _err: _res = '__ERR__' + _err
_res
`;
  const result = await pyodide.runPythonAsync(script);
  return String(result || '');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RUN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function runCode() {
  if (!pyodideReady) return;
  const ex = exercises[currentIdx];
  if (!ex) return;
  clearOutput();
  hideResult();
  document.getElementById('nextBtn').style.display = 'none';
  setBusy(true);
  try {
    const raw = await executePython(editor.getValue(), ex.inputs || []);
    renderOutput(raw, ex.inputs || []);
  } catch(e) {
    addLine('âš ï¸ JS Error: ' + e.message, 'ol-err');
  } finally {
    setBusy(false);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHECK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function checkAnswer() {
  if (!pyodideReady) return;
  const ex = exercises[currentIdx];
  if (!ex) return;
  clearOutput();
  hideResult();
  setBusy(true);

  const testCases = (ex.testCases && ex.testCases.length)
    ? ex.testCases
    : [{ inputs: ex.inputs || [], expected: ex.expected }];

  const norm = s => s.split('\n').map(l => l.trimEnd()).join('\n').trim();
  const results = [];
  let allPassed = true;
  let firstError = null;

  for (let i = 0; i < testCases.length; i++) {
    const tc = testCases[i];
    let raw = '';
    try { raw = await executePython(editor.getValue(), tc.inputs || []); }
    catch(e) { raw = '__ERR__' + e.message; }
    if (raw.startsWith('__ERR__')) {
      allPassed = false;
      if (!firstError) firstError = raw;
      results.push({ passed: false, inputs: tc.inputs, expected: tc.expected, got: null, error: true });
      break;
    }
    const got = norm(raw), want = norm(tc.expected);
    const passed = got === want;
    if (!passed) allPassed = false;
    results.push({ passed, inputs: tc.inputs, expected: tc.expected, got });
  }

  setBusy(false);

  if (firstError) renderOutput(firstError, []);
  else {
    const last = results[results.length - 1];
    renderOutput(last.got !== null ? last.got + '\n' : '', (testCases[results.length - 1].inputs || []));
  }

  if (allPassed && !completed.has(currentIdx)) {
    completed.add(currentIdx);
    score++;
    document.getElementById('scoreNum').textContent = score;
    showConfetti();
  }

  showResultMulti(allPassed, results, testCases.length);
  if (allPassed && currentIdx < exercises.length - 1) {
    document.getElementById('nextBtn').style.display = 'inline-flex';
  }
  updateSidebar();
  updateProgress();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULT DISPLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showResultMulti(allPassed, results, total) {
  const inner = document.getElementById('resultInner');
  const passed = results.filter(r => r.passed).length;

  if (allPassed) {
    inner.innerHTML = `<div class="result-pass">
      <div class="result-icon">ğŸ‰</div>
      <div>
        <div class="result-title" style="color:var(--neon)">à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”! à¸œà¹ˆà¸²à¸™ ${passed}/${total} test âœ¨</div>
        <div class="result-sub">${results[0].expected.replace(/\n/g,'â†µ').slice(0,80)}</div>
      </div>
    </div>`;
  } else {
    const rows = results.map((r, i) => {
      if (r.error) return `<div class="tc-row"><span class="tc-fail">âœ—</span><span class="tc-label">Test ${i+1}</span><span class="tc-code tc-got">Runtime Error</span></div>`;
      const inStr = (r.inputs||[]).length ? `[${r.inputs.join(', ')}]` : '';
      return `<div class="tc-row">
        <span class="${r.passed?'tc-pass':'tc-fail'}">${r.passed?'âœ“':'âœ—'}</span>
        <span class="tc-label">Test ${i+1}${inStr?' '+inStr:''}</span>
        ${!r.passed ? `<span class="tc-code tc-exp">${(r.expected||'').replace(/\n/g,'â†µ').slice(0,35)}</span><span style="color:var(--text3)">â‰ </span><span class="tc-code tc-got">${(r.got||'').replace(/\n/g,'â†µ').slice(0,35)}</span>` : ''}
      </div>`;
    }).join('');
    inner.innerHTML = `<div class="result-fail">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="result-icon">ğŸ¤”</div>
        <div class="result-title" style="color:var(--rose)">à¸œà¹ˆà¸²à¸™ ${passed}/${total} test â€” à¸¥à¸­à¸‡à¹à¸à¹‰à¹ƒà¸«à¸¡à¹ˆà¸™à¸°!</div>
      </div>
      <div>${rows}</div>
    </div>`;
  }
  document.getElementById('resultPanel').classList.add('show');
}

function hideResult() {
  document.getElementById('resultPanel').classList.remove('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setBusy(on) {
  document.getElementById('runBtn').disabled = on;
  document.getElementById('checkBtn').disabled = on;
  document.getElementById('runSpinner').style.display = on ? 'inline' : 'none';
}

function toggleHint() {
  const box = document.getElementById('hintBox');
  const btn = document.getElementById('hintBtn');
  const show = !box.classList.contains('show');
  box.classList.toggle('show', show);
  btn.textContent = show ? 'ğŸ™ˆ à¸‹à¹ˆà¸­à¸™ hint' : 'ğŸ’¡ à¸”à¸¹ hint';
}

function nextExercise() {
  if (currentIdx < exercises.length - 1) selectExercise(currentIdx + 1);
}

function updateProgress() {
  const pct = exercises.length > 0 ? (completed.size / exercises.length * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
}

function showConfetti() {
  const emojis = ['ğŸ‰','â­','âœ¨','ğŸŒŸ','ğŸ’«','ğŸŠ','ğŸˆ','ğŸ†'];
  for (let i = 0; i < 8; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'confetti';
      el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      el.style.left = (10 + Math.random() * 80) + 'vw';
      el.style.top = (10 + Math.random() * 80) + 'vh';
      el.style.animationDuration = (0.8 + Math.random() * 0.6) + 's';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1400);
    }, i * 90);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  const isLight = t === 'light';
  document.getElementById('themeTxt').textContent = isLight ? 'Dark' : 'Light';
  if (editor) monaco.editor.setTheme(isLight ? 'paLight' : 'paDark');
}
function toggleTheme() {
  currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
  applyTheme(currentTheme);
  localStorage.setItem('pa-theme', currentTheme);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _tid = 0;
function toast(msg, type = 'info', dur = 4000) {
  const c = document.getElementById('toastContainer');
  const id = ++_tid;
  const el = document.createElement('div');
  el.id = 'toast-' + id;
  el.className = 'toast toast-' + type;
  el.innerHTML = `<span class="toast-msg">${msg}</span><button class="toast-x" onclick="dismissToast(${id})">âœ•</button>`;
  c.appendChild(el);
  requestAnimationFrame(() => requestAnimationFrame(() => el.classList.add('in')));
  el._t = setTimeout(() => dismissToast(id), dur);
  return id;
}
function dismissToast(id) {
  const el = document.getElementById('toast-' + id);
  if (!el) return;
  clearTimeout(el._t);
  el.classList.remove('in'); el.classList.add('out');
  setTimeout(() => el.remove(), 250);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JSON / EXERCISE LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DEFAULT_JSON_URL = 'https://raw.githubusercontent.com/Karibura-Cyber/python-playground/refs/heads/main/exercises.json';
const MXR_MAGIC = 'PYADVMXR1';

function validateEx(ex) {
  const req = ['id','title','badge','badgeClass','desc','hint','starterCode','expected'];
  for (const f of req) if (ex[f] == null) return `à¸‚à¸²à¸” "${f}"`;
  if (!Array.isArray(ex.inputs)) ex.inputs = [];
  if (!ex.chapter) ex.chapter = null;
  return null;
}

function mergeExercises(arr) {
  const ids = new Set(exercises.map(e => e.id));
  let added = 0, skipped = 0, errors = [];
  arr.forEach((ex, i) => {
    const err = validateEx(ex);
    if (err) { errors.push(`à¸‚à¹‰à¸­ ${i+1}: ${err}`); return; }
    if (ids.has(ex.id)) { skipped++; return; }
    exercises.push(ex); ids.add(ex.id); added++;
  });
  return { added, skipped, errors };
}

function rebuildUI() {
  buildSidebar();
  document.getElementById('scoreTotal').textContent = exercises.length;
  document.getElementById('statTotal').textContent = exercises.length;
  if (exercises.length > 0 && !document.getElementById('probTitle').textContent.includes(' ')) {
    selectExercise(0);
  }
  updateProgress();
}

async function loadDefaultJson() {
  const btn = document.getElementById('reloadBtn');
  btn.disabled = true; btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="animation:spin 0.8s linear infinite"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.12"/></svg> à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...';

  try {
    const res = await fetch(DEFAULT_JSON_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ array');

    const valid = [], errors = [];
    data.forEach((ex, i) => {
      const err = validateEx(ex);
      if (err) errors.push(`à¸‚à¹‰à¸­ ${i+1}: ${err}`);
      else valid.push(ex);
    });

    const newIds = new Set(valid.map(e => e.id));
    exercises = exercises.filter(e => !newIds.has(e.id));
    exercises.push(...valid);
    exercises.sort((a, b) => a.id - b.id);
    rebuildUI();
    if (exercises.length) selectExercise(0);

    toast(`à¹‚à¸«à¸¥à¸” ${valid.length} à¹‚à¸ˆà¸—à¸¢à¹Œà¸ªà¸³à¹€à¸£à¹‡à¸ˆ${errors.length ? ` (${errors.length} error)` : ''}`, errors.length ? 'err' : 'ok');
  } catch(e) {
    toast('à¹‚à¸«à¸¥à¸”à¹„à¸¡à¹ˆà¹„à¸”à¹‰: ' + e.message, 'err');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.12"/></svg> à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œ';
  }
}

function handleJsonFile(e) {
  const file = e.target.files[0]; if (!file) return;
  e.target.value = '';
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!Array.isArray(data)) throw new Error('à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ array');
      const { added, skipped, errors } = mergeExercises(data);
      rebuildUI();
      toast(`"${file.name}": +${added}${skipped ? ` à¸‹à¹‰à¸³ ${skipped}` : ''}`, errors.length ? 'err' : 'ok');
    } catch(err) { toast('âŒ ' + err.message, 'err'); }
  };
  reader.readAsText(file, 'UTF-8');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVE / LOAD PROGRESS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openSaveModal() {
  document.getElementById('saveModal').classList.add('show');
  setTimeout(() => document.getElementById('saveNameIn').focus(), 50);
}
function closeSaveModal() {
  document.getElementById('saveModal').classList.remove('show');
}
function confirmSave() {
  const name = document.getElementById('saveNameIn').value.trim() || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸';
  closeSaveModal();
  const snap = {
    magic: MXR_MAGIC, version: 1,
    savedAt: new Date().toISOString(),
    studentName: name, score, currentIdx,
    completed: [...completed],
    codes: {}
  };
  if (editor && exercises[currentIdx]) snap.codes[exercises[currentIdx].id] = editor.getValue();
  const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(snap))));
  const blob = new Blob([b64], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `progress_${name.replace(/[^a-zA-Z0-9à¸-à¹™]/g,'_').slice(0,20)}_${new Date().toISOString().slice(0,10)}.mxr`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§: ${a.download}`, 'ok');
}

function loadProgress(e) {
  const file = e.target.files[0]; if (!file) return;
  e.target.value = '';
  if (!file.name.endsWith('.mxr')) { toast('à¹„à¸Ÿà¸¥à¹Œà¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ .mxr', 'err'); return; }
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const snap = JSON.parse(decodeURIComponent(escape(atob(ev.target.result.trim()))));
      if (snap.magic !== MXR_MAGIC) throw new Error('à¹„à¸Ÿà¸¥à¹Œà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡');
      score = snap.score || 0;
      completed.clear();
      (snap.completed || []).forEach(i => completed.add(i));
      document.getElementById('scoreNum').textContent = score;
      const idx = Math.min(snap.currentIdx || 0, exercises.length - 1);
      selectExercise(idx);
      if (snap.codes && exercises[idx] && snap.codes[exercises[idx].id] && editor) {
        editor.setValue(snap.codes[exercises[idx].id]);
      }
      updateSidebar(); updateProgress();
      const d = snap.savedAt ? new Date(snap.savedAt).toLocaleDateString('th-TH') : '?';
      toast(`à¹‚à¸«à¸¥à¸”à¹à¸¥à¹‰à¸§: ${snap.studentName} | ${score} à¸„à¸°à¹à¸™à¸™ | ${d}`, 'ok');
    } catch(err) { toast('à¹‚à¸«à¸¥à¸”à¹„à¸¡à¹ˆà¹„à¸”à¹‰: ' + err.message, 'err'); }
  };
  reader.readAsText(file, 'UTF-8');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL RESIZER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
  const r = document.getElementById('resizer');
  const p = document.getElementById('problemPanel');
  let drag = false, sy = 0, sh = 0;
  r.addEventListener('mousedown', e => {
    drag = true; sy = e.clientY; sh = p.offsetHeight;
    r.classList.add('active');
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'ns-resize';
  });
  document.addEventListener('mousemove', e => {
    if (!drag) return;
    const nh = Math.max(60, Math.min(sh + (e.clientY - sy), window.innerHeight * 0.55));
    p.style.height = nh + 'px'; p.style.maxHeight = 'none';
    if (editor) editor.layout();
  });
  document.addEventListener('mouseup', () => {
    if (!drag) return; drag = false;
    r.classList.remove('active');
    document.body.style.userSelect = ''; document.body.style.cursor = '';
    if (editor) editor.layout();
  });
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD SHORTCUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', e => {
  // Ctrl+Enter: run; Shift+Enter: check
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Enter') {
    e.preventDefault();
    if (!document.getElementById('checkBtn').disabled) checkAnswer();
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(async () => {
  // Apply saved theme
  applyTheme(currentTheme);

  // Load exercises
  await loadDefaultJson();

  if (exercises.length === 0) {
    document.getElementById('sidebarInner').innerHTML =
      '<div style="padding:20px;color:var(--text2);font-size:0.78rem;text-align:center;line-height:1.7">âš ï¸ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¹‚à¸ˆà¸—à¸¢à¹Œ<br>à¸à¸” <b>à¹‚à¸«à¸¥à¸”à¹‚à¸ˆà¸—à¸¢à¹Œ</b> à¸«à¸£à¸·à¸­ <b>à¹€à¸à¸´à¹ˆà¸¡à¹‚à¸ˆà¸—à¸¢à¹Œ</b></div>';
  } else {
    buildSidebar();
    selectExercise(0);
  }

  // Load Pyodide
  loadPyodideEngine();
})();
</script>
</body>
</html>
