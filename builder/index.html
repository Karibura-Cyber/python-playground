<!DOCTYPE html>
<html lang="th" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üêç Python Quiz Builder</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Noto+Sans+Thai:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden}

:root{
  --font:'Noto Sans Thai',sans-serif;
  --mono:'JetBrains Mono',monospace;
  --acc:#00c896;
  --acc2:#7c6fff;
  --acc3:#ff6b6b;
  --acc4:#f5a623;
  --acc5:#5abaff;
}

[data-theme="dark"]{
  --bg:#0d0f14;
  --surf:#161922;
  --surf2:#1e2330;
  --surf3:#131720;
  --border:#2a3045;
  --txt:#e8eaf0;
  --txt2:#8892a4;
  --txt3:#4a5568;
  --shadow:rgba(0,0,0,.5);
  --code-bg:#0a0c10;
  --hdr-bg:rgba(13,15,20,.95);
}
[data-theme="light"]{
  --bg:#eef0f6;
  --surf:#ffffff;
  --surf2:#f4f5fb;
  --surf3:#e8eaf4;
  --border:#cdd2e6;
  --txt:#1a1e2e;
  --txt2:#5a6282;
  --txt3:#9aa0b8;
  --shadow:rgba(0,0,0,.1);
  --code-bg:#1a1e2e;
  --hdr-bg:rgba(255,255,255,.95);
}

body{
  font-family:var(--font);
  background:var(--bg);color:var(--txt);
  display:flex;flex-direction:column;
  transition:background .25s,color .25s;
}
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 80% 60% at 10% -5%,rgba(0,200,150,.04) 0%,transparent 60%),
    radial-gradient(ellipse 60% 50% at 90% 105%,rgba(124,111,255,.04) 0%,transparent 60%);
}

*{scrollbar-width:thin;scrollbar-color:var(--border) transparent}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
header{
  position:relative;z-index:20;flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;height:48px;
  border-bottom:1px solid var(--border);
  background:var(--hdr-bg);backdrop-filter:blur(16px);
  transition:background .25s,border-color .25s;
}
.logo{
  display:flex;align-items:center;gap:9px;
  font-weight:800;font-size:1rem;letter-spacing:-.3px;
  user-select:none;
}
.logo .accent{color:var(--acc)}

/* start command pill */
.start-cmd{
  display:flex;align-items:center;gap:6px;
  background:var(--surf2);border:1px solid var(--border);
  border-radius:8px;padding:4px 10px 4px 8px;
  font-family:var(--mono);font-size:.68rem;color:var(--txt2);
  cursor:default;user-select:all;
  transition:border-color .2s,color .2s;
}
.start-cmd:hover{border-color:var(--acc);color:var(--txt)}
.start-cmd .cmd-label{
  font-family:var(--font);font-size:.6rem;font-weight:700;
  text-transform:uppercase;letter-spacing:.6px;color:var(--txt3);
}
.start-cmd .cmd-dot{width:6px;height:6px;border-radius:50%;background:var(--acc);flex-shrink:0;box-shadow:0 0 5px var(--acc)}

/* pyodide status */
.py-status{
  display:flex;align-items:center;gap:5px;
  font-family:var(--mono);font-size:.65rem;color:var(--txt3);
  padding:0 4px;
}
.s-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;background:var(--txt3);transition:background .3s}
.s-dot.loading{background:var(--acc4);animation:pulse 1s infinite}
.s-dot.ready{background:var(--acc)}
.s-dot.error{background:var(--acc3)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* theme toggle */
.theme-btn{
  display:flex;align-items:center;gap:5px;
  background:var(--surf2);border:1px solid var(--border);
  border-radius:20px;padding:3px 10px 3px 6px;
  cursor:pointer;transition:all .2s;user-select:none;
  font-size:.68rem;color:var(--txt2);font-weight:700;
}
.theme-btn:hover{border-color:var(--acc2);color:var(--acc2)}
.tt-track{width:28px;height:15px;background:var(--border);border-radius:99px;position:relative;transition:background .2s;flex-shrink:0}
.tt-thumb{position:absolute;top:2px;left:2px;width:11px;height:11px;border-radius:50%;background:#fff;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
[data-theme="light"] .tt-track{background:var(--acc2)}
[data-theme="light"] .tt-thumb{transform:translateX(13px)}

.hdr-r{display:flex;align-items:center;gap:6px}

/* ‚ïê‚ïê‚ïê LAYOUT ROOT ‚ïê‚ïê‚ïê */
.root{position:relative;z-index:1;flex:1;display:flex;overflow:hidden;min-height:0}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sidebar{
  display:flex;flex-direction:column;
  background:var(--surf);border-right:1px solid var(--border);
  flex-shrink:0;overflow:hidden;
  width:260px;min-width:44px;max-width:460px;
  transition:width .22s cubic-bezier(.4,0,.2,1),background .25s,border-color .25s;
}
.sidebar.collapsed{width:44px!important}

.sb-top{
  display:flex;align-items:center;gap:6px;
  padding:8px;flex-shrink:0;
  border-bottom:1px solid var(--border);min-height:44px;overflow:hidden;
}
.sb-meta{display:flex;align-items:center;gap:6px;flex:1;overflow:hidden;transition:opacity .15s}
.sidebar.collapsed .sb-meta,.sidebar.collapsed .q-list{opacity:0;pointer-events:none}

.sb-label{font-weight:700;font-size:.72rem;text-transform:uppercase;letter-spacing:1px;color:var(--txt2);white-space:nowrap;flex:1}
.q-count{background:var(--surf2);border:1px solid var(--border);border-radius:99px;padding:1px 7px;font-family:var(--mono);font-size:.6rem;color:var(--txt2);white-space:nowrap}

.q-list{flex:1;overflow-y:auto;padding:4px}
.q-chapter{font-size:.62rem;color:var(--acc);font-weight:700;padding:8px 6px 3px;border-top:1px solid var(--border);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.q-chapter:first-child{border-top:none;margin-top:0}
.q-item{
  padding:6px 8px;border-radius:7px;cursor:pointer;margin-bottom:2px;
  border:1px solid transparent;transition:all .1s;position:relative;overflow:hidden;
}
.q-item:hover{background:var(--surf2);border-color:var(--border)}
.q-item.active{background:rgba(0,200,150,.08);border-color:rgba(0,200,150,.28)}
.q-row{display:flex;align-items:center;gap:5px}
.q-num{font-family:var(--mono);font-size:.58rem;color:var(--txt3);min-width:16px;flex-shrink:0}
.q-name{font-size:.78rem;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.q-badge{font-size:.56rem;padding:2px 5px;border-radius:99px;font-family:var(--mono);font-weight:700;text-transform:uppercase;flex-shrink:0}
.badge-print{background:rgba(245,166,35,.15);color:var(--acc4)}
.badge-var{background:rgba(124,111,255,.15);color:var(--acc2)}
.badge-input{background:rgba(0,200,150,.15);color:var(--acc)}
.badge-if{background:rgba(255,107,107,.15);color:var(--acc3)}
.badge-loop{background:rgba(90,186,255,.15);color:var(--acc5)}
.badge-fn{background:rgba(255,150,50,.15);color:#ff9632}
.badge-custom{background:rgba(150,150,150,.15);color:var(--txt3)}
.q-del{
  position:absolute;right:4px;top:50%;transform:translateY(-50%);
  opacity:0;background:rgba(255,107,107,.1);border:none;color:var(--acc3);
  width:18px;height:18px;border-radius:4px;cursor:pointer;
  font-size:.6rem;display:flex;align-items:center;justify-content:center;
  transition:all .1s;
}
.q-item:hover .q-del{opacity:1}
.q-del:hover{background:rgba(255,107,107,.3)}

/* ‚ïê‚ïê‚ïê RESIZERS ‚ïê‚ïê‚ïê */
.resizer{flex-shrink:0;background:transparent;position:relative;z-index:5}
.resizer.v{width:5px;cursor:col-resize}
.resizer::after{content:'';position:absolute;background:var(--border);transition:background .15s}
.resizer.v::after{top:0;bottom:0;left:2px;width:1px}
.resizer:hover::after,.resizer.dragging::after{background:var(--acc2)}
.resizer.v:hover::after,.resizer.v.dragging::after{width:3px;left:1px}

/* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}

.empty-state{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:12px;color:var(--txt3);
}
.empty-icon{font-size:2.8rem;opacity:.2}

/* ‚ïê‚ïê‚ïê EDITOR AREA ‚ïê‚ïê‚ïê */
#editorMain{flex:1;display:flex;overflow:hidden;min-height:0}

/* ‚ïê‚ïê‚ïê FORM PANE ‚ïê‚ïê‚ïê */
.form-pane{
  display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;
  width:300px;min-width:200px;max-width:500px;
  border-right:1px solid var(--border);
  background:var(--surf);transition:background .25s,border-color .25s;
}
.pane-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:7px 10px;flex-shrink:0;border-bottom:1px solid var(--border);
  background:var(--surf);gap:6px;min-height:40px;
  transition:background .25s,border-color .25s;
}
.pane-title{
  font-size:.68rem;font-weight:700;color:var(--txt2);
  text-transform:uppercase;letter-spacing:.8px;
  display:flex;align-items:center;gap:5px;white-space:nowrap;
}
.dot-g{width:6px;height:6px;border-radius:50%;background:var(--acc);flex-shrink:0}

.form-scroll{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px}

.field{display:flex;flex-direction:column;gap:3px}
.f2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
label{font-size:.65rem;color:var(--txt2);font-weight:700;text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:3px;font-family:var(--font)}
.req{color:var(--acc3)}
.hint-lbl{font-weight:400;text-transform:none;letter-spacing:0;color:var(--txt3)}

input[type="text"],input[type="number"],textarea,select{
  background:var(--surf2);border:1px solid var(--border);color:var(--txt);
  border-radius:6px;padding:5px 8px;font-size:.8rem;
  font-family:var(--font);outline:none;width:100%;
  transition:border-color .12s,box-shadow .12s,background .25s;
}
input:focus,textarea:focus,select:focus{border-color:var(--acc);box-shadow:0 0 0 2px rgba(0,200,150,.1)}
select option{background:var(--surf2);color:var(--txt)}
textarea{resize:vertical;min-height:44px;font-size:.78rem;line-height:1.5}
textarea.code-ta{
  font-family:var(--mono);font-size:.71rem;min-height:76px;
  color:#ffd93d;background:var(--code-bg);border-color:rgba(255,217,61,.2);
}
textarea.code-ta:focus{border-color:var(--acc4);box-shadow:0 0 0 2px rgba(245,166,35,.1)}

.sep{height:1px;background:var(--border);margin:2px 0;transition:background .25s}
.section-label{font-size:.6rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--txt3);font-weight:700}

.inputs-box{background:var(--surf2);border:1px solid var(--border);border-radius:6px;overflow:hidden}
.in-list{padding:4px;display:flex;flex-direction:column;gap:3px}
.in-row{display:flex;align-items:center;gap:4px}
.in-row input{font-family:var(--mono);font-size:.72rem}
.add-in{
  width:100%;background:transparent;border:none;border-top:1px solid var(--border);
  color:var(--acc);padding:5px;cursor:pointer;font-size:.7rem;font-family:var(--font);
  transition:background .12s;
}
.add-in:hover{background:rgba(0,200,150,.05)}

/* ‚ïê‚ïê‚ïê PLAYGROUND PANE ‚ïê‚ïê‚ïê */
.pg-pane{
  flex:1;display:flex;flex-direction:column;overflow:hidden;
  min-width:0;background:var(--bg);position:relative;transition:background .25s;
}
.pg-pane.fullscreen{position:fixed!important;inset:0!important;z-index:50!important}

/* pg header */
.pg-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;height:42px;flex-shrink:0;
  border-bottom:1px solid var(--border);
  background:var(--surf);gap:8px;
  transition:background .25s,border-color .25s;
}
.pg-tabs{display:flex;gap:2px}
.pg-tab{
  padding:4px 12px;border-radius:6px;
  font-size:.72rem;font-weight:700;cursor:pointer;
  border:1px solid transparent;transition:all .12s;color:var(--txt2);white-space:nowrap;
}
.pg-tab:hover{color:var(--txt);background:var(--surf2)}
.pg-tab.active{background:rgba(0,200,150,.1);border-color:rgba(0,200,150,.28);color:var(--acc)}
.pg-head-r{display:flex;align-items:center;gap:5px}

/* keyboard shortcut pills */
.kbd{
  display:inline-flex;align-items:center;justify-content:center;
  background:var(--surf2);border:1px solid var(--border);
  color:var(--txt3);border-radius:4px;padding:1px 5px;
  font-family:var(--mono);font-size:.58rem;font-weight:500;
  white-space:nowrap;
}

/* ghost buttons in header */
.ghost-btn{
  background:transparent;border:1px solid var(--border);
  color:var(--txt2);padding:3px 8px;border-radius:5px;
  cursor:pointer;font-size:.69rem;transition:all .14s;
  display:flex;align-items:center;gap:4px;
  font-family:var(--font);font-weight:700;white-space:nowrap;
}
.ghost-btn:hover{border-color:var(--acc2);color:var(--acc2);background:rgba(124,111,255,.07)}
.ghost-btn.danger:hover{border-color:var(--acc3);color:var(--acc3);background:rgba(255,107,107,.07)}
.ghost-btn.toggled{color:var(--acc3);border-color:rgba(255,107,107,.4)}

/* ‚ïê‚ïê‚ïê QUESTION HEADER (collapsible) ‚ïê‚ïê‚ïê */
#pqHeader{
  flex-shrink:0;overflow-y:auto;max-height:42%;min-height:0;
  border-bottom:1px solid var(--border);background:var(--surf3);
  transition:max-height .22s cubic-bezier(.4,0,.2,1),border-color .25s,background .25s;
}
#pqHeader.hidden{max-height:0!important;border-bottom:none;overflow:hidden}
.h-resizer{
  height:5px;flex-shrink:0;cursor:row-resize;background:transparent;
  position:relative;z-index:5;transition:opacity .2s;
}
.h-resizer.hidden{height:0;opacity:0;pointer-events:none}
.h-resizer::after{content:'';position:absolute;left:0;right:0;top:2px;height:1px;background:var(--border);transition:background .15s}
.h-resizer:hover::after,.h-resizer.dragging::after{background:var(--acc2);height:3px;top:1px}

/* question card content */
.pq-card{padding:14px 18px 12px;background:linear-gradient(135deg,rgba(0,200,150,.03) 0%,transparent 60%)}
.pq-meta{display:flex;align-items:center;gap:7px;margin-bottom:8px;flex-wrap:wrap}
.pq-badge{font-size:.62rem;padding:2px 8px;border-radius:99px;font-family:var(--mono);font-weight:700;text-transform:uppercase}
.pq-chapter{font-size:.62rem;color:var(--acc);font-weight:700;background:rgba(0,200,150,.08);border:1px solid rgba(0,200,150,.2);border-radius:99px;padding:2px 8px;font-family:var(--mono)}
.pq-title{font-weight:800;font-size:1rem;color:var(--txt);margin-bottom:5px;line-height:1.35}
.pq-desc{font-size:.84rem;color:var(--txt2);line-height:1.65}
.pq-desc code{background:rgba(0,200,150,.1);color:var(--acc);border-radius:3px;padding:1px 4px;font-family:var(--mono);font-size:.77rem}
.pq-inputs{margin-top:8px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.pq-inputs-lbl{font-size:.62rem;color:var(--acc4);font-family:var(--mono);font-weight:700;text-transform:uppercase}
.pq-chip{background:rgba(245,166,35,.1);color:var(--acc4);border:1px solid rgba(245,166,35,.2);border-radius:4px;padding:2px 7px;font-family:var(--mono);font-size:.7rem}
.pq-hint-wrap{margin-top:10px}
.pq-hint-btn{
  display:inline-flex;align-items:center;gap:5px;
  background:rgba(245,166,35,.07);border:1px solid rgba(245,166,35,.2);
  color:var(--acc4);border-radius:7px;padding:4px 11px;
  font-size:.75rem;cursor:pointer;user-select:none;font-family:var(--font);font-weight:700;transition:all .12s;
}
.pq-hint-btn:hover{background:rgba(245,166,35,.14)}
.pq-hint-body{
  margin-top:8px;background:rgba(124,111,255,.06);
  border:1px solid rgba(124,111,255,.16);border-radius:7px;
  padding:10px 12px;font-family:var(--mono);font-size:.76rem;
  color:var(--acc2);line-height:1.6;white-space:pre-wrap;
}

/* ‚ïê‚ïê‚ïê EDITOR BODY ‚ïê‚ïê‚ïê */
.editor-body{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}

/* mac dots bar */
.editor-bar{
  display:flex;align-items:center;gap:8px;padding:6px 12px;
  background:rgba(0,0,0,.15);border-bottom:1px solid var(--border);flex-shrink:0;
}
[data-theme="light"] .editor-bar{background:rgba(0,0,0,.04)}
.mac-dots{display:flex;gap:5px}
.mac-dot{width:9px;height:9px;border-radius:50%}
.mac-r{background:#ff5f57}.mac-y{background:#febc2e}.mac-g{background:#28c940}
.editor-filename{font-family:var(--mono);font-size:.7rem;color:var(--txt2)}
.editor-bar-r{margin-left:auto;display:flex;align-items:center;gap:8px}
.run-hint{display:flex;align-items:center;gap:3px;font-size:.62rem;color:var(--txt3)}

/* split editor+output */
.editor-split{flex:1;display:flex;overflow:hidden;min-height:0}
.monaco-col{flex:1;min-width:0;overflow:hidden;position:relative}
.output-col{
  width:38%;min-width:120px;max-width:55%;
  border-left:1px solid var(--border);
  display:flex;flex-direction:column;background:var(--code-bg);
  transition:background .25s,border-color .25s;
}
.output-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:5px 10px;border-bottom:1px solid var(--border);flex-shrink:0;
}
.output-label{font-family:var(--mono);font-size:.67rem;color:var(--txt2);display:flex;align-items:center;gap:5px}
.out-dot{width:7px;height:7px;border-radius:50%;background:var(--acc);box-shadow:0 0 4px var(--acc)}
.output-body{
  flex:1;overflow:auto;padding:10px 12px;
  font-family:var(--mono);font-size:.77rem;line-height:1.7;
  color:var(--txt2);white-space:pre-wrap;word-break:break-word;
}
.output-body.ok{color:var(--acc)}
.output-body.err{color:var(--acc3)}
.output-body.running{color:var(--acc4)}

/* ‚ïê‚ïê‚ïê FOOTER ACTION BAR ‚ïê‚ïê‚ïê */
.pg-footer{
  display:flex;align-items:center;gap:8px;
  padding:8px 14px;border-top:1px solid var(--border);
  background:var(--surf);flex-shrink:0;flex-wrap:wrap;
  transition:background .25s,border-color .25s;
}
.btn-run{
  display:flex;align-items:center;gap:6px;
  background:var(--acc2);color:#fff;border:none;
  border-radius:7px;padding:7px 15px;
  font-family:var(--font);font-weight:700;font-size:.78rem;
  cursor:pointer;transition:all .12s;white-space:nowrap;
}
.btn-run:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn-run:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-check{
  display:flex;align-items:center;gap:6px;
  background:linear-gradient(135deg,#e040fb,#8b00ff);color:#fff;border:none;
  border-radius:7px;padding:7px 15px;
  font-family:var(--font);font-weight:700;font-size:.78rem;
  cursor:pointer;transition:all .12s;white-space:nowrap;
}
.btn-check:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn-check:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-secondary{
  display:flex;align-items:center;gap:5px;
  background:var(--surf2);color:var(--txt2);
  border:1px solid var(--border);border-radius:7px;padding:7px 12px;
  font-family:var(--font);font-weight:700;font-size:.78rem;
  cursor:pointer;transition:all .12s;white-space:nowrap;
}
.btn-secondary:hover{border-color:var(--acc3);color:var(--acc3)}
.pg-result{
  flex:1;font-family:var(--mono);font-size:.73rem;
  color:var(--txt3);text-align:right;white-space:nowrap;
  overflow:hidden;text-overflow:ellipsis;min-width:0;
}
.pg-result.ok{color:var(--acc)}.pg-result.err{color:var(--acc3)}

/* ‚ïê‚ïê‚ïê CODE TAB (raw test) ‚ïê‚ïê‚ïê */
.raw-footer{display:flex;align-items:center;gap:8px;padding:8px 14px;border-top:1px solid var(--border);background:var(--surf);flex-shrink:0;flex-wrap:wrap}
.out-raw{
  flex:1;font-family:var(--mono);font-size:.71rem;
  color:var(--txt2);background:var(--surf2);border:1px solid var(--border);
  border-radius:5px;padding:5px 9px;min-height:30px;max-height:56px;
  overflow-y:auto;white-space:pre-wrap;transition:border-color .2s,color .2s;
}
.out-raw.ok{border-color:var(--acc);color:var(--acc)}
.out-raw.err{border-color:var(--acc3);color:var(--acc3)}
.out-raw.running{border-color:var(--acc4);color:var(--acc4)}
.exp-label{font-size:.63rem;color:var(--txt3);font-family:var(--mono);flex-shrink:0;max-width:120px;overflow:hidden;text-overflow:ellipsis}

/* ‚ïê‚ïê‚ïê BUTTONS (form area) ‚ïê‚ïê‚ïê */
.btn{
  display:inline-flex;align-items:center;gap:4px;
  padding:5px 11px;border-radius:6px;font-size:.74rem;
  font-family:var(--font);font-weight:700;cursor:pointer;
  border:none;transition:all .12s;white-space:nowrap;
}
.btn-sm{padding:3px 8px;font-size:.68rem;border-radius:5px}
.bp{background:var(--acc);color:#fff}.bp:hover{filter:brightness(1.08)}
.bs{background:transparent;color:var(--txt2);border:1px solid var(--border)}.bs:hover{border-color:var(--acc2);color:var(--acc2);background:rgba(124,111,255,.07)}
.bd{background:transparent;color:var(--acc3);border:1px solid rgba(255,107,107,.3)}.bd:hover{background:rgba(255,107,107,.1)}
.bx{background:linear-gradient(135deg,var(--acc),#00a07a);color:#fff}
.ic-btn{
  background:transparent;border:1px solid var(--border);color:var(--txt2);
  width:22px;height:22px;border-radius:4px;cursor:pointer;
  font-size:.65rem;display:flex;align-items:center;justify-content:center;
  transition:all .12s;flex-shrink:0;
}
.ic-btn:hover{border-color:var(--acc3);color:var(--acc3);background:rgba(255,107,107,.08)}
.col-btn{
  background:transparent;border:1px solid var(--border);color:var(--txt2);
  width:24px;height:24px;border-radius:5px;cursor:pointer;
  font-size:.68rem;display:flex;align-items:center;justify-content:center;
  transition:all .12s;flex-shrink:0;
}
.col-btn:hover{border-color:var(--acc);color:var(--acc);background:rgba(0,200,150,.07)}
.col-ic{transition:transform .2s;display:inline-block;line-height:1}
.sidebar.collapsed .col-ic{transform:rotate(180deg)}

/* ‚ïê‚ïê‚ïê TEST CASES ‚ïê‚ïê‚ïê */
.tc-box{background:var(--surf2);border:1px solid var(--border);border-radius:6px;overflow:hidden;transition:background .25s}
.tc-item{border-bottom:1px solid var(--border);overflow:hidden}
.tc-item:last-child{border-bottom:none}
.tc-head{
  display:flex;align-items:center;gap:6px;padding:6px 8px;
  cursor:pointer;user-select:none;background:transparent;border:none;
  width:100%;text-align:left;transition:background .12s;
}
.tc-head:hover{background:rgba(0,200,150,.04)}
.tc-num{
  font-family:var(--mono);font-size:.58rem;font-weight:700;
  background:var(--surf3);color:var(--acc);border-radius:3px;
  padding:1px 5px;flex-shrink:0;border:1px solid rgba(0,200,150,.2);
}
.tc-preview{font-family:var(--mono);font-size:.65rem;color:var(--txt2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tc-status{font-size:.65rem;flex-shrink:0;min-width:14px;text-align:center}
.tc-caret{font-size:.52rem;color:var(--txt3);flex-shrink:0;transition:transform .18s}
.tc-item.open .tc-caret{transform:rotate(90deg)}
.tc-body{display:none;padding:7px 8px 8px;border-top:1px solid var(--border);background:var(--surf3);gap:6px;flex-direction:column}
.tc-item.open .tc-body{display:flex}
.tc-body-label{font-size:.58rem;color:var(--txt3);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.tc-inlist{display:flex;flex-direction:column;gap:3px;margin-bottom:4px}
.tc-in-row{display:flex;align-items:center;gap:4px}
.tc-in-row input{font-family:var(--mono);font-size:.7rem;flex:1}
.tc-expected-input{
  font-family:var(--mono);font-size:.7rem;
  background:var(--surf2);border:1px solid var(--border);
  color:var(--acc);border-radius:5px;padding:4px 7px;
  resize:vertical;min-height:34px;width:100%;outline:none;
  transition:border-color .12s,box-shadow .12s;
}
.tc-expected-input:focus{border-color:var(--acc);box-shadow:0 0 0 2px rgba(0,200,150,.1)}
.tc-del-btn{background:transparent;border:1px solid rgba(255,107,107,.3);color:var(--acc3);border-radius:4px;padding:2px 7px;cursor:pointer;font-size:.63rem;font-family:var(--font);font-weight:700;transition:all .12s;margin-top:2px;align-self:flex-end}
.tc-del-btn:hover{background:rgba(255,107,107,.1)}
.tc-add-btn{width:100%;background:transparent;border:none;border-top:1px solid var(--border);color:var(--acc2);padding:5px;cursor:pointer;font-size:.7rem;font-family:var(--font);transition:background .12s}
.tc-add-btn:hover{background:rgba(124,111,255,.06)}
.tc-run-row{display:flex;align-items:center;gap:5px;padding:5px 7px;border-top:1px solid var(--border);background:var(--surf);flex-wrap:wrap}
.tc-run-btn{
  display:flex;align-items:center;gap:5px;
  background:rgba(124,111,255,.12);border:1px solid rgba(124,111,255,.28);
  color:var(--acc2);border-radius:6px;padding:4px 10px;
  font-family:var(--font);font-weight:700;font-size:.7rem;
  cursor:pointer;transition:all .12s;white-space:nowrap;
}
.tc-run-btn:hover{background:rgba(124,111,255,.24)}
.tc-run-btn:disabled{opacity:.4;cursor:not-allowed}
.tc-summary{font-family:var(--mono);font-size:.65rem;color:var(--txt2);flex:1;text-align:right}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toast-wrap{position:fixed;bottom:14px;right:14px;z-index:9999;display:flex;flex-direction:column;gap:4px;pointer-events:none}
.toast{
  background:var(--surf);border:1px solid var(--border);
  padding:8px 12px;border-radius:8px;font-size:.76rem;
  display:flex;align-items:center;gap:6px;
  animation:tIn .15s ease;box-shadow:0 4px 16px var(--shadow);
  pointer-events:auto;font-family:var(--font);
}
.toast.ok{border-color:var(--acc)}.toast.err{border-color:var(--acc3)}
@keyframes tIn{from{transform:translateX(16px);opacity:0}to{transform:none;opacity:1}}

/* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);animation:mFd .15s}
@keyframes mFd{from{opacity:0}to{opacity:1}}
.modal-box{background:var(--surf);border:1px solid var(--border);border-radius:12px;padding:20px;width:90%;max-width:520px;max-height:80vh;overflow-y:auto;animation:mPp .15s ease;font-family:var(--font)}
@keyframes mPp{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}
.modal-box h2{font-weight:800;font-size:.92rem;margin-bottom:12px}
.modal-box pre{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;font-family:var(--mono);font-size:.65rem;overflow:auto;max-height:360px;color:var(--acc);line-height:1.6}
.modal-foot{display:flex;gap:6px;justify-content:flex-end;margin-top:12px}

/* ‚ïê‚ïê‚ïê SPLASH ‚ïê‚ïê‚ïê */
#splash{position:fixed;inset:0;z-index:200;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;transition:background .25s}
.sp-logo{font-weight:800;font-size:1.4rem;display:flex;gap:7px;align-items:center}
.sp-logo em{color:var(--acc);font-style:normal}
.sp-bar{width:180px;height:3px;background:var(--surf2);border-radius:99px;overflow:hidden}
.sp-fill{height:100%;width:35%;background:var(--acc);border-radius:99px;animation:spAnim 1.4s ease-in-out infinite}
@keyframes spAnim{0%{transform:translateX(-100%)}60%{transform:translateX(300%)}100%{transform:translateX(300%)}}
.sp-txt{font-size:.71rem;color:var(--txt3);font-family:var(--mono)}

/* ‚ïê‚ïê‚ïê NO SELECT when dragging ‚ïê‚ïê‚ïê */
body.dragging{user-select:none}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-logo">üêç <em>Quiz</em>Builder</div>
  <div class="sp-bar"><div class="sp-fill"></div></div>
  <div class="sp-txt" id="spTxt">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</div>
</div>

<!-- HEADER -->
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="logo">üêç <em class="accent">Quiz</em>Builder</div>
    <!-- START COMMAND -->
    <!-- <div class="start-cmd" title="‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‚Äî ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ copy">
      <div class="cmd-dot"></div>
      <span class="cmd-label">START</span>
      <span>python -m http.server 8080</span>
    </div> -->
  </div>
  <div class="hdr-r">
    <div class="py-status">
      <div class="s-dot loading" id="sdot"></div>
      <span id="stxt">‡πÇ‡∏´‡∏•‡∏î Pyodide...</span>
    </div>
    <div class="theme-btn" onclick="toggleTheme()" title="Dark / Light">
      <div class="tt-track"><div class="tt-thumb"></div></div>
      <span id="themeLabel">Dark</span>
    </div>
    <button class="btn btn-sm bs" onclick="importJSON()">üìÇ Import</button>
    <button class="btn btn-sm bx" onclick="showExport()">üì§ Export</button>
  </div>
</header>

<!-- ROOT -->
<div class="root">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sb-top">
      <button class="col-btn" onclick="toggleSb()" title="Ctrl+B"><span class="col-ic">‚óÄ</span></button>
      <div class="sb-meta">
        <span class="sb-label">‡πÇ‡∏à‡∏ó‡∏¢‡πå</span>
        <span class="q-count" id="qCount">0</span>
        <button class="btn btn-sm bp" onclick="newQ()" style="padding:2px 7px;margin-left:auto">+</button>
      </div>
    </div>
    <div class="q-list" id="qList">
      <div style="padding:24px 8px;text-align:center;color:var(--txt3);font-size:.71rem">
        <div style="font-size:1.6rem;margin-bottom:6px;opacity:.2">üìù</div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
      </div>
    </div>
  </aside>

  <div class="resizer v" id="rSb"></div>

  <!-- MAIN -->
  <main class="main">

    <div class="empty-state" id="emptyMain">
      <div class="empty-icon">üéØ</div>
      <div style="color:var(--txt2);font-size:.84rem">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà</div>
      <button class="btn bp" onclick="newQ()">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÅ‡∏£‡∏Å</button>
    </div>

    <div id="editorMain" style="display:none;flex:1;overflow:hidden;min-height:0">

      <!-- FORM PANE -->
      <div class="form-pane" id="formPane">
        <div class="pane-head">
          <div class="pane-title"><div class="dot-g"></div>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå</div>
          <div style="display:flex;gap:4px">
            <button class="btn btn-sm bd" onclick="delQ()" title="‡∏•‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå">üóë</button>
            <button class="btn btn-sm bp" onclick="saveQ()" title="Ctrl+S">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
        </div>
        <div class="form-scroll">
          <div class="section-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
          <div class="f2">
            <div class="field">
              <label>ID <span class="req">*</span></label>
              <input type="number" id="f-id" placeholder="1" oninput="lp()">
            </div>
            <div class="field">
              <label>Type</label>
              <select id="f-type" onchange="syncBadge();lp()">
                <option value="print">print</option>
                <option value="var">var</option>
                <option value="input">input</option>
                <option value="if">if</option>
                <option value="loop">loop</option>
                <option value="fn">fn</option>
                <option value="custom">custom</option>
              </select>
            </div>
          </div>
          <div class="field">
            <label>Chapter <span class="hint-lbl">(‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡∏ö‡∏ó)</span></label>
            <input type="text" id="f-chapter" placeholder="üñ®Ô∏è ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1: ..." oninput="lp()">
          </div>
          <div class="field">
            <label>Title <span class="req">*</span></label>
            <input type="text" id="f-title" placeholder="‡∏Ç‡πâ‡∏≠ 1 ‚Äî Hello, World!" oninput="lp()">
          </div>
          <div class="f2">
            <div class="field">
              <label>Badge text</label>
              <input type="text" id="f-badge" placeholder="print" oninput="lp()">
            </div>
            <div class="field">
              <label>Badge style</label>
              <select id="f-badgeClass" onchange="lp()">
                <option value="badge-print">print (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
                <option value="badge-var">var (‡∏°‡πà‡∏ß‡∏á)</option>
                <option value="badge-input">input (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)</option>
                <option value="badge-if">if (‡πÅ‡∏î‡∏á)</option>
                <option value="badge-loop">loop (‡∏ü‡πâ‡∏≤)</option>
                <option value="badge-fn">fn (‡∏™‡πâ‡∏°)</option>
                <option value="badge-custom">custom (‡πÄ‡∏ó‡∏≤)</option>
              </select>
            </div>
          </div>

          <div class="sep"></div>
          <div class="section-label">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</div>
          <div class="field">
            <label>Desc <span class="req">*</span> <span class="hint-lbl">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HTML</span></label>
            <textarea id="f-desc" rows="3" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÅ‡∏™‡∏î‡∏á &lt;b&gt;Hello&lt;/b&gt;" oninput="lp()"></textarea>
          </div>
          <div class="field">
            <label>Hint</label>
            <textarea id="f-hint" rows="2" placeholder='print("Hello")' oninput="lp()"></textarea>
          </div>

          <div class="sep"></div>
          <div class="section-label">Starter Code</div>
          <div class="field">
            <textarea id="f-starter" class="code-ta" rows="5" placeholder="# ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà&#10;" oninput="syncStarterToMonaco();lp()"></textarea>
          </div>

          <div class="sep"></div>
          <div class="section-label">‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
          <div class="field">
            <label>Expected output <span class="req">*</span></label>
            <textarea id="f-expected" rows="2" placeholder="Hello, World!" style="font-family:var(--mono)" oninput="lp()"></textarea>
          </div>
          <div class="field">
            <label>Inputs <span class="hint-lbl">(‡πÅ‡∏ï‡πà‡∏•‡∏∞ input = 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)</span></label>
            <div class="inputs-box">
              <div class="in-list" id="inList"></div>
              <button class="add-in" onclick="addInput()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° input</button>
            </div>
          </div>

          <div class="sep"></div>
          <div class="section-label">Test Cases</div>
          <div class="field">
            <div class="tc-box">
              <div id="tcList"></div>
              <button class="tc-add-btn" onclick="addTestCase()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Test Case</button>
            </div>
          </div>
          <div class="tc-run-row" id="tcRunRow" style="display:none">
            <button class="tc-run-btn" id="tcRunAllBtn" onclick="runAllTestCases()" disabled>‚ñ∂ ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å TC</button>
            <span class="tc-summary" id="tcSummary"></span>
          </div>
          <div style="height:6px"></div>
        </div>
      </div>

      <div class="resizer v" id="rFP"></div>

      <!-- PLAYGROUND PANE -->
      <div class="pg-pane" id="pgPane">

        <!-- PG HEADER with tabs -->
        <div class="pg-head">
          <div class="pg-tabs">
            <div class="pg-tab active" id="tabPreview" onclick="setTab('preview')">üëÅ Preview</div>
            <div class="pg-tab" id="tabCode" onclick="setTab('code')">‚å®Ô∏è ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
          </div>
          <div class="pg-head-r">
            <div class="py-status" style="padding:0 2px">
              <div class="s-dot loading" id="sdot2"></div>
              <span id="stxt2" style="font-size:.63rem;color:var(--txt3)">‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
            <button class="ghost-btn" id="closePreviewBtn" onclick="togglePreview()" title="‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå">
              <span id="closePreviewIcon">‚ñ≤</span> <span id="closePreviewTxt">‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏à‡∏ó‡∏¢‡πå</span>
            </button>
            <button class="ghost-btn" onclick="toggleFullscreen()" id="fsBtn">‚õ∂ ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ TAB: PREVIEW ‚îÄ‚îÄ -->
        <div id="pgPreview" style="flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0">

          <!-- Collapsible question card -->
          <div id="pqHeader">
            <div id="pqWrap">
              <div style="padding:40px 20px;text-align:center;color:var(--txt3);font-size:.8rem;opacity:.4">
                <div style="font-size:1.8rem;margin-bottom:8px">üëÅ</div>
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Preview
              </div>
            </div>
          </div>

          <div class="h-resizer" id="hRz"></div>

          <!-- Editor + Output (Monaco in preview) -->
          <div class="editor-body">
            <div class="editor-bar">
              <div class="mac-dots">
                <div class="mac-dot mac-r"></div>
                <div class="mac-dot mac-y"></div>
                <div class="mac-dot mac-g"></div>
              </div>
              <span class="editor-filename">main.py</span>
              <div class="editor-bar-r">
                <div class="run-hint">
                  <span class="kbd">Ctrl</span><span style="font-size:.6rem;color:var(--txt3)">+</span><span class="kbd">‚Üµ</span>
                  <span style="font-size:.62rem;color:var(--txt3);margin-left:2px">‡∏£‡∏±‡∏ô</span>
                </div>
              </div>
            </div>
            <div class="editor-split">
              <!-- Monaco Editor (Preview tab) -->
              <div class="monaco-col">
                <div id="monacoPreview" style="width:100%;height:100%"></div>
              </div>
              <!-- Output panel -->
              <div class="output-col">
                <div class="output-header">
                  <div class="output-label">
                    <div class="out-dot"></div>
                    Output
                  </div>
                  <button class="ghost-btn" onclick="clearPg()" style="padding:2px 6px;font-size:.62rem">üóë ‡∏•‡πâ‡∏≤‡∏á</button>
                </div>
                <div class="output-body" id="pqOutCol">// ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà üéØ</div>
              </div>
            </div>
            <div class="pg-footer">
              <button class="btn-run" id="pgRunBtn" onclick="runAndShow()" disabled>‚ñ∂ ‡∏£‡∏±‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</button>
              <button class="btn-check" id="pgCheckBtn" onclick="checkAndShow()" disabled>‚úì ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
              <div class="pg-result" id="pgResult"></div>
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ TAB: CODE ‚îÄ‚îÄ -->
        <div id="pgCode" style="flex:1;display:none;flex-direction:column;overflow:hidden;min-height:0">
          <div class="editor-bar">
            <div class="mac-dots">
              <div class="mac-dot mac-r"></div>
              <div class="mac-dot mac-y"></div>
              <div class="mac-dot mac-g"></div>
            </div>
            <span class="editor-filename">sandbox.py</span>
            <div class="editor-bar-r">
              <div class="run-hint">
                <span class="kbd">Ctrl</span><span style="font-size:.6rem;color:var(--txt3)">+</span><span class="kbd">‚Üµ</span>
                <span style="font-size:.62rem;color:var(--txt3);margin-left:2px">‡∏£‡∏±‡∏ô</span>
              </div>
            </div>
          </div>
          <div style="flex:1;min-height:0;position:relative">
            <div id="monacoTest" style="width:100%;height:100%"></div>
          </div>
          <div class="raw-footer">
            <button class="btn-run" id="runBtn2" onclick="runRaw()" disabled>‚ñ∂ ‡∏£‡∏±‡∏ô</button>
            <button class="btn-secondary" onclick="clearRaw()">üóë ‡∏•‡πâ‡∏≤‡∏á</button>
            <div class="out-raw" id="outRaw">// ‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div>
            <span class="exp-label" id="expLbl">expected: ‚Äî</span>
          </div>
        </div>

      </div><!-- /pg-pane -->
    </div><!-- /editorMain -->
  </main>
</div><!-- /root -->

<div class="toast-wrap" id="toastW"></div>

<!-- EXPORT MODAL -->
<div class="modal-overlay" id="expModal" style="display:none" onclick="if(event.target===this)closeExport()">
  <div class="modal-box">
    <h2>üì§ Export JSON</h2>
    <pre id="expPre"></pre>
    <div class="modal-foot">
      <button class="btn btn-sm bs" onclick="closeExport()">‡∏õ‡∏¥‡∏î</button>
      <button class="btn btn-sm bp" onclick="copyExport()">üìã Copy</button>
      <button class="btn btn-sm bx" onclick="dlExport()">‚¨áÔ∏è Download</button>
    </div>
  </div>
</div>

<input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">

<script>
/* ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê */
let questions=[], curIdx=-1;
let monacoPreviewEditor=null, monacoTestEditor=null;
let pyodide=null, pyReady=false;
let sbCollapsed=false, hintOpen=false, isFullscreen=false;
let activeTab='preview', previewHidden=false;

const EXERCISES_URL='https://raw.githubusercontent.com/Karibura-Cyber/python-playground/refs/heads/main/exercises.json';

/* ‚ïê‚ïê‚ïê THEME ‚ïê‚ïê‚ïê */
(function(){
  const saved=localStorage.getItem('qb-theme')||'dark';
  document.documentElement.setAttribute('data-theme',saved);
  document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('themeLabel').textContent=saved==='dark'?'Dark':'Light';
  });
})();

function toggleTheme(){
  const html=document.documentElement;
  const dark=html.getAttribute('data-theme')==='dark';
  const next=dark?'light':'dark';
  html.setAttribute('data-theme',next);
  document.getElementById('themeLabel').textContent=dark?'Light':'Dark';
  const mt=dark?'qd-light':'qd-dark';
  if(monacoPreviewEditor) monaco.editor.setTheme(mt);
  if(monacoTestEditor) monaco.editor.setTheme(mt);
  localStorage.setItem('qb-theme',next);
}

/* ‚ïê‚ïê‚ïê MONACO SETUP ‚ïê‚ïê‚ïê */
require.config({paths:{vs:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs'}});
require(['vs/editor/editor.main'],()=>{

  monaco.editor.defineTheme('qd-dark',{
    base:'vs-dark',inherit:true,
    rules:[
      {token:'comment',foreground:'4a6080',fontStyle:'italic'},
      {token:'keyword',foreground:'7c6fff'},
      {token:'string',foreground:'00c896'},
      {token:'number',foreground:'f5a623'},
    ],
    colors:{
      'editor.background':'#0d0f14','editor.foreground':'#e8eaf0',
      'editorLineNumber.foreground':'#2a3045','editorCursor.foreground':'#00c896',
      'editor.selectionBackground':'#2a3a50','editor.lineHighlightBackground':'#161922',
    }
  });

  monaco.editor.defineTheme('qd-light',{
    base:'vs-dark',inherit:true,
    rules:[
      {token:'comment',foreground:'7a8aaf',fontStyle:'italic'},
      {token:'keyword',foreground:'8b7fff'},
      {token:'string',foreground:'00c896'},
      {token:'number',foreground:'f5a623'},
    ],
    colors:{
      'editor.background':'#1a1e2e','editor.foreground':'#e8eaf0',
      'editorLineNumber.foreground':'#3a4566','editorCursor.foreground':'#00c896',
      'editor.selectionBackground':'#2a3a50','editor.lineHighlightBackground':'#232840',
    }
  });

  const curTheme=document.documentElement.getAttribute('data-theme')==='light'?'qd-light':'qd-dark';
  const sharedOpts={
    language:'python',theme:curTheme,
    fontSize:13,fontFamily:"'JetBrains Mono',monospace",
    lineHeight:22,minimap:{enabled:false},
    scrollBeyondLastLine:false,
    padding:{top:10,bottom:10},
    wordWrap:'on',automaticLayout:true,
    tabSize:4,insertSpaces:true,
    scrollbar:{verticalScrollbarSize:4,horizontalScrollbarSize:4},
  };

  // Preview editor ‚Äî shows starter code, student edits here
  monacoPreviewEditor=monaco.editor.create(document.getElementById('monacoPreview'),{
    ...sharedOpts,
    value:'# ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n',
  });

  // Test/sandbox editor ‚Äî free scratch pad
  monacoTestEditor=monaco.editor.create(document.getElementById('monacoTest'),{
    ...sharedOpts,
    value:'# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n',
  });

  initApp();
});

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
async function initApp(){
  setSplash('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏à‡∏≤‡∏Å GitHub...');
  await fetchExercises();
  hideSplash();
  initResizers();
  initHResizer();
  startPyodide();
}

async function fetchExercises(){
  try{
    const r=await fetch(EXERCISES_URL);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const d=await r.json();
    if(!Array.isArray(d)) throw new Error('‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array');
    questions=d; renderSb();
    if(questions.length) selectQ(0);
    toast(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î ${d.length} ‡∏Ç‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,'ok');
  }catch(e){
    questions=[]; renderSb();
    toast('‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message,'err');
  }
}

function setSplash(t){const el=document.getElementById('spTxt');if(el)el.textContent=t}
function hideSplash(){
  const el=document.getElementById('splash');
  el.style.transition='opacity .3s'; el.style.opacity='0';
  setTimeout(()=>el.style.display='none',320);
}

/* ‚ïê‚ïê‚ïê PYODIDE ‚ïê‚ïê‚ïê */
function startPyodide(){
  const s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js';
  s.onload=async()=>{
    try{
      pyodide=await loadPyodide({indexURL:'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/'});
      pyReady=true; setDot('ready','Pyodide ‡∏û‡∏£‡πâ‡∏≠‡∏°');
      if(curIdx>=0){
        enableRunBtns(true);
        const q=questions[curIdx];
        if(q?.testCases?.length) renderTestCases(q.testCases);
      }
      toast('‚úÖ Pyodide ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','ok');
    }catch{setDot('error','‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î')}
  };
  s.onerror=()=>setDot('error','‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
  document.head.appendChild(s);
}

function setDot(c,t){
  ['sdot','sdot2'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.className='s-dot '+c;
  });
  ['stxt','stxt2'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.textContent=t;
  });
}

function enableRunBtns(on){
  ['pgRunBtn','pgCheckBtn','runBtn2'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.disabled=!on;
  });
}

/* ‚ïê‚ïê‚ïê RESIZERS ‚ïê‚ïê‚ïê */
function initResizers(){
  mkDrag(document.getElementById('rSb'),dx=>{
    if(sbCollapsed) return;
    const sb=document.getElementById('sidebar');
    sb.style.width=Math.max(180,Math.min(460,sb.getBoundingClientRect().width+dx))+'px';
    layoutMonaco();
  });
  mkDrag(document.getElementById('rFP'),dx=>{
    const fp=document.getElementById('formPane');
    fp.style.width=Math.max(200,Math.min(500,fp.getBoundingClientRect().width+dx))+'px';
    layoutMonaco();
  });
}
function initHResizer(){
  const hz=document.getElementById('hRz');
  hz.addEventListener('mousedown',e=>{
    e.preventDefault();
    let last=e.clientY;
    hz.classList.add('dragging');
    document.body.classList.add('dragging');
    const mv=e2=>{
      const dy=e2.clientY-last; last=e2.clientY;
      const header=document.getElementById('pqHeader');
      const cur=header.getBoundingClientRect().height;
      header.style.maxHeight=Math.max(60,Math.min(500,cur+dy))+'px';
      layoutMonaco();
    };
    const up=()=>{
      hz.classList.remove('dragging');
      document.body.classList.remove('dragging');
      document.removeEventListener('mousemove',mv);
      document.removeEventListener('mouseup',up);
    };
    document.addEventListener('mousemove',mv);
    document.addEventListener('mouseup',up);
  });
}
function mkDrag(el,onDx){
  el.addEventListener('mousedown',e=>{
    e.preventDefault();
    let last=e.clientX;
    el.classList.add('dragging');
    document.body.classList.add('dragging');
    const mv=e2=>{onDx(e2.clientX-last); last=e2.clientX};
    const up=()=>{
      el.classList.remove('dragging');
      document.body.classList.remove('dragging');
      document.removeEventListener('mousemove',mv);
      document.removeEventListener('mouseup',up);
    };
    document.addEventListener('mousemove',mv);
    document.addEventListener('mouseup',up);
  });
}
function layoutMonaco(){
  if(monacoPreviewEditor) monacoPreviewEditor.layout();
  if(monacoTestEditor) monacoTestEditor.layout();
}

/* ‚ïê‚ïê‚ïê TOGGLE PREVIEW ‚ïê‚ïê‚ïê */
function togglePreview(){
  previewHidden=!previewHidden;
  document.getElementById('pqHeader').classList.toggle('hidden',previewHidden);
  document.getElementById('hRz').classList.toggle('hidden',previewHidden);
  document.getElementById('closePreviewIcon').textContent=previewHidden?'‚ñº':'‚ñ≤';
  document.getElementById('closePreviewTxt').textContent=previewHidden?'‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå':'‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏à‡∏ó‡∏¢‡πå';
  document.getElementById('closePreviewBtn').classList.toggle('toggled',previewHidden);
  setTimeout(layoutMonaco,240);
}

/* ‚ïê‚ïê‚ïê FULLSCREEN ‚ïê‚ïê‚ïê */
function toggleFullscreen(){
  isFullscreen=!isFullscreen;
  const pg=document.getElementById('pgPane');
  const btn=document.getElementById('fsBtn');
  pg.classList.toggle('fullscreen',isFullscreen);
  btn.textContent=isFullscreen?'‚úï ‡∏≠‡∏≠‡∏Å':'‚õ∂ ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠';
  btn.classList.toggle('danger',isFullscreen);
  setTimeout(layoutMonaco,50);
}

/* ‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê */
function setTab(tab){
  activeTab=tab;
  document.getElementById('tabPreview').classList.toggle('active',tab==='preview');
  document.getElementById('tabCode').classList.toggle('active',tab==='code');
  document.getElementById('pgPreview').style.display=tab==='preview'?'flex':'none';
  document.getElementById('pgCode').style.display=tab==='code'?'flex':'none';
  document.getElementById('closePreviewBtn').style.display=tab==='preview'?'':'none';
  if(tab==='code') monacoTestEditor?.layout();
  if(tab==='preview') monacoPreviewEditor?.layout();
}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
function toggleSb(){
  sbCollapsed=!sbCollapsed;
  document.getElementById('sidebar').classList.toggle('collapsed',sbCollapsed);
  setTimeout(layoutMonaco,230);
}

/* ‚ïê‚ïê‚ïê RENDER SIDEBAR ‚ïê‚ïê‚ïê */
function renderSb(){
  const l=document.getElementById('qList');
  document.getElementById('qCount').textContent=questions.length;
  if(!questions.length){
    l.innerHTML=`<div style="padding:24px 8px;text-align:center;color:var(--txt3);font-size:.7rem"><div style="font-size:1.6rem;margin-bottom:6px;opacity:.2">üìù</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏à‡∏ó‡∏¢‡πå</div>`;
    return;
  }
  let html='', lastCh=null;
  questions.forEach((q,i)=>{
    if(q.chapter&&q.chapter!==lastCh){html+=`<div class="q-chapter">${esc(q.chapter)}</div>`;lastCh=q.chapter;}
    else if(!q.chapter) lastCh=null;
    html+=`<div class="q-item${i===curIdx?' active':''}" onclick="selectQ(${i})">
      <div class="q-row">
        <span class="q-num">#${q.id}</span>
        <span class="q-name">${esc(q.title||'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠')}</span>
        <span class="q-badge ${q.badgeClass||'badge-custom'}">${esc(q.badge||q.type||'')}</span>
      </div>
      <button class="q-del" onclick="event.stopPropagation();delAt(${i})" title="‡∏•‡∏ö">‚úï</button>
    </div>`;
  });
  l.innerHTML=html;
  setTimeout(()=>{const a=l.querySelector('.q-item.active');if(a)a.scrollIntoView({block:'nearest'})},40);
}

/* ‚ïê‚ïê‚ïê SELECT QUESTION ‚ïê‚ïê‚ïê */
function selectQ(i){
  curIdx=i;
  const q=questions[i];
  renderSb();
  document.getElementById('emptyMain').style.display='none';
  document.getElementById('editorMain').style.display='flex';

  document.getElementById('f-id').value=q.id??'';
  document.getElementById('f-chapter').value=q.chapter||'';
  document.getElementById('f-title').value=q.title||'';
  document.getElementById('f-badge').value=q.badge||'';
  document.getElementById('f-badgeClass').value=q.badgeClass||'badge-custom';
  document.getElementById('f-type').value=q.type||'print';
  document.getElementById('f-desc').value=q.desc||'';
  document.getElementById('f-hint').value=q.hint||'';
  document.getElementById('f-starter').value=q.starterCode||'# ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n';
  document.getElementById('f-expected').value=q.expected||'';
  renderInputs(q.inputs||[]);
  renderTestCases(q.testCases||[]);

  const code=q.starterCode||'# ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n';
  if(monacoPreviewEditor) monacoPreviewEditor.setValue(code);
  if(monacoTestEditor) monacoTestEditor.setValue(code);

  document.getElementById('expLbl').textContent='expected: '+(q.expected?q.expected.replace(/\n/g,'‚Üµ'):'‚Äî');

  const outEl=document.getElementById('pqOutCol');
  outEl.textContent='// ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà üéØ';
  outEl.className='output-body';
  document.getElementById('pgResult').textContent='';
  document.getElementById('pgResult').className='pg-result';
  document.getElementById('outRaw').textContent='// ‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå';
  document.getElementById('outRaw').className='out-raw';

  enableRunBtns(pyReady);
  hintOpen=false;
  renderPreview();
}

function syncBadge(){
  const t=document.getElementById('f-type').value;
  document.getElementById('f-badge').value=t;
  document.getElementById('f-badgeClass').value='badge-'+t;
}

function syncStarterToMonaco(){
  const v=document.getElementById('f-starter').value;
  if(monacoPreviewEditor) monacoPreviewEditor.setValue(v);
}

function lp(){renderPreview()}

/* ‚ïê‚ïê‚ïê RENDER PREVIEW ‚ïê‚ïê‚ïê */
function renderPreview(){
  if(curIdx<0) return;
  const title=document.getElementById('f-title').value||'(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)';
  const chapter=document.getElementById('f-chapter').value.trim();
  const badge=document.getElementById('f-badge').value||'';
  const badgeCls=document.getElementById('f-badgeClass').value||'badge-custom';
  const desc=document.getElementById('f-desc').value||'';
  const hint=document.getElementById('f-hint').value||'';
  const inputs=getInputs();

  const chTag=chapter?`<span class="pq-chapter">${esc(chapter)}</span>`:'';
  const bdgTag=badge?`<span class="pq-badge ${esc(badgeCls)}">${esc(badge)}</span>`:'';
  const inputHtml=inputs.length?`<div class="pq-inputs"><span class="pq-inputs-lbl">‚ö° inputs:</span>${inputs.map(v=>`<span class="pq-chip">${esc(v)}</span>`).join('')}</div>`:'';
  const hintHtml=hint?`<div class="pq-hint-wrap">
    <button class="pq-hint-btn" onclick="toggleHint()">üí° ${hintOpen?'‡∏ã‡πà‡∏≠‡∏ô hint':'‡πÅ‡∏™‡∏î‡∏á hint'}</button>
    ${hintOpen?`<div class="pq-hint-body">${esc(hint)}</div>`:''}
  </div>`:'';

  document.getElementById('pqWrap').innerHTML=`
    <div class="pq-card">
      <div class="pq-meta">${bdgTag}${chTag}</div>
      <div class="pq-title">${esc(title)}</div>
      <div class="pq-desc">${desc}</div>
      ${inputHtml}${hintHtml}
    </div>`;
}

function toggleHint(){hintOpen=!hintOpen;renderPreview()}

/* ‚ïê‚ïê‚ïê PYODIDE RUN ‚ïê‚ïê‚ïê */
async function pyRun(code,inputs){
  const wrapped=`
import sys,builtins
from io import StringIO
_inp=${JSON.stringify(inputs)}
_ix=[0];_buf=StringIO()
def _in(p=''):
    v=_inp[_ix[0]] if _ix[0]<len(_inp) else ''
    _ix[0]+=1;return v
builtins.input=_in;_old=sys.stdout;sys.stdout=_buf
try:
${code.split('\n').map(l=>'    '+l).join('\n')}
finally:
    sys.stdout=_old
_buf.getvalue()`;
  return String((await pyodide.runPythonAsync(wrapped))??'').trimEnd();
}

function getCode(){
  if(activeTab==='preview') return monacoPreviewEditor?monacoPreviewEditor.getValue():'';
  return monacoTestEditor?monacoTestEditor.getValue():'';
}

async function runAndShow(){
  if(!pyReady) return;
  const outEl=document.getElementById('pqOutCol');
  outEl.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô...';
  outEl.className='output-body running';
  document.getElementById('pgResult').textContent='';
  try{
    const out=await pyRun(monacoPreviewEditor?monacoPreviewEditor.getValue():'',getInputs());
    outEl.textContent=out||'(‡πÑ‡∏°‡πà‡∏°‡∏µ output)';
    outEl.className='output-body ok';
  }catch(e){
    outEl.textContent='‚ùå '+e.message;
    outEl.className='output-body err';
  }
}

async function checkAndShow(){
  if(!pyReady) return;
  const expected=document.getElementById('f-expected').value.trim();
  const outEl=document.getElementById('pqOutCol');
  const resEl=document.getElementById('pgResult');
  outEl.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à...';
  outEl.className='output-body running';
  try{
    const out=await pyRun(monacoPreviewEditor?monacoPreviewEditor.getValue():'',getInputs());
    outEl.textContent=out||'(‡πÑ‡∏°‡πà‡∏°‡∏µ output)';
    const norm=s=>s.split('\n').map(l=>l.trimEnd()).join('\n').trim();
    if(expected&&norm(out)===norm(expected)){
      outEl.className='output-body ok';
      resEl.textContent='‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!'; resEl.className='pg-result ok';
      toast('‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!','ok');
    }else if(expected){
      outEl.className='output-body err';
      resEl.textContent=`‚ùå ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‚Äî expected: ${expected.replace(/\n/g,'‚Üµ')}`;
      resEl.className='pg-result err';
      toast('‚ùå ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á','err');
    }else{
      outEl.className='output-body ok';
      resEl.textContent='';
    }
  }catch(e){
    outEl.textContent='‚ùå '+e.message;
    outEl.className='output-body err';
  }
}

function clearPg(){
  const code=document.getElementById('f-starter').value||'# ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n';
  if(monacoPreviewEditor) monacoPreviewEditor.setValue(code);
  const outEl=document.getElementById('pqOutCol');
  outEl.textContent='// ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà üéØ';
  outEl.className='output-body';
  document.getElementById('pgResult').textContent='';
  document.getElementById('pgResult').className='pg-result';
}

async function runRaw(){
  if(!pyReady||!monacoTestEditor) return;
  const expected=document.getElementById('f-expected').value.trim();
  const out=document.getElementById('outRaw');
  out.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô...'; out.className='out-raw running';
  try{
    const output=await pyRun(monacoTestEditor.getValue(),getInputs());
    const norm=s=>s.split('\n').map(l=>l.trimEnd()).join('\n').trim();
    if(expected&&norm(output)===norm(expected)){
      out.className='out-raw ok'; out.textContent='‚úÖ '+output; toast('‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!','ok');
    }else if(expected){
      out.className='out-raw err'; out.textContent=output||'(‡πÑ‡∏°‡πà‡∏°‡∏µ output)'; toast('‚ùå ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á','err');
    }else{
      out.className='out-raw'; out.textContent=output||'(‡πÑ‡∏°‡πà‡∏°‡∏µ output)';
    }
  }catch(e){
    out.textContent='‚ùå '+e.message; out.className='out-raw err';
  }
}

function clearRaw(){
  const code=document.getElementById('f-starter').value||'# ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n';
  if(monacoTestEditor) monacoTestEditor.setValue(code);
  document.getElementById('outRaw').textContent='// ‡∏£‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå';
  document.getElementById('outRaw').className='out-raw';
}

/* ‚ïê‚ïê‚ïê INPUTS ‚ïê‚ïê‚ïê */
function renderInputs(arr){
  const l=document.getElementById('inList');
  if(!arr||!arr.length){l.innerHTML='';return}
  l.innerHTML=arr.map((v,i)=>`<div class="in-row"><input type="text" value="${esc(v)}" placeholder="input ${i+1}" oninput="upIn(${i},this.value)"><button class="ic-btn" onclick="rmIn(${i})">‚úï</button></div>`).join('');
}
function addInput(){
  const q=questions[curIdx];if(!q)return;
  if(!q.inputs)q.inputs=[];
  q.inputs.push(''); renderInputs(q.inputs); lp();
}
function rmIn(i){questions[curIdx].inputs.splice(i,1);renderInputs(questions[curIdx].inputs);lp()}
function upIn(i,v){questions[curIdx].inputs[i]=v;lp()}
function getInputs(){return[...document.getElementById('inList').querySelectorAll('.in-row input')].map(r=>r.value)}

/* ‚ïê‚ïê‚ïê TEST CASES ‚ïê‚ïê‚ïê */
function renderTestCases(tcs){
  const list=document.getElementById('tcList');
  const runRow=document.getElementById('tcRunRow');
  if(!tcs||!tcs.length){list.innerHTML='';runRow.style.display='none';document.getElementById('tcSummary').textContent='';return}
  runRow.style.display='flex';
  list.innerHTML=tcs.map((tc,i)=>{
    const inPreview=(tc.inputs||[]).length?`in:[${tc.inputs.join(', ')}]`:'no input';
    const expPreview=tc.expected?`‚Üí "${tc.expected.replace(/\n/g,'‚Üµ').substring(0,24)}"`:' ‚Äî ';
    const statusIcon=tc._status==='pass'?'‚úÖ':tc._status==='fail'?'‚ùå':'';
    return `<div class="tc-item" id="tci-${i}">
      <button class="tc-head" onclick="toggleTc(${i})">
        <span class="tc-num">TC ${i+1}</span>
        <span class="tc-preview">${esc(inPreview)} ${esc(expPreview)}</span>
        <span class="tc-status" id="tc-stat-${i}">${statusIcon}</span>
        <span class="tc-caret">‚ñ∂</span>
      </button>
      <div class="tc-body">
        <div>
          <div class="tc-body-label">Inputs</div>
          <div class="tc-inlist" id="tc-inlist-${i}">${(tc.inputs||[]).map((v,j)=>`<div class="tc-in-row"><input type="text" value="${esc(v)}" placeholder="input ${j+1}" oninput="tcUpIn(${i},${j},this.value)"><button class="ic-btn" onclick="tcRmIn(${i},${j})">‚úï</button></div>`).join('')}</div>
          <button class="add-in" style="border-top:none;border-radius:4px;margin-top:3px" onclick="tcAddIn(${i})">+ input</button>
        </div>
        <div>
          <div class="tc-body-label">Expected output</div>
          <textarea class="tc-expected-input" rows="2" placeholder="‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á" oninput="tcUpExp(${i},this.value)">${esc(tc.expected||'')}</textarea>
        </div>
        <div style="display:flex;gap:5px;align-items:center">
          <button class="tc-run-btn" style="font-size:.66rem;padding:3px 9px" onclick="runSingleTc(${i})" ${!pyReady?'disabled':''}>‚ñ∂ ‡∏£‡∏±‡∏ô</button>
          <span id="tc-out-${i}" style="font-family:var(--mono);font-size:.65rem;color:var(--txt2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
          <button class="tc-del-btn" onclick="delTestCase(${i})">üóë ‡∏•‡∏ö</button>
        </div>
      </div>
    </div>`;
  }).join('');
  tcs.forEach((tc,i)=>{if(tc._open) document.getElementById(`tci-${i}`)?.classList.add('open')});
  document.getElementById('tcRunAllBtn').disabled=!pyReady;
}

function toggleTc(i){
  const q=questions[curIdx];if(!q||!q.testCases)return;
  q.testCases[i]._open=!q.testCases[i]._open;
  document.getElementById(`tci-${i}`)?.classList.toggle('open',q.testCases[i]._open);
}

function addTestCase(){
  const q=questions[curIdx];if(!q)return;
  if(!q.testCases)q.testCases=[];
  const isFirst=q.testCases.length===0;
  q.testCases.push({inputs:isFirst?getInputs():[],expected:isFirst?document.getElementById('f-expected').value.trim():'',_open:true,_status:''});
  renderTestCases(q.testCases);
}

function delTestCase(i){
  const q=questions[curIdx];if(!q||!q.testCases)return;
  q.testCases.splice(i,1); renderTestCases(q.testCases);
}

function tcAddIn(tcIdx){
  const q=questions[curIdx];if(!q?.testCases?.[tcIdx])return;
  if(!q.testCases[tcIdx].inputs)q.testCases[tcIdx].inputs=[];
  q.testCases[tcIdx].inputs.push('');
  renderTestCases(q.testCases);
  q.testCases[tcIdx]._open=true;
  document.getElementById(`tci-${tcIdx}`)?.classList.add('open');
}

function tcRmIn(tcIdx,inIdx){
  const q=questions[curIdx];if(!q?.testCases?.[tcIdx])return;
  q.testCases[tcIdx].inputs.splice(inIdx,1);
  renderTestCases(q.testCases);
  q.testCases[tcIdx]._open=true;
  document.getElementById(`tci-${tcIdx}`)?.classList.add('open');
}

function tcUpIn(tcIdx,inIdx,val){
  const q=questions[curIdx];if(!q?.testCases?.[tcIdx])return;
  q.testCases[tcIdx].inputs[inIdx]=val;
}

function tcUpExp(tcIdx,val){
  const q=questions[curIdx];if(!q?.testCases?.[tcIdx])return;
  q.testCases[tcIdx].expected=val;
  const prev=document.querySelector(`#tci-${tcIdx} .tc-preview`);
  if(prev){
    const inP=(q.testCases[tcIdx].inputs||[]).length?`in:[${q.testCases[tcIdx].inputs.join(', ')}]`:'no input';
    const exP=val?`‚Üí "${val.replace(/\n/g,'‚Üµ').substring(0,24)}"`:' ‚Äî ';
    prev.textContent=`${inP} ${exP}`;
  }
}

async function runSingleTc(tcIdx){
  if(!pyReady) return;
  const q=questions[curIdx];if(!q?.testCases?.[tcIdx])return;
  const tc=q.testCases[tcIdx];
  const code=monacoPreviewEditor?monacoPreviewEditor.getValue():'';
  const outEl=document.getElementById(`tc-out-${tcIdx}`);
  const statEl=document.getElementById(`tc-stat-${tcIdx}`);
  if(outEl) outEl.textContent='‚è≥...';
  try{
    const out=await pyRun(code,tc.inputs||[]);
    const norm=s=>s.split('\n').map(l=>l.trimEnd()).join('\n').trim();
    const pass=norm(out)===norm(tc.expected||'');
    tc._status=pass?'pass':'fail';
    if(statEl) statEl.textContent=pass?'‚úÖ':'‚ùå';
    if(outEl){outEl.textContent=out.replace(/\n/g,'‚Üµ')||'(‡∏ß‡πà‡∏≤‡∏á)';outEl.style.color=pass?'var(--acc)':'var(--acc3)'}
    updateTcSummary(q.testCases);
  }catch(e){
    if(outEl){outEl.textContent='‚ùå '+e.message;outEl.style.color='var(--acc3)'}
    tc._status='fail';if(statEl)statEl.textContent='‚ùå';
    updateTcSummary(q.testCases);
  }
}

async function runAllTestCases(){
  if(!pyReady) return;
  const q=questions[curIdx];if(!q?.testCases?.length)return;
  const btn=document.getElementById('tcRunAllBtn');
  btn.disabled=true; btn.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô...';
  const code=monacoPreviewEditor?monacoPreviewEditor.getValue():'';
  const norm=s=>s.split('\n').map(l=>l.trimEnd()).join('\n').trim();
  for(let i=0;i<q.testCases.length;i++){
    const tc=q.testCases[i];
    const outEl=document.getElementById(`tc-out-${i}`);
    const statEl=document.getElementById(`tc-stat-${i}`);
    if(outEl) outEl.textContent='‚è≥...';
    try{
      const out=await pyRun(code,tc.inputs||[]);
      const pass=norm(out)===norm(tc.expected||'');
      tc._status=pass?'pass':'fail';
      if(statEl) statEl.textContent=pass?'‚úÖ':'‚ùå';
      if(outEl){outEl.textContent=out.replace(/\n/g,'‚Üµ')||'(‡∏ß‡πà‡∏≤‡∏á)';outEl.style.color=pass?'var(--acc)':'var(--acc3)'}
    }catch(e){
      tc._status='fail';
      if(statEl) statEl.textContent='‚ùå';
      if(outEl){outEl.textContent='‚ùå '+e.message;outEl.style.color='var(--acc3)'}
    }
  }
  updateTcSummary(q.testCases);
  btn.disabled=false; btn.textContent='‚ñ∂ ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å TC';
  const passed=q.testCases.filter(t=>t._status==='pass').length;
  toast(passed===q.testCases.length?`‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å ${passed} test case!`:`‚ö†Ô∏è ‡∏ú‡πà‡∏≤‡∏ô ${passed}/${q.testCases.length}`,passed===q.testCases.length?'ok':'err');
}

function updateTcSummary(tcs){
  const el=document.getElementById('tcSummary');if(!el)return;
  const passed=tcs.filter(t=>t._status==='pass').length;
  const ran=tcs.filter(t=>t._status).length;
  if(!ran){el.textContent='';return}
  el.textContent=`${passed}/${ran} ‡∏ú‡πà‡∏≤‡∏ô`;
  el.style.color=passed===tcs.length?'var(--acc)':passed>0?'var(--acc4)':'var(--acc3)';
}

function collectTestCases(){
  const q=questions[curIdx];if(!q||!q.testCases)return[];
  return q.testCases.map(tc=>({inputs:[...(tc.inputs||[])],expected:tc.expected||''}));
}

/* ‚ïê‚ïê‚ïê NEW / SAVE / DELETE ‚ïê‚ïê‚ïê */
function newQ(){
  const mx=questions.length?Math.max(...questions.map(q=>q.id||0)):0;
  questions.push({
    id:mx+1,chapter:null,title:`‡∏Ç‡πâ‡∏≠ ${mx+1} ‚Äî `,badge:'print',badgeClass:'badge-print',
    desc:'',hint:'',starterCode:'# ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà\n',expected:'',inputs:[],type:'print',testCases:[]
  });
  selectQ(questions.length-1);
}

function saveQ(){
  if(curIdx<0) return;
  const q=questions[curIdx];
  q.id=parseInt(document.getElementById('f-id').value)||q.id;
  q.chapter=document.getElementById('f-chapter').value.trim()||null;
  q.title=document.getElementById('f-title').value.trim();
  q.badge=document.getElementById('f-badge').value.trim();
  q.badgeClass=document.getElementById('f-badgeClass').value;
  q.type=document.getElementById('f-type').value;
  q.desc=document.getElementById('f-desc').value.trim();
  q.hint=document.getElementById('f-hint').value.trim();
  q.starterCode=document.getElementById('f-starter').value;
  q.expected=document.getElementById('f-expected').value.trim();
  q.inputs=getInputs();
  q.testCases=collectTestCases();
  document.getElementById('expLbl').textContent='expected: '+(q.expected?q.expected.replace(/\n/g,'‚Üµ'):'‚Äî');
  renderSb(); toast('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','ok');
}

function delQ(){if(curIdx>=0) delAt(curIdx)}
function delAt(i){
  if(!confirm(`‡∏•‡∏ö "${questions[i].title}" ?`)) return;
  questions.splice(i,1);
  if(curIdx>=questions.length) curIdx=questions.length-1;
  if(!questions.length){
    curIdx=-1;
    document.getElementById('emptyMain').style.display='flex';
    document.getElementById('editorMain').style.display='none';
    renderSb();
  }else{
    selectQ(Math.max(0,curIdx));
  }
  toast('üóë ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß','err');
}

/* ‚ïê‚ïê‚ïê EXPORT / IMPORT ‚ïê‚ïê‚ïê */
function showExport(){
  if(curIdx>=0) saveQ();
  document.getElementById('expPre').textContent=JSON.stringify(questions,null,2);
  document.getElementById('expModal').style.display='flex';
}
function closeExport(){document.getElementById('expModal').style.display='none'}
function copyExport(){navigator.clipboard.writeText(document.getElementById('expPre').textContent).then(()=>toast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß','ok'))}
function dlExport(){
  const blob=new Blob([document.getElementById('expPre').textContent],{type:'application/json'});
  Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'quiz_questions.json'}).click();
  toast('‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß','ok');
}
function importJSON(){document.getElementById('importFile').click()}
function handleImport(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      if(!Array.isArray(d)) throw new Error('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô array');
      if(questions.length&&!confirm(`‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå ${questions.length} ‡∏Ç‡πâ‡∏≠?`)) return;
      questions=d; curIdx=-1;
      document.getElementById('emptyMain').style.display='flex';
      document.getElementById('editorMain').style.display='none';
      renderSb(); if(questions.length) selectQ(0);
      toast(`‚úÖ Import ${d.length} ‡∏Ç‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,'ok');
    }catch(err){toast('‚ùå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: '+err.message,'err')}
    e.target.value='';
  };
  r.readAsText(f);
}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
function toast(msg,type='ok'){
  const w=document.getElementById('toastW');
  const t=document.createElement('div');
  t.className='toast '+type; t.textContent=msg; w.appendChild(t);
  setTimeout(()=>{t.style.transition='opacity .22s';t.style.opacity='0';setTimeout(()=>t.remove(),240)},2600);
}

/* ‚ïê‚ïê‚ïê UTIL ‚ïê‚ïê‚ïê */
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

/* ‚ïê‚ïê‚ïê KEYBOARD SHORTCUTS ‚ïê‚ïê‚ïê */
document.addEventListener('keydown',e=>{
  const mod=e.ctrlKey||e.metaKey;
  if(mod&&e.key==='s'){e.preventDefault();saveQ()}
  if(mod&&e.key==='Enter'){
    e.preventDefault();
    if(activeTab==='preview') runAndShow();
    else runRaw();
  }
  if(mod&&e.key==='b'){e.preventDefault();toggleSb()}
  if(e.key==='Escape'&&isFullscreen) toggleFullscreen();
});
</script>
</body>
</html>
